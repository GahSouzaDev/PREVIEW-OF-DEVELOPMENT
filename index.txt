index: <!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PraiaVendas | Gestão Inteligente para Vendedores</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            --primary: #FF9800;
            --primary-light: #FFB74D;
            --secondary: #2196F3;
            --success: #4CAF50;
            --success-light: #A5D6A7;
            --danger: #F44336;
            --warning: #FFC107;
            --info: #29B6F6;
            --dark: #333333;
            --light: #FFFFFF;
            --gray: #757575;
            --gray-light: #F5F5F5;
            --gray-dark: #424242;
            --beach-blue: #4FC3F7;
            --beach-sand: #FFECB3;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --border-radius: 16px;
        }

        [data-theme="dark"] {
            --primary: #FFB74D;
            --primary-light: #FFCC80;
            --secondary: #64B5F6;
            --success: #81C784;
            --success-light: #388E3C;
            --danger: #E57373;
            --warning: #FFD54F;
            --info: #4FC3F7;
            --dark: #F5F5F5;
            --light: #121212;
            --gray: #BDBDBD;
            --gray-light: #1E1E1E;
            --gray-dark: #BDBDBD;
            --beach-blue: #29B6F6;
            --beach-sand: #FFD54F;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #E3F2FD 0%, #FFF3E0 100%);
            color: var(--dark);
            min-height: 100vh;
            line-height: 1.6;
            transition: var(--transition);
            overflow-x: hidden;
        }

        [data-theme="dark"] body {
            background: linear-gradient(135deg, #0D1B2A 0%, #1B263B 100%);
            color: var(--dark);
        }

        /* CORREÇÃO PARA MODO ESCURO - CAMPOS DE FORMULÁRIO */
        input, select, textarea {
            background-color: var(--light) !important;
            color: var(--dark) !important;
            border: 2px solid #E0E0E0 !important;
        }

        [data-theme="dark"] input,
        [data-theme="dark"] select,
        [data-theme="dark"] textarea {
            background-color: var(--gray-light) !important;
            color: var(--dark) !important;
            border-color: #444 !important;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary) !important;
            outline: none !important;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), 
                        url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-position: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 2000;
        }

        .login-box {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: fadeInUp 0.6s ease;
        }

        [data-theme="dark"] .login-box {
            background: #1E1E1E;
        }

        .business-logo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid var(--primary);
            margin: 0 auto 1.5rem;
            display: block;
        }

        .business-name {
            text-align: center;
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 2rem;
            font-weight: 700;
        }

        .login-input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 1rem;
            border: 2px solid #E0E0E0;
            border-radius: 10px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .login-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 0.5rem;
        }

        .login-btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
        }

        .login-error {
            color: var(--danger);
            text-align: center;
            margin-top: 1rem;
            display: none;
        }

        /* Header */
        header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 1rem 1rem 0.5rem;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .business-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .business-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
        }

        .business-info h1 {
            font-size: 1.3rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .business-info span {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            color: white;
            font-size: 1.2rem;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .tabs-container {
            width: 100%;
            overflow-x: auto;
            padding-bottom: 5px;
            scrollbar-width: thin;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50px;
            padding: 3px;
            min-width: max-content;
        }

        .tab {
            flex: 1;
            min-width: 80px;
            text-align: center;
            padding: 8px 5px;
            border-radius: 50px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            font-size: 0.85rem;
        }

        .tab.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        /* Main container */
        .container {
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .section {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard */
        .dashboard-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 1.5rem;
        }

        .summary-card {
            background: white;
            border-radius: 16px;
            padding: 1.2rem;
            box-shadow: var(--card-shadow);
            text-align: center;
            border-top: 5px solid var(--primary);
            transition: var(--transition);
        }

        [data-theme="dark"] .summary-card {
            background: #1E1E1E;
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .summary-icon {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .summary-value {
            font-size: 1.8rem;
            font-weight: 800;
            margin: 0.5rem 0;
            font-family: 'Courier New', monospace;
        }

        .summary-label {
            font-size: 0.9rem;
            color: var(--gray);
        }

        /* NOVO: Sistema de Meta Diária */
        .daily-goal-section {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            color: white;
            box-shadow: var(--card-shadow);
        }

        .daily-goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .daily-goal-header h2 {
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .daily-goal-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .goal-progress-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1.2rem;
            text-align: center;
        }

        .goal-progress-title {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }

        .goal-progress-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .goal-progress-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            margin: 1rem 0;
            overflow: hidden;
        }

        .goal-progress-fill {
            height: 100%;
            background: white;
            border-radius: 6px;
            transition: width 1s ease;
        }

        .goal-recommendation {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .goal-recommendation i {
            color: var(--warning);
            margin-right: 8px;
        }

        .goal-setter {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 1rem;
        }

        .goal-setter input {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1rem;
        }

        .goal-setter input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .goal-setter button {
            background: white;
            color: var(--primary);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .goal-setter button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        /* Controle de Produtos para Meta */
        .product-control-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--card-shadow);
        }

        [data-theme="dark"] .product-control-section {
            background: #1E1E1E;
        }

        .product-control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .product-control-card {
            border: 1px solid #E0E0E0;
            border-radius: 12px;
            padding: 1rem;
            transition: var(--transition);
        }

        [data-theme="dark"] .product-control-card {
            border-color: #444;
        }

        .product-control-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
        }

        .product-control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .product-control-name {
            font-weight: 600;
            color: var(--dark);
        }

        .product-control-profit {
            color: var(--success);
            font-weight: 700;
            font-size: 1.1rem;
        }

        .product-control-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--gray);
            margin: 0.5rem 0;
        }

        .product-control-actions {
            display: flex;
            gap: 8px;
            margin-top: 0.8rem;
        }

        .product-control-actions button {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* Filtros */
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border-radius: 20px;
            background: rgb(166, 166, 166);
            border: 2px solid #777777;
            color: var(--dark);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Cards */
        .sale-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 1.5rem;
            border-left: 5px solid var(--success);
        }

        [data-theme="dark"] .sale-card {
            background: #1E1E1E;
        }

        .sale-form {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.4rem;
            font-weight: 500;
            color: var(--dark);
            font-size: 0.9rem;
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 10px rgba(255, 152, 0, 0.3);
        }

        button:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(33, 150, 243, 0.3);
        }

        button.secondary {
            background: var(--secondary);
        }

        button.danger {
            background: var(--danger);
        }

        button.success {
            background: var(--success);
        }

        button.info {
            background: var(--info);
        }

        /* NOVO: Sistema de Múltiplos Produtos na Venda */
        .sale-products-container {
            margin-bottom: 1.5rem;
        }

        .sale-products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .sale-products-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #E0E0E0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .sale-product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #E0E0E0;
            transition: var(--transition);
        }

        .sale-product-item:last-child {
            border-bottom: none;
        }

        .sale-product-item:hover {
            background: var(--gray-light);
        }

        .sale-product-info {
            flex: 1;
        }

        .sale-product-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .sale-product-details {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .sale-product-total {
            font-weight: 700;
            color: var(--success);
            margin-right: 1rem;
        }

        .remove-product-btn {
            background: var(--danger);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .remove-product-btn:hover {
            background: #D32F2F;
            transform: scale(1.1);
        }

        .sale-total-summary {
            background: var(--success-light);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            border: 1px solid var(--success);
        }

        .sale-total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .sale-total-label {
            font-weight: 600;
        }

        .sale-total-value {
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .sale-total-final {
            border-top: 2px dashed var(--success);
            padding-top: 0.75rem;
            margin-top: 0.75rem;
            font-size: 1.2rem;
            color: var(--success);
        }

        /* PAGAMENTO MISTO */
        .mixed-payment-section {
            margin-top: 1.5rem;
            border-top: 2px dashed #E0E0E0;
            padding-top: 1.5rem;
        }

        .mixed-payment-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .mixed-payment-title h3 {
            color: var(--primary);
            font-size: 1.1rem;
        }

        .mixed-payment-item {
            background: var(--gray-light);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #E0E0E0;
            transition: var(--transition);
        }

        [data-theme="dark"] .mixed-payment-item {
            background: #2A2A2A;
            border-color: #444;
        }

        .mixed-payment-item:hover {
            border-color: var(--primary);
        }

        .mixed-payment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .mixed-payment-method {
            font-weight: 600;
            color: var(--dark);
        }

        .mixed-payment-select {
            width: 150px;
            padding: 8px;
            font-size: 0.9rem;
            border-radius: 5px;
            border: 1px solid #E0E0E0;
        }

        .mixed-payment-amount {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 0.5rem;
        }

        .mixed-payment-amount input {
            width: 120px;
            padding: 8px;
            font-size: 0.95rem;
        }

        .mixed-payment-total {
            background: var(--success);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            margin-top: 1rem;
            text-align: center;
        }

        .mixed-payment-total span {
            font-size: 1.2rem;
        }

        .remove-payment-btn {
            background: var(--danger);
            padding: 5px 10px;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.8rem;
            border: none;
        }

        .remove-payment-btn:hover {
            background: #D32F2F;
        }

        .add-payment-btn {
            background: var(--secondary);
            width: 100%;
            padding: 10px;
            margin-top: 0.5rem;
        }

        .remaining-amount {
            margin-top: 0.5rem;
            padding: 8px;
            border-radius: 5px;
            font-size: 0.9rem;
            text-align: center;
        }

        .remaining-positive {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .remaining-negative {
            background: rgba(244, 67, 54, 0.1);
            color: var(--danger);
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .remaining-zero {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning);
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        /* Animações */
        .sale-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
        }

        .sale-animation.show {
            animation: salePop 1s ease forwards;
        }

        @keyframes salePop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }

        /* Produtos */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .product-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            border: 1px solid #E0E0E0;
        }

        [data-theme="dark"] .product-card {
            background: #1E1E1E;
            border-color: #444;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .product-image {
            height: 150px;
            background: linear-gradient(to right, var(--primary-light), var(--primary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
        }

        .product-info {
            padding: 1rem;
        }

        .product-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .product-price {
            color: var(--success);
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .product-stock {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 1rem;
        }

        .stock-low {
            color: var(--danger);
            font-weight: 600;
        }

        /* Financeiro */
        .chart-container {
            height: 300px;
            margin: 1.5rem 0;
            position: relative;
        }

        .transaction-list {
            margin-top: 1.5rem;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #E0E0E0;
            transition: var(--transition);
        }

        [data-theme="dark"] .transaction-item {
            border-color: #444;
        }

        .transaction-item:hover {
            background: #F5F5F5;
        }

        [data-theme="dark"] .transaction-item:hover {
            background: #2A2A2A;
        }

        .transaction-type {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .transaction-income {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success);
        }

        .transaction-expense {
            background: rgba(244, 67, 54, 0.1);
            color: var(--danger);
        }

        /* Configurações */
        .settings-section {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 1.5rem;
        }

        [data-theme="dark"] .settings-section {
            background: #1E1E1E;
        }

        .settings-group {
            margin-bottom: 1.5rem;
        }

        .settings-title {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: var(--transition);
        }

        .color-option.selected {
            border-color: white;
            box-shadow: 0 0 0 3px var(--dark);
            transform: scale(1.1);
        }

        .photo-upload {
            text-align: center;
            padding: 2rem;
            border: 2px dashed #E0E0E0;
            border-radius: 16px;
            cursor: pointer;
            transition: var(--transition);
        }

        .photo-upload:hover {
            border-color: var(--primary);
            background: #F5F5F5;
        }

        .user-photo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 1rem;
            border: 3px solid var(--primary);
        }

        /* Notificações */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            color: var(--success);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            transform: translateX(200%);
            transition: transform 0.3s ease;
            max-width: 300px;
        }

        [data-theme="dark"] .notification {
            background: #1E1E1E;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-danger {
            color: var(--danger);
        }

        .notification-warning {
            color: var(--warning);
        }

        .notification-info {
            color: var(--secondary);
        }

        /* Modais */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        [data-theme="dark"] .modal-content {
            background: #1E1E1E;
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        .modal-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--primary);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 1.5rem;
            justify-content: flex-end;
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .container {
                padding: 0.8rem;
            }
            
            .dashboard-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
            
            .business-info h1 {
                font-size: 1.1rem;
            }
            
            .tab {
                min-width: 70px;
                font-size: 0.8rem;
                padding: 6px 4px;
            }
            
            .header-btn {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }
            
            .mixed-payment-amount {
                flex-direction: column;
                gap: 5px;
            }
            
            .mixed-payment-amount input {
                width: 100%;
            }
            
            .mixed-payment-select {
                width: 100%;
            }
            
            .daily-goal-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .dashboard-summary {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .filter-btn {
                width: 100%;
            }
            
            .business-header {
                flex-direction: column;
                text-align: center;
                gap: 8px;
            }
            
            .product-control-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Animações de números */
        .counting-up {
            animation: countUp 1s ease-out;
        }

        @keyframes countUp {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 54px;
            height: 30px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        /* Data Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        .data-table th {
            background: var(--primary);
            color: white;
            padding: 12px;
            text-align: left;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #E0E0E0;
        }

        .data-table tr:hover {
            background: #F5F5F5;
        }

        [data-theme="dark"] .data-table tr:hover {
            background: #2A2A2A;
        }
        
        .btn-small {
            padding: 5px 10px !important;
            font-size: 0.8rem !important;
            margin: 0 2px;
        }
        
        .btn-danger {
            background: var(--danger) !important;
        }
        
        .btn-warning {
            background: var(--warning) !important;
            color: #000 !important;
        }
        
        .actions-cell {
            white-space: nowrap;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .editable-change-fund {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .editable-change-fund input {
            flex: 1;
        }

        /* NOVA ABA: METAS */
        .goal-tracking-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--card-shadow);
        }

        [data-theme="dark"] .goal-tracking-section {
            background: #1E1E1E;
        }

        .goal-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .goal-metric-card {
            background: var(--gray-light);
            border-radius: 12px;
            padding: 1.2rem;
            text-align: center;
            border-left: 4px solid var(--primary);
        }

        [data-theme="dark"] .goal-metric-card {
            background: #2A2A2A;
        }

        .goal-metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0.5rem 0;
        }

        .goal-metric-label {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .goal-history {
            margin-top: 2rem;
        }

        .goal-day-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #E0E0E0;
            transition: var(--transition);
        }

        [data-theme="dark"] .goal-day-card {
            border-color: #444;
        }

        .goal-day-card:hover {
            background: var(--gray-light);
        }

        .goal-day-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .goal-achieved {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success);
        }

        .goal-partial {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning);
        }

        .goal-not-achieved {
            background: rgba(244, 67, 54, 0.1);
            color: var(--danger);
        }

        /* Indicador de progresso circular */
        .circular-progress {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }

        .circular-progress svg {
            width: 100%;
            height: 100%;
        }

        .circular-progress-circle {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .circular-progress-bg {
            stroke: rgba(255, 255, 255, 0.2);
        }

        .circular-progress-fill {
            stroke: white;
            transition: stroke-dashoffset 1s ease;
        }

        .circular-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
        }

        /* Melhorias visuais para tabelas */
        .table-responsive {
            overflow-x: auto;
        }

        .table-header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            border-radius: 10px 10px 0 0;
            font-weight: 600;
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: var(--dark);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            font-weight: normal;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge-success {
            background: var(--success-light);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(255, 193, 7, 0.2);
            color: var(--warning);
        }

        .badge-danger {
            background: rgba(244, 67, 54, 0.2);
            color: var(--danger);
        }

        .badge-info {
            background: rgba(33, 150, 243, 0.2);
            color: var(--secondary);
        }

        /* Estilo para botões de ação em produtos */
        .product-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .product-actions button {
            flex: 1;
            padding: 8px 12px !important;
            font-size: 0.9rem !important;
        }

        /* Modal de confirmação de exclusão */
        .delete-confirm-modal .modal-content {
            max-width: 400px;
        }

        .delete-warning {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        /* Novo: Gráfico de Pizza para Lucro */
        .profit-pie-chart-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin: 1.5rem 0;
            box-shadow: var(--card-shadow);
        }
        
        [data-theme="dark"] .profit-pie-chart-container {
            background: #1E1E1E;
        }
        
        .profit-chart-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            .profit-chart-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .profit-breakdown {
            display: grid;
            gap: 0.75rem;
        }
        
        .profit-breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--gray-light);
            border-radius: 8px;
            transition: var(--transition);
        }
        
        .profit-breakdown-item:hover {
            background: var(--primary-light);
        }
        
        .profit-breakdown-label {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .profit-color-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <img id="businessLogo" class="business-logo" src="" alt="Logo do Negócio">
            <h1 id="businessNameLogin" class="business-name">PraiaVendas</h1>
            <input type="text" id="usernameInput" class="login-input" placeholder="Usuário" autocomplete="username">
            <input type="password" id="passwordInput" class="login-input" placeholder="Senha" autocomplete="current-password">
            <button id="loginBtn" class="login-btn">
                <i class="fas fa-sign-in-alt"></i> Entrar
            </button>
            <div id="loginError" class="login-error">
                <i class="fas fa-exclamation-circle"></i> Usuário ou senha incorretos
            </div>
        </div>
    </div>

    <!-- Aplicativo Principal (oculto inicialmente) -->
    <div id="mainApp" style="display: none;">
        <header>
            <div class="header-content">
                <div class="business-header">
                    <img id="businessAvatar" class="business-avatar" src="" alt="Avatar">
                    <div class="business-info">
                        <h1 id="businessNameHeader">PraiaVendas</h1>
                        <span id="businessSlogan">Vendas na Praia</span>
                    </div>
                </div>
                
                <div class="header-actions">
                    <button class="header-btn" id="notificationToggle">
                        <i class="fas fa-bell"></i>
                    </button>
                    <button class="header-btn" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="header-btn" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
                
                <div class="tabs-container">
                    <div class="tabs">
                        <div class="tab active" data-tab="dashboard">
                            <i class="fas fa-home"></i> Início
                        </div>
                        <div class="tab" data-tab="goals">
                            <i class="fas fa-bullseye"></i> Metas
                        </div>
                        <div class="tab" data-tab="sales">
                            <i class="fas fa-shopping-cart"></i> Vendas
                        </div>
                        <div class="tab" data-tab="payment-methods">
                            <i class="fas fa-credit-card"></i> Pagamentos
                        </div>
                        <div class="tab" data-tab="costs">
                            <i class="fas fa-money-bill-wave"></i> Custos
                        </div>
                        <div class="tab" data-tab="products">
                            <i class="fas fa-box"></i> Produtos
                        </div>
                        <div class="tab" data-tab="finance">
                            <i class="fas fa-chart-line"></i> Financeiro
                        </div>
                        <div class="tab" data-tab="settings">
                            <i class="fas fa-cog"></i> Configurações
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="container">
            <!-- Dashboard -->
            <section id="dashboard" class="section active">
                <div class="filters">
                    <button class="filter-btn active" data-filter="today">Hoje</button>
                    <button class="filter-btn" data-filter="week">Esta Semana</button>
                    <button class="filter-btn" data-filter="month">Este Mês</button>
                    <button class="filter-btn" data-filter="all">Todo Período</button>
                </div>
                
                <!-- NOVA SEÇÃO: Meta Diária -->
                <div class="daily-goal-section" id="dailyGoalSection">
                    <div class="daily-goal-header">
                        <h2><i class="fas fa-bullseye"></i> Meta de Lucro Diário</h2>
                        <button onclick="showGoalModal()" class="secondary">
                            <i class="fas fa-cog"></i> Configurar Meta
                        </button>
                    </div>
                    
                    <div class="daily-goal-content">
                        <div class="goal-progress-card">
                            <div class="goal-progress-title">Lucro Hoje</div>
                            <div class="goal-progress-value" id="todayProfitValue">R$ 0,00</div>
                            <div class="goal-progress-bar">
                                <div class="goal-progress-fill" id="todayProgressFill" style="width: 0%"></div>
                            </div>
                            <div class="goal-progress-title">
                                <span id="todayProgressText">0% da meta</span>
                                <span class="tooltip">
                                    <i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text">Percentual da sua meta diária já atingido</span>
                                </span>
                            </div>
                        </div>
                        
                        <div class="goal-progress-card">
                            <div class="goal-progress-title">Meta Diária</div>
                            <div class="goal-progress-value" id="dailyGoalValue">R$ 0,00</div>
                            <div class="circular-progress">
                                <svg viewBox="0 0 36 36">
                                    <path class="circular-progress-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                    <path class="circular-progress-fill" id="circularProgress" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                                          stroke-dasharray="100, 100" />
                                </svg>
                                <div class="circular-progress-text" id="circularProgressText">0%</div>
                            </div>
                        </div>
                        
                        <div class="goal-progress-card">
                            <div class="goal-progress-title">Falta para Meta</div>
                            <div class="goal-progress-value" id="remainingGoalValue">R$ 0,00</div>
                            <div class="goal-progress-title">Produto mais lucrativo:</div>
                            <div class="goal-progress-value" id="bestProductProfit">R$ 0,00</div>
                            <div class="goal-progress-title">
                                <span id="unitsNeededText">0 unidades</span>
                                <span class="tooltip">
                                    <i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text">Quantas unidades do produto mais lucrativo faltam para bater a meta</span>
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="goal-recommendation" id="goalRecommendation">
                        <i class="fas fa-lightbulb"></i>
                        <span id="recommendationText">Defina sua meta diária para começar a acompanhar seu progresso!</span>
                    </div>
                </div>
                
                <div class="dashboard-summary">
                    <div class="summary-card">
                        <div class="summary-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="summary-value" id="totalSalesValue">R$ 0,00</div>
                        <div class="summary-label">Vendas Totais</div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="summary-icon">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <div class="summary-value" id="totalProductsSold">0</div>
                        <div class="summary-label">Produtos Vendidos</div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="summary-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="summary-value" id="grossRevenue">R$ 0,00</div>
                        <div class="summary-label">Faturamento Bruto</div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="summary-icon">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="summary-value" id="netRevenue">R$ 0,00</div>
                        <div class="summary-label">Lucro Líquido</div>
                    </div>
                </div>
                
                <div class="sale-card">
                    <h3><i class="fas fa-chart-pie"></i> Resumo Financeiro Detalhado</h3>
                    <div class="dashboard-summary" style="margin-top: 1rem;">
                        <div class="summary-card">
                            <div class="summary-icon">
                                <i class="fas fa-calculator"></i>
                            </div>
                            <div class="summary-value" id="cmvValue">R$ 0,00</div>
                            <div class="summary-label">CMV/CPV</div>
                        </div>
                        
                        <div class="summary-card">
                            <div class="summary-icon">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div class="summary-value" id="machineFee">R$ 0,00</div>
                            <div class="summary-label">Taxa Maquininha</div>
                        </div>
                        
                        <div class="summary-card">
                            <div class="summary-icon">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <div class="summary-value" id="changeFund">R$ 0,00</div>
                            <div class="summary-label">Fundo de Troco</div>
                            <div class="editable-change-fund">
                                <input type="number" id="changeFundInput" min="0" step="0.01" placeholder="0.00" style="padding: 5px; font-size: 0.9rem;">
                                <button onclick="updateChangeFund()" class="btn-small success" style="padding: 5px 10px;">
                                    <i class="fas fa-save"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="summary-card">
                            <div class="summary-icon">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <div class="summary-value" id="salaryValue">R$ 0,00</div>
                            <div class="summary-label">Salário (Pró-labore)</div>
                        </div>
                    </div>
                </div>
                
                <!-- NOVO: Gráfico de Pizza para Lucro e Despesas -->
                <div class="profit-pie-chart-container">
                    <h3><i class="fas fa-chart-pie"></i> Análise de Lucro e Despesas</h3>
                    <div class="profit-chart-grid">
                        <div class="chart-container">
                            <canvas id="profitPieChart"></canvas>
                        </div>
                        <div class="profit-breakdown" id="profitBreakdown">
                            <!-- Itens serão preenchidos por JavaScript -->
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="salesChart"></canvas>
                </div>
            </section>
            
            <!-- NOVA SEÇÃO: Sistema de Metas -->
            <section id="goals" class="section">
                <div class="goal-tracking-section">
                    <h2><i class="fas fa-bullseye"></i> Sistema de Acompanhamento de Metas</h2>
                    <p style="margin: 1rem 0; color: var(--gray);">
                        <i class="fas fa-user-circle"></i> Sistema pessoal de autoavaliação e planejamento
                    </p>
                    
                    <div class="goal-metrics-grid">
                        <div class="goal-metric-card">
                            <div class="goal-metric-label">Meta Diária Atual</div>
                            <div class="goal-metric-value" id="currentDailyGoal">R$ 0,00</div>
                            <button onclick="showGoalModal()" class="btn-small secondary" style="margin-top: 10px;">
                                <i class="fas fa-edit"></i> Alterar
                            </button>
                        </div>
                        
                        <div class="goal-metric-card">
                            <div class="goal-metric-label">Média dos Últimos 7 Dias</div>
                            <div class="goal-metric-value" id="weeklyAverage">R$ 0,00</div>
                            <div class="goal-metric-label" id="weeklyTrend">
                                <i class="fas fa-minus"></i> Sem variação
                            </div>
                        </div>
                        
                        <div class="goal-metric-card">
                            <div class="goal-metric-label">Dias no Mês</div>
                            <div class="goal-metric-value" id="daysThisMonth">0/30</div>
                            <div class="goal-metric-label">Meta Mensal: <span id="monthlyGoalEstimate">R$ 0,00</span></div>
                        </div>
                        
                        <div class="goal-metric-card">
                            <div class="goal-metric-label">Taxa de Sucesso</div>
                            <div class="goal-metric-value" id="successRate">0%</div>
                            <div class="goal-metric-label">Dias que bateu a meta</div>
                        </div>
                    </div>
                    
                    <div class="goal-setter">
                        <input type="number" id="newDailyGoal" placeholder="Ex: 150.00" step="0.01" min="0">
                        <button onclick="setDailyGoal()" class="success">
                            <i class="fas fa-check"></i> Definir Meta Diária
                        </button>
                    </div>
                    
                    <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--gray);">
                        <i class="fas fa-info-circle"></i> Esta meta é para seu acompanhamento pessoal. Ninguém mais tem acesso a esses dados.
                    </p>
                </div>
                
                <!-- Controle de Produtos para Metas -->
                <div class="product-control-section">
                    <h3><i class="fas fa-box-open"></i> Produtos Cadastrados para Cálculo de Lucro</h3>
                    <p style="margin-bottom: 1rem; color: var(--gray);">
                        Cadastre seus produtos com custo e preço de venda para calcular o lucro líquido por unidade.
                    </p>
                    
                    <div class="product-control-grid" id="productControlGrid">
                        <!-- Produtos serão carregados aqui -->
                    </div>
                    
                    <button onclick="showProductModal()" class="secondary" style="margin-top: 1rem;">
                        <i class="fas fa-plus"></i> Cadastrar Novo Produto
                    </button>
                </div>
                
                <!-- Histórico de Metas -->
                <div class="goal-tracking-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3><i class="fas fa-history"></i> Histórico de Desempenho Diário</h3>
                        <div>
                            <button onclick="exportGoalHistory()" class="btn-small secondary">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                            <button onclick="clearGoalHistory()" class="btn-small danger">
                                <i class="fas fa-trash"></i> Limpar
                            </button>
                        </div>
                    </div>
                    <div id="goalHistoryList" class="goal-history">
                        <!-- Histórico será carregado aqui -->
                    </div>
                </div>
            </section>
            
            <!-- Vendas COM PAGAMENTO MISTO E MÚLTIPLOS PRODUTOS -->
            <section id="sales" class="section">
                <div class="sale-card">
                    <h2><i class="fas fa-cash-register"></i> Nova Venda com Múltiplos Produtos</h2>
                    
                    <!-- Adicionar Produto à Venda -->
                    <div class="sale-form">
                        <div class="form-group">
                            <label for="productSelect">Produto</label>
                            <select id="productSelect">
                                <option value="">Selecione um produto</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="quantityInput">Quantidade</label>
                            <input type="number" id="quantityInput" min="1" value="1">
                        </div>
                        
                        <div class="form-group">
                            <label for="priceInput">Preço Unitário (R$)</label>
                            <input type="number" id="priceInput" min="0.01" step="0.01">
                        </div>
                        
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button id="addProductToSaleBtn" class="success">
                                <i class="fas fa-plus"></i> Adicionar à Venda
                            </button>
                        </div>
                    </div>
                    
                    <!-- Lista de Produtos na Venda -->
                    <div class="sale-products-container">
                        <div class="sale-products-header">
                            <h3><i class="fas fa-list"></i> Produtos na Venda</h3>
                            <span id="productsCount">0 produtos</span>
                        </div>
                        
                        <div class="sale-products-list" id="saleProductsList">
                            <div class="empty-state">
                                <i class="fas fa-shopping-cart"></i>
                                <p>Nenhum produto adicionado à venda</p>
                            </div>
                        </div>
                        
                        <!-- Resumo da Venda -->
                        <div class="sale-total-summary" id="saleTotalSummary" style="display: none;">
                            <div class="sale-total-row">
                                <span class="sale-total-label">Subtotal:</span>
                                <span class="sale-total-value" id="subtotalValue">R$ 0,00</span>
                            </div>
                            <div class="sale-total-row">
                                <span class="sale-total-label">Custo Total:</span>
                                <span class="sale-total-value" id="totalCostValue">R$ 0,00</span>
                            </div>
                            <div class="sale-total-row sale-total-final">
                                <span class="sale-total-label">Lucro Bruto:</span>
                                <span class="sale-total-value" id="grossProfitValue">R$ 0,00</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SEÇÃO DE PAGAMENTO MISTO -->
                    <div class="mixed-payment-section">
                        <div class="mixed-payment-title">
                            <h3><i class="fas fa-money-check-alt"></i> Pagamento Misto</h3>
                            <button id="addMixedPaymentBtn" class="add-payment-btn">
                                <i class="fas fa-plus"></i> Adicionar Forma
                            </button>
                        </div>
                        
                        <div id="mixedPaymentContainer">
                            <!-- Os métodos de pagamento serão adicionados aqui dinamicamente -->
                        </div>
                        
                        <div id="paymentSummary">
                            <div class="mixed-payment-total">
                                Total Pago: R$ <span id="totalPaid">0.00</span>
                            </div>
                            <div id="remainingAmount" class="remaining-amount remaining-zero">
                                Restante: R$ <span id="remainingValue">0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="registerSaleBtn" disabled>
                            <i class="fas fa-check"></i> Registrar Venda
                        </button>
                        <button id="clearSaleBtn" class="secondary">
                            <i class="fas fa-times"></i> Limpar Venda
                        </button>
                        <button onclick="updateGoalDisplay()" class="info">
                            <i class="fas fa-sync-alt"></i> Atualizar Meta
                        </button>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3><i class="fas fa-history"></i> Vendas de Hoje</h3>
                    <div id="recentSalesList">
                        <!-- Vendas recentes serão carregadas aqui -->
                    </div>
                </div>
            </section>
            
            <!-- Formas de Pagamento (gerenciamento) -->
            <section id="payment-methods" class="section">
                <div class="sale-card">
                    <h2><i class="fas fa-credit-card"></i> Formas de Pagamento</h2>
                    <div class="sale-form">
                        <div class="form-group">
                            <label for="paymentMethodName">Nome</label>
                            <input type="text" id="paymentMethodName" placeholder="Ex: Pix, Dinheiro, Cartão...">
                        </div>
                        
                        <div class="form-group">
                            <label for="paymentMethodType">Tipo</label>
                            <select id="paymentMethodType">
                                <option value="pix">Pix</option>
                                <option value="cash">Dinheiro</option>
                                <option value="credit">Cartão Crédito</option>
                                <option value="debit">Cartão Débito</option>
                                <option value="other">Outro</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="paymentMethodFee">Taxa (%)</label>
                            <input type="number" id="paymentMethodFee" min="0" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem;">
                        <button id="savePaymentMethodBtn">
                            <i class="fas fa-plus"></i> Adicionar Forma de Pagamento
                        </button>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3><i class="fas fa-list"></i> Formas de Pagamento Cadastradas</h3>
                    <table class="data-table" id="paymentMethodsTable">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Tipo</th>
                                <th>Taxa</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="paymentMethodsList">
                            <!-- Formas de pagamento serão carregadas aqui -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Custos -->
            <section id="costs" class="section">
                <div class="sale-card">
                    <h2><i class="fas fa-money-bill-wave"></i> Adicionar Custo</h2>
                    <div class="sale-form">
                        <div class="form-group">
                            <label for="costDescription">Descrição</label>
                            <input type="text" id="costDescription" placeholder="Ex: Transporte, Alimentação...">
                        </div>
                        
                        <div class="form-group">
                            <label for="costCategory">Categoria</label>
                            <select id="costCategory">
                                <option value="transport">Transporte</option>
                                <option value="food">Alimentação</option>
                                <option value="machine_fee">Taxa Maquininha</option>
                                <option value="donation">Doação</option>
                                <option value="barter">Escambo</option>
                                <option value="gift">Brinde</option>
                                <option value="water">Água</option>
                                <option value="electricity">Luz</option>
                                <option value="gas">Gás</option>
                                <option value="salary">Salário (Pró-labore)</option>
                                <option value="employee">Funcionário</option>
                                <option value="other">Outros</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="costValue">Valor (R$)</label>
                            <input type="number" id="costValue" min="0" step="0.01" placeholder="0.00">
                        </div>
                        
                        <div class="form-group">
                            <label for="costDate">Data</label>
                            <input type="date" id="costDate">
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem;">
                        <button id="addCostBtn">
                            <i class="fas fa-plus"></i> Adicionar Custo
                        </button>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3><i class="fas fa-calculator"></i> Custo das Mercadorias Vendidas (CMV)</h3>
                    <div class="sale-form">
                        <div class="form-group">
                            <label for="initialStock">Estoque Inicial (R$)</label>
                            <input type="number" id="initialStock" min="0" step="0.01" placeholder="0.00">
                        </div>
                        
                        <div class="form-group">
                            <label for="purchases">Compras (R$)</label>
                            <input type="number" id="purchases" min="0" step="0.01" placeholder="0.00">
                        </div>
                        
                        <div class="form-group">
                            <label for="finalStock">Estoque Final (R$)</label>
                            <input type="number" id="finalStock" min="0" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                    
                    <button id="calculateCMVBtn">
                        <i class="fas fa-calculator"></i> Calcular CMV
                    </button>
                    
                    <div style="margin-top: 1rem; padding: 1rem; background: var(--success); color: white; border-radius: 10px; display: none;" id="cmvResult">
                        <h3>CMV: R$ <span id="cmvResultValue">0.00</span></h3>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3><i class="fas fa-history"></i> Custos Registrados</h3>
                    <table class="data-table" id="costsTable">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Descrição</th>
                                <th>Categoria</th>
                                <th>Valor</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="costsList">
                            <!-- Custos serão carregados aqui -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Produtos -->
            <section id="products" class="section">
                <div class="sale-card">
                    <h2><i class="fas fa-plus-circle"></i> Adicionar Produto</h2>
                    <div class="sale-form">
                        <div class="form-group">
                            <label for="productName">Nome do Produto</label>
                            <input type="text" id="productName" placeholder="Ex: Água de Coco, Sorvete...">
                        </div>
                        
                        <div class="form-group">
                            <label for="productCategory">Categoria</label>
                            <select id="productCategory">
                                <option value="bebidas">Bebidas</option>
                                <option value="comidas">Comidas</option>
                                <option value="sobremesas">Sobremesas</option>
                                <option value="acessorios">Acessórios</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="productPrice">Preço de Venda (R$)</label>
                            <input type="number" id="productPrice" min="0.01" step="0.01" placeholder="0.00">
                        </div>
                        
                        <div class="form-group">
                            <label for="productCost">Custo Unitário (R$)</label>
                            <input type="number" id="productCost" min="0.01" step="0.01" placeholder="0.00">
                        </div>
                        
                        <div class="form-group">
                            <label for="productStock">Estoque Inicial</label>
                            <input type="number" id="productStock" min="1" value="10">
                        </div>
                        
                        <div class="form-group">
                            <label for="productMinStock">Estoque Mínimo</label>
                            <input type="number" id="productMinStock" min="1" value="5">
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem; display: flex; gap: 10px;">
                        <button id="addProductBtn">
                            <i class="fas fa-plus"></i> Adicionar Produto
                        </button>
                        <button id="cancelEditBtn" class="secondary" style="display: none;">
                            <i class="fas fa-times"></i> Cancelar Edição
                        </button>
                    </div>
                </div>
                
                <h3 style="margin: 1.5rem 0 1rem;"><i class="fas fa-boxes"></i> Meus Produtos</h3>
                <div class="products-grid" id="productsList">
                    <!-- Produtos serão carregados aqui -->
                </div>
            </section>
            
            <!-- Financeiro -->
            <section id="finance" class="section">
                <div class="sale-card">
                    <h2><i class="fas fa-chart-pie"></i> Resumo Financeiro</h2>
                    <div class="dashboard-summary" style="margin-top: 1rem;">
                        <div class="summary-card">
                            <div class="summary-icon">
                                <i class="fas fa-money-bill"></i>
                            </div>
                            <div class="summary-value" id="totalRevenue">R$ 0,00</div>
                            <div class="summary-label">Receita Total</div>
                        </div>
                        
                        <div class="summary-card">
                            <div class="summary-icon">
                                <i class="fas fa-sack-dollar"></i>
                            </div>
                            <div class="summary-value" id="profitValue">R$ 0,00</div>
                            <div class="summary-label">Lucro Líquido</div>
                        </div>
                        
                        <div class="summary-card">
                            <div class="summary-icon">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div class="summary-value" id="marginValue">0%</div>
                            <div class="summary-label">Margem Líquida</div>
                        </div>
                    </div>
                </div>
                
                <!-- NOVO: Gráfico de Pizza para Financeiro -->
                <div class="profit-pie-chart-container">
                    <h3><i class="fas fa-chart-pie"></i> Distribuição Financeira</h3>
                    <div class="profit-chart-grid">
                        <div class="chart-container">
                            <canvas id="financePieChart"></canvas>
                        </div>
                        <div class="profit-breakdown" id="financeBreakdown">
                            <!-- Itens serão preenchidos por JavaScript -->
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3><i class="fas fa-download"></i> Exportar Dados</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <button id="exportSalesBtn" class="secondary">
                            <i class="fas fa-file-csv"></i> Exportar Vendas (CSV)
                        </button>
                        <button id="exportProductsBtn" class="secondary">
                            <i class="fas fa-file-excel"></i> Exportar Produtos (Excel)
                        </button>
                        <button id="exportFinanceBtn" class="secondary">
                            <i class="fas fa-file-pdf"></i> Relatório Financeiro (PDF)
                        </button>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3><i class="fas fa-chart-bar"></i> Projeções Futuras</h3>
                    <div class="sale-form">
                        <div class="form-group">
                            <label for="targetRevenue">Meta de Faturamento (R$)</label>
                            <input type="number" id="targetRevenue" min="0" step="0.01" placeholder="1000.00">
                        </div>
                        
                        <div class="form-group">
                            <label for="targetPeriod">Período (dias)</label>
                            <input type="number" id="targetPeriod" min="1" value="30">
                        </div>
                    </div>
                    
                    <button id="calculateProjectionBtn">
                        <i class="fas fa-chart-line"></i> Calcular Projeção
                    </button>
                    
                    <div id="projectionResult" style="margin-top: 1rem; display: none;">
                        <!-- Resultado da projeção será exibido aqui -->
                    </div>
                </div>
            </section>
            
            <!-- Configurações -->
            <section id="settings" class="section">
                <div class="settings-section">
                    <h3 class="settings-title"><i class="fas fa-store"></i> Informações do Negócio</h3>
                    <div class="form-group">
                        <label for="businessNameInput">Nome do Negócio</label>
                        <input type="text" id="businessNameInput" placeholder="Nome do seu negócio">
                    </div>
                    
                    <div class="form-group">
                        <label for="businessSloganInput">Slogan ou Descrição</label>
                        <input type="text" id="businessSloganInput" placeholder="Ex: As melhores águas de coco da praia!">
                    </div>
                    
                    <div class="form-group">
                        <label>Foto do Negócio</label>
                        <div class="photo-upload" id="photoUpload">
                            <img id="businessPhotoPreview" class="user-photo" src="" alt="Foto do Negócio">
                            <p>Clique para alterar a foto</p>
                            <input type="file" id="businessPhotoInput" accept="image/*" style="display: none;">
                        </div>
                    </div>
                    
                    <button id="saveBusinessInfoBtn">
                        <i class="fas fa-save"></i> Salvar Informações
                    </button>
                </div>
                
                <div class="settings-section">
                    <h3 class="settings-title"><i class="fas fa-palette"></i> Personalização</h3>
                    <div class="color-picker">
                        <div class="color-option selected" style="background-color: #FF9800;" data-color="#FF9800"></div>
                        <div class="color-option" style="background-color: #2196F3;" data-color="#2196F3"></div>
                        <div class="color-option" style="background-color: #4CAF50;" data-color="#4CAF50"></div>
                        <div class="color-option" style="background-color: #9C27B0;" data-color="#9C27B0"></div>
                        <div class="color-option" style="background-color: #FF5722;" data-color="#FF5722"></div>
                        <div class="color-option" style="background-color: #00BCD4;" data-color="#00BCD4"></div>
                        <div class="color-option" style="background-color: #FF4081;" data-color="#FF4081"></div>
                        <div class="color-option" style="background-color: #3F51B5;" data-color="#3F51B5"></div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3 class="settings-title"><i class="fas fa-bell"></i> Notificações e Sons</h3>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Sons de Venda</span>
                            <label class="switch">
                                <input type="checkbox" id="saleSoundsToggle" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Notificações de Estoque Baixo</span>
                            <label class="switch">
                                <input type="checkbox" id="stockNotificationsToggle" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Animações</span>
                            <label class="switch">
                                <input type="checkbox" id="animationsToggle" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Notificações de Meta Diária</span>
                            <label class="switch">
                                <input type="checkbox" id="goalNotificationsToggle" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3 class="settings-title"><i class="fas fa-database"></i> Gerenciamento de Dados</h3>
                    <div style="display: grid; gap: 1rem;">
                        <button id="backupDataBtn" class="secondary">
                            <i class="fas fa-save"></i> Fazer Backup
                        </button>
                        <button id="restoreDataBtn" class="secondary">
                            <i class="fas fa-undo"></i> Restaurar Backup
                        </button>
                        <button id="resetDataBtn" class="danger">
                            <i class="fas fa-trash"></i> Limpar Todos os Dados
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Notificações -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText">Operação realizada com sucesso!</span>
    </div>

    <!-- Animação de venda -->
    <div class="sale-animation" id="saleAnimation">
        <i class="fas fa-money-bill-wave"></i>
    </div>

    <!-- Modal de Configuração de Meta -->
    <div class="modal" id="goalModal">
        <div class="modal-content">
            <h3 class="modal-title"><i class="fas fa-bullseye"></i> Configurar Meta Diária</h3>
            <p style="margin-bottom: 1rem;">Defina sua meta pessoal de lucro líquido diário:</p>
            
            <div class="form-group">
                <label for="modalDailyGoal">Meta de Lucro Diário (R$)</label>
                <input type="number" id="modalDailyGoal" min="0" step="0.01" placeholder="Ex: 150.00">
            </div>
            
            <div class="form-group">
                <label for="goalDescription">Descrição (opcional)</label>
                <input type="text" id="goalDescription" placeholder="Ex: Meta para viagem, poupança...">
            </div>
            
            <div class="form-group">
                <label for="goalPeriod">Período da Meta</label>
                <select id="goalPeriod">
                    <option value="daily">Diária</option>
                    <option value="weekly">Semanal</option>
                    <option value="monthly">Mensal</option>
                </select>
            </div>
            
            <div style="background: var(--gray-light); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                <h4><i class="fas fa-lightbulb"></i> Sugestões Baseadas no Histórico</h4>
                <div id="goalSuggestions" style="margin-top: 0.5rem;">
                    <!-- Sugestões serão carregadas aqui -->
                </div>
            </div>
            
            <div class="modal-actions">
                <button onclick="hideGoalModal()" class="secondary">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button onclick="saveDailyGoal()" class="success">
                    <i class="fas fa-check"></i> Salvar Meta
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Cadastro de Produto para Meta -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <h3 class="modal-title"><i class="fas fa-box"></i> Cadastrar Produto para Cálculo de Lucro</h3>
            
            <div class="form-group">
                <label for="modalProductName">Nome do Produto</label>
                <input type="text" id="modalProductName" placeholder="Ex: Água de Coco 500ml">
            </div>
            
            <div class="form-group">
                <label for="modalProductCost">Custo Unitário (R$)</label>
                <input type="number" id="modalProductCost" min="0.01" step="0.01" placeholder="Ex: 2.50">
            </div>
            
            <div class="form-group">
                <label for="modalProductPrice">Preço de Venda (R$)</label>
                <input type="number" id="modalProductPrice" min="0.01" step="0.01" placeholder="Ex: 5.00">
            </div>
            
            <div style="background: var(--success-light); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                <h4><i class="fas fa-calculator"></i> Cálculo Automático</h4>
                <div style="margin-top: 0.5rem;">
                    <div>Lucro por unidade: <strong id="profitPerUnitCalc">R$ 0,00</strong></div>
                    <div>Margem de lucro: <strong id="profitMarginCalc">0%</strong></div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button onclick="hideProductModal()" class="secondary">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button onclick="saveGoalProduct()" class="success">
                    <i class="fas fa-check"></i> Cadastrar Produto
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Exclusão de Produto -->
    <div class="modal delete-confirm-modal" id="deleteProductModal">
        <div class="modal-content">
            <h3 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Confirmar Exclusão</h3>
            <p>Tem certeza que deseja excluir o produto <strong id="deleteProductName"></strong>?</p>
            <div class="delete-warning">
                <i class="fas fa-warning"></i> Esta ação não pode ser desfeita!
            </div>
            <div class="modal-actions">
                <button onclick="hideDeleteProductModal()" class="secondary">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button onclick="confirmDeleteProduct()" class="danger">
                    <i class="fas fa-trash"></i> Excluir Produto
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Cookies -->
    <div class="modal" id="cookieModal">
        <div class="modal-content">
            <h3 class="modal-title">Privacidade e Armazenamento</h3>
            <p>O PraiaVendas armazena todos os dados localmente no seu dispositivo para garantir sua privacidade. Nenhuma informação sai do seu celular. Usamos cookies para melhorar sua experiência e manter você logado.</p>
            <p style="margin-top: 1rem;"><strong>Seus dados ficam salvos por até 12 meses.</strong></p>
            <div class="modal-actions">
                <button id="acceptCookies" class="success">
                    <i class="fas fa-check"></i> Aceitar e Continuar
                </button>
            </div>
        </div>
    </div>

  <script>
    // ============ SISTEMA DE METAS DIÁRIAS ============
    
    // Estrutura de dados para metas
    const GOAL_DATA_KEYS = {
        DAILY_GOAL: 'praiaVendas_dailyGoal',
        GOAL_PRODUCTS: 'praiaVendas_goalProducts',
        GOAL_HISTORY: 'praiaVendas_goalHistory',
        GOAL_SETTINGS: 'praiaVendas_goalSettings',
        GOAL_PERIOD: 'praiaVendas_goalPeriod',
        MONTHLY_GOAL: 'praiaVendas_monthlyGoal',
        WEEKLY_GOAL: 'praiaVendas_weeklyGoal'
    };

    // Estado do sistema de metas
    let goalState = {
        dailyGoal: 0,
        weeklyGoal: 0,
        monthlyGoal: 0,
        goalDescription: '',
        goalProducts: [],
        goalHistory: [],
        goalPeriod: 'daily',
        settings: {
            notifications: true,
            autoCalculate: true,
            showRecommendations: true
        },
        todayProfit: 0,
        todaySales: []
    };

    // ============ SISTEMA DE VENDAS COM MÚLTIPLOS PRODUTOS ============
    
    let currentSale = {
        products: [],
        total: 0,
        cost: 0,
        grossProfit: 0
    };

    let mixedPaymentMethods = [];
    let nextPaymentId = 1;
    let productToDelete = null;
    let autoCalculatePayments = true;

    // ============ CORREÇÃO DO CÁLCULO DE LUCRO ============
    
    // Função para calcular lucro líquido CORRETAMENTE
    function calculateNetProfit() {
        // 1. Receita total (faturamento bruto)
        const totalRevenue = appState.sales.reduce((sum, sale) => sum + sale.total, 0);
        
        // 2. Custo REAL dos produtos vendidos (baseado no custo unitário)
        let totalProductCost = 0;
        appState.sales.forEach(sale => {
            // Se a venda já tem unitCost salvo, usar ele
            if (sale.unitCost && sale.quantity) {
                totalProductCost += sale.unitCost * sale.quantity;
            } else {
                // Se não, buscar o custo do produto
                const product = appState.products.find(p => p.id === sale.productId);
                if (product && product.cost) {
                    totalProductCost += product.cost * sale.quantity;
                }
            }
        });
        
        // 3. Taxas da maquininha
        const machineFees = appState.sales.reduce((sum, sale) => sum + (sale.machineFee || 0), 0);
        
        // 4. Outros custos (excluindo salário/pró-labore)
        const otherCosts = appState.costs.reduce((sum, cost) => {
            if (cost.category !== 'salary') return sum + cost.value;
            return sum;
        }, 0);
        
        // 5. Salário/pró-labore
        const salary = appState.costs.reduce((sum, cost) => {
            if (cost.category === 'salary') return sum + cost.value;
            return sum;
        }, 0);
        
        // Cálculo CORRETO do lucro líquido:
        // Receita Total - Custo dos Produtos - Taxas - Outros Custos - Salário
        const netProfit = totalRevenue - totalProductCost - machineFees - otherCosts - salary;
        
        return {
            totalRevenue,
            totalProductCost,
            machineFees,
            otherCosts,
            salary,
            netProfit
        };
    }
    
    // Função para calcular lucro HOJE
    function calculateTodayProfit() {
        const today = new Date().toISOString().split('T')[0];
        let todayRevenue = 0;
        let todayCost = 0;
        
        // Filtrar vendas de hoje
        const todaySales = appState.sales.filter(sale => {
            const saleDate = new Date(sale.date).toISOString().split('T')[0];
            return saleDate === today;
        });
        
        // Calcular receita e custo de hoje
        todaySales.forEach(sale => {
            todayRevenue += sale.total || 0;
            if (sale.unitCost && sale.quantity) {
                todayCost += sale.unitCost * sale.quantity;
            }
        });
        
        // Subtrair custos de hoje
        const todayOtherCosts = appState.costs.filter(cost => {
            const costDate = new Date(cost.date).toISOString().split('T')[0];
            return costDate === today && cost.category !== 'salary';
        }).reduce((sum, cost) => sum + cost.value, 0);
        
        const todaySalary = appState.costs.filter(cost => {
            const costDate = new Date(cost.date).toISOString().split('T')[0];
            return costDate === today && cost.category === 'salary';
        }).reduce((sum, cost) => sum + cost.value, 0);
        
        const todayMachineFees = todaySales.reduce((sum, sale) => sum + (sale.machineFee || 0), 0);
        
        return todayRevenue - todayCost - todayMachineFees - todayOtherCosts - todaySalary;
    }
    
    // Atualizar dashboard
    function updateDashboard() {
        const filter = appState.settings.currentFilter;
        let filteredSales = appState.sales;
        
        if (filter !== 'all') {
            const now = new Date();
            filteredSales = appState.sales.filter(sale => {
                const saleDate = new Date(sale.date);
                
                switch(filter) {
                    case 'today':
                        return saleDate.toDateString() === now.toDateString();
                    case 'week':
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        return saleDate >= weekAgo;
                    case 'month':
                        return saleDate.getMonth() === now.getMonth() && 
                               saleDate.getFullYear() === now.getFullYear();
                    default:
                        return true;
                }
            });
        }
        
        const totalSales = filteredSales.reduce((sum, sale) => sum + sale.total, 0);
        const totalProducts = filteredSales.reduce((sum, sale) => sum + sale.quantity, 0);
        
        // Calcular lucro do período filtrado
        let filteredProfit = calculateFilteredProfit(filter);
        
        // Atualizar interface
        dom.totalSalesValue.textContent = `R$ ${totalSales.toFixed(2)}`;
        dom.totalProductsSold.textContent = totalProducts.toString();
        dom.grossRevenue.textContent = `R$ ${totalSales.toFixed(2)}`;
        
        // CORREÇÃO IMPORTANTE: Mostrar LUCRO LÍQUIDO correto
        dom.netRevenue.textContent = `R$ ${filteredProfit.toFixed(2)}`;
        
        // Atualizar custos
        const profitData = calculateNetProfit();
        dom.cmvValue.textContent = `R$ ${profitData.totalProductCost.toFixed(2)}`;
        dom.machineFee.textContent = `R$ ${profitData.machineFees.toFixed(2)}`;
        dom.salaryValue.textContent = `R$ ${profitData.salary.toFixed(2)}`;
        
        // Atualizar seção de financeiro
        const margin = profitData.totalRevenue > 0 ? ((profitData.netProfit / profitData.totalRevenue) * 100) : 0;
        
        dom.totalRevenue.textContent = `R$ ${profitData.totalRevenue.toFixed(2)}`;
        dom.profitValue.textContent = `R$ ${profitData.netProfit.toFixed(2)}`;
        dom.marginValue.textContent = `${margin.toFixed(1)}%`;
        
        // Atualizar gráficos
        updateSalesChart(filteredSales);
        updateProfitPieChart();
        updateFinancePieChart();
    }
    
    // Calcular lucro filtrado
    function calculateFilteredProfit(filter) {
        const now = new Date();
        let filteredSales = appState.sales;
        
        if (filter !== 'all') {
            filteredSales = appState.sales.filter(sale => {
                const saleDate = new Date(sale.date);
                
                switch(filter) {
                    case 'today':
                        return saleDate.toDateString() === now.toDateString();
                    case 'week':
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        return saleDate >= weekAgo;
                    case 'month':
                        return saleDate.getMonth() === now.getMonth() && 
                               saleDate.getFullYear() === now.getFullYear();
                    default:
                        return true;
                }
            });
        }
        
        let revenue = 0;
        let cost = 0;
        let machineFees = 0;
        
        filteredSales.forEach(sale => {
            revenue += sale.total || 0;
            if (sale.unitCost && sale.quantity) {
                cost += sale.unitCost * sale.quantity;
            }
            machineFees += sale.machineFee || 0;
        });
        
        // Custos filtrados
        let otherCosts = 0;
        let salary = 0;
        
        appState.costs.forEach(costItem => {
            const costDate = new Date(costItem.date);
            
            if (filter === 'all') {
                if (costItem.category !== 'salary') otherCosts += costItem.value;
                else salary += costItem.value;
            } else {
                let include = false;
                switch(filter) {
                    case 'today':
                        include = costDate.toDateString() === now.toDateString();
                        break;
                    case 'week':
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        include = costDate >= weekAgo;
                        break;
                    case 'month':
                        include = costDate.getMonth() === now.getMonth() && 
                                 costDate.getFullYear() === now.getFullYear();
                        break;
                }
                
                if (include) {
                    if (costItem.category !== 'salary') otherCosts += costItem.value;
                    else salary += costItem.value;
                }
            }
        });
        
        return revenue - cost - machineFees - otherCosts - salary;
    }
    
    // ============ NOVO: GRÁFICO DE PIZZA PARA LUCRO ============
    
    let profitPieChart = null;
    let financePieChart = null;
    
    function setupProfitPieChart() {
        const ctx = document.getElementById('profitPieChart').getContext('2d');
        
        profitPieChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Lucro Líquido', 'Custo Produtos', 'Taxas', 'Outros Custos', 'Salário'],
                datasets: [{
                    data: [0, 0, 0, 0, 0],
                    backgroundColor: [
                        '#4CAF50', // Verde para lucro
                        '#FF9800', // Laranja para custo produtos
                        '#2196F3', // Azul para taxas
                        '#F44336', // Vermelho para outros custos
                        '#9C27B0'  // Roxo para salário
                    ],
                    borderWidth: 2,
                    borderColor: '#FFFFFF'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                return `${label}: R$ ${value.toFixed(2)} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    function setupFinancePieChart() {
        const ctx = document.getElementById('financePieChart').getContext('2d');
        
        financePieChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Faturamento Bruto', 'Custo Produtos', 'Taxas', 'Custos', 'Salário', 'Lucro Líquido'],
                datasets: [{
                    data: [0, 0, 0, 0, 0, 0],
                    backgroundColor: [
                        '#4CAF50', // Verde para faturamento
                        '#FF9800', // Laranja para custo produtos
                        '#2196F3', // Azul para taxas
                        '#F44336', // Vermelho para custos
                        '#9C27B0', // Roxo para salário
                        '#00BCD4'  // Ciano para lucro
                    ],
                    borderWidth: 2,
                    borderColor: '#FFFFFF'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                return `${label}: R$ ${value.toFixed(2)} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    function updateProfitPieChart() {
        if (!profitPieChart) return;
        
        const profitData = calculateNetProfit();
        const total = profitData.totalRevenue;
        
        if (total === 0) {
            profitPieChart.data.datasets[0].data = [0, 0, 0, 0, 0];
            profitPieChart.update();
            updateProfitBreakdown(profitData);
            return;
        }
        
        profitPieChart.data.datasets[0].data = [
            profitData.netProfit,
            profitData.totalProductCost,
            profitData.machineFees,
            profitData.otherCosts,
            profitData.salary
        ];
        
        profitPieChart.update();
        updateProfitBreakdown(profitData);
    }
    
    function updateFinancePieChart() {
        if (!financePieChart) return;
        
        const profitData = calculateNetProfit();
        const totalRevenue = profitData.totalRevenue;
        
        financePieChart.data.datasets[0].data = [
            totalRevenue,
            profitData.totalProductCost,
            profitData.machineFees,
            profitData.otherCosts,
            profitData.salary,
            profitData.netProfit
        ];
        
        financePieChart.update();
        updateFinanceBreakdown(profitData);
    }
    
    function updateProfitBreakdown(profitData) {
        const breakdown = document.getElementById('profitBreakdown');
        const total = profitData.totalRevenue;
        
        if (total === 0) {
            breakdown.innerHTML = `
                <div class="profit-breakdown-item">
                    <div class="profit-breakdown-label">
                        <div class="profit-color-indicator" style="background-color: #4CAF50;"></div>
                        <span>Lucro Líquido</span>
                    </div>
                    <div>R$ 0,00 (0%)</div>
                </div>
                <div class="profit-breakdown-item">
                    <div class="profit-breakdown-label">
                        <div class="profit-color-indicator" style="background-color: #FF9800;"></div>
                        <span>Custo dos Produtos</span>
                    </div>
                    <div>R$ 0,00 (0%)</div>
                </div>
                <div class="profit-breakdown-item">
                    <div class="profit-breakdown-label">
                        <div class="profit-color-indicator" style="background-color: #2196F3;"></div>
                        <span>Taxas da Maquininha</span>
                    </div>
                    <div>R$ 0,00 (0%)</div>
                </div>
                <div class="profit-breakdown-item">
                    <div class="profit-breakdown-label">
                        <div class="profit-color-indicator" style="background-color: #F44336;"></div>
                        <span>Outros Custos</span>
                    </div>
                    <div>R$ 0,00 (0%)</div>
                </div>
                <div class="profit-breakdown-item">
                    <div class="profit-breakdown-label">
                        <div class="profit-color-indicator" style="background-color: #9C27B0;"></div>
                        <span>Salário (Pró-labore)</span>
                    </div>
                    <div>R$ 0,00 (0%)</div>
                </div>
            `;
            return;
        }
        
        const profitPercentage = (profitData.netProfit / total * 100).toFixed(1);
        const costPercentage = (profitData.totalProductCost / total * 100).toFixed(1);
        const feesPercentage = (profitData.machineFees / total * 100).toFixed(1);
        const costsPercentage = (profitData.otherCosts / total * 100).toFixed(1);
        const salaryPercentage = (profitData.salary / total * 100).toFixed(1);
        
        breakdown.innerHTML = `
            <div class="profit-breakdown-item">
                <div class="profit-breakdown-label">
                    <div class="profit-color-indicator" style="background-color: #4CAF50;"></div>
                    <span>Lucro Líquido</span>
                </div>
                <div>R$ ${profitData.netProfit.toFixed(2)} (${profitPercentage}%)</div>
            </div>
            <div class="profit-breakdown-item">
                <div class="profit-breakdown-label">
                    <div class="profit-color-indicator" style="background-color: #FF9800;"></div>
                    <span>Custo dos Produtos</span>
                </div>
                <div>R$ ${profitData.totalProductCost.toFixed(2)} (${costPercentage}%)</div>
            </div>
            <div class="profit-breakdown-item">
                <div class="profit-breakdown-label">
                    <div class="profit-color-indicator" style="background-color: #2196F3;"></div>
                    <span>Taxas da Maquininha</span>
                </div>
                <div>R$ ${profitData.machineFees.toFixed(2)} (${feesPercentage}%)</div>
            </div>
            <div class="profit-breakdown-item">
                <div class="profit-breakdown-label">
                    <div class="profit-color-indicator" style="background-color: #F44336;"></div>
                    <span>Outros Custos</span>
                </div>
                <div>R$ ${profitData.otherCosts.toFixed(2)} (${costsPercentage}%)</div>
            </div>
            <div class="profit-breakdown-item">
                <div class="profit-breakdown-label">
                    <div class="profit-color-indicator" style="background-color: #9C27B0;"></div>
                    <span>Salário (Pró-labore)</span>
                </div>
                <div>R$ ${profitData.salary.toFixed(2)} (${salaryPercentage}%)</div>
            </div>
        `;
    }
    
    function updateFinanceBreakdown(profitData) {
        const breakdown = document.getElementById('financeBreakdown');
        const totalRevenue = profitData.totalRevenue;
        
        if (totalRevenue === 0) {
            breakdown.innerHTML = `
                <div class="profit-breakdown-item">
                    <div class="profit-breakdown-label">
                        <div class="profit-color-indicator" style="background-color: #4CAF50;"></div>
                        <span>Faturamento Bruto</span>
                    </div>
                    <div>R$ 0,00</div>
                </div>
                <div class="profit-breakdown-item">
                    <div class="profit-breakdown-label">
                        <div class="profit-color-indicator" style="background-color: #FF9800;"></div>
                        <span>Custo Produtos</span>
                    </div>
                    <div>R$ 0,00 (0%)</div>
                </div>
                <div class="profit-breakdown-item">
                    <div class="profit-breakdown-label">
                        <div class="profit-color-indicator" style="background-color: #2196F3;"></div>
                        <span>Taxas</span>
                    </div>
                    <div>R$ 0,00 (0%)</div>
                </div>
                <div class="profit-breakdown-item">
                    <div class="profit-breakdown-label">
                        <div class="profit-color-indicator" style="background-color: #F44336;"></div>
                        <span>Custos</span>
                    </div>
                    <div>R$ 0,00 (0%)</div>
                </div>
                <div class="profit-breakdown-item">
                    <div class="profit-breakdown-label">
                        <div class="profit-color-indicator" style="background-color: #9C27B0;"></div>
                        <span>Salário</span>
                    </div>
                    <div>R$ 0,00 (0%)</div>
                </div>
                <div class="profit-breakdown-item">
                    <div class="profit-breakdown-label">
                        <div class="profit-color-indicator" style="background-color: #00BCD4;"></div>
                        <span>Lucro Líquido</span>
                    </div>
                    <div>R$ 0,00 (0%)</div>
                </div>
            `;
            return;
        }
        
        const costPercentage = (profitData.totalProductCost / totalRevenue * 100).toFixed(1);
        const feesPercentage = (profitData.machineFees / totalRevenue * 100).toFixed(1);
        const costsPercentage = (profitData.otherCosts / totalRevenue * 100).toFixed(1);
        const salaryPercentage = (profitData.salary / totalRevenue * 100).toFixed(1);
        const profitPercentage = (profitData.netProfit / totalRevenue * 100).toFixed(1);
        
        breakdown.innerHTML = `
            <div class="profit-breakdown-item">
                <div class="profit-breakdown-label">
                    <div class="profit-color-indicator" style="background-color: #4CAF50;"></div>
                    <span>Faturamento Bruto</span>
                </div>
                <div>R$ ${totalRevenue.toFixed(2)}</div>
            </div>
            <div class="profit-breakdown-item">
                <div class="profit-breakdown-label">
                    <div class="profit-color-indicator" style="background-color: #FF9800;"></div>
                    <span>Custo Produtos</span>
                </div>
                <div>R$ ${profitData.totalProductCost.toFixed(2)} (${costPercentage}%)</div>
            </div>
            <div class="profit-breakdown-item">
                <div class="profit-breakdown-label">
                    <div class="profit-color-indicator" style="background-color: #2196F3;"></div>
                    <span>Taxas</span>
                </div>
                <div>R$ ${profitData.machineFees.toFixed(2)} (${feesPercentage}%)</div>
            </div>
            <div class="profit-breakdown-item">
                <div class="profit-breakdown-label">
                    <div class="profit-color-indicator" style="background-color: #F44336;"></div>
                    <span>Custos</span>
                </div>
                <div>R$ ${profitData.otherCosts.toFixed(2)} (${costsPercentage}%)</div>
            </div>
            <div class="profit-breakdown-item">
                <div class="profit-breakdown-label">
                    <div class="profit-color-indicator" style="background-color: #9C27B0;"></div>
                    <span>Salário</span>
                </div>
                <div>R$ ${profitData.salary.toFixed(2)} (${salaryPercentage}%)</div>
            </div>
            <div class="profit-breakdown-item">
                <div class="profit-breakdown-label">
                    <div class="profit-color-indicator" style="background-color: #00BCD4;"></div>
                    <span>Lucro Líquido</span>
                </div>
                <div>R$ ${profitData.netProfit.toFixed(2)} (${profitPercentage}%)</div>
            </div>
        `;
    }
    
    // ============ CORREÇÃO DO SISTEMA DE LOGIN ============
    
    const LOGIN_SYSTEM_KEYS = {
        LAST_LOGIN_DATE: 'praiaVendas_lastLoginDate',
        LOGIN_REQUIRED: 'praiaVendas_loginRequired'
    };
    
    function checkDailyLogin() {
        const lastLoginDate = localStorage.getItem(LOGIN_SYSTEM_KEYS.LAST_LOGIN_DATE);
        const today = new Date().toDateString();
        
        if (!lastLoginDate || lastLoginDate !== today) {
            localStorage.setItem(LOGIN_SYSTEM_KEYS.LOGIN_REQUIRED, 'true');
            return true;
        }
        
        const loginRequired = localStorage.getItem(LOGIN_SYSTEM_KEYS.LOGIN_REQUIRED);
        return loginRequired === 'true';
    }
    
    function markAsLoggedIn() {
        const today = new Date().toDateString();
        localStorage.setItem(LOGIN_SYSTEM_KEYS.LAST_LOGIN_DATE, today);
        localStorage.setItem(LOGIN_SYSTEM_KEYS.LOGIN_REQUIRED, 'false');
    }
    
    // ============ CARREGAMENTO DE USUÁRIOS DO JSON ============
    
    async function loadUsersFromJSON() {
        try {
            const response = await fetch('usuarios.json');
            if (!response.ok) {
                throw new Error('Arquivo não encontrado, usando usuários padrão');
            }
            
            const data = await response.json();
            
            if (data && data.usuarios && Array.isArray(data.usuarios)) {
                appState.users = data.usuarios.map(user => ({
                    id: user.id,
                    username: user.username,
                    password: user.password,
                    nome: user.nome,
                    role: user.role,
                    ativo: user.ativo !== undefined ? user.ativo : true,
                    bloqueado: user.bloqueado !== undefined ? user.bloqueado : false,
                    data_criacao: user.data_criacao || new Date().toISOString().split('T')[0],
                    ultimo_acesso: user.ultimo_acesso || null,
                    mensagem_acesso: user.mensagem_acesso || "Bem-vindo ao sistema!"
                }));
                
                console.log('Usuários carregados do arquivo JSON:', appState.users.length);
            } else {
                throw new Error('Estrutura do JSON inválida');
            }
        } catch (error) {
            console.warn('Não foi possível carregar usuários do JSON:', error.message);
            
            // Usuários padrão como fallback
            appState.users = [
                {
                    id: 1,
                    username: 'admin',
                    password: 'admin123',
                    nome: 'Administrador',
                    role: 'admin',
                    ativo: true,
                    bloqueado: false,
                    data_criacao: '2024-01-01',
                    mensagem_acesso: 'Bem-vindo ao PraiaVendas!'
                },
                {
                    id: 2,
                    username: 'vendedor',
                    password: 'venda123',
                    nome: 'Vendedor da Praia',
                    role: 'vendedor',
                    ativo: true,
                    bloqueado: false,
                    data_criacao: '2024-01-01',
                    mensagem_acesso: 'Boas vendas na praia!'
                }
            ];
        }
    }
    
    // ============ CORREÇÃO DO HISTÓRICO DE METAS ============
    
    function updateGoalHistory() {
        const historyList = document.getElementById('goalHistoryList');
        historyList.innerHTML = '';
        
        const sortedHistory = [...goalState.goalHistory].sort((a, b) => 
            new Date(b.date) - new Date(a.date)
        );
        
        const recentHistory = sortedHistory.slice(0, 30);
        
        if (recentHistory.length === 0) {
            historyList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-chart-line"></i>
                    <p>Nenhum histórico disponível</p>
                    <p style="font-size: 0.9rem;">Seu histórico será gerado automaticamente conforme você define metas</p>
                </div>
            `;
            return;
        }
        
        recentHistory.forEach(day => {
            const dayDate = new Date(day.date);
            const formattedDate = dayDate.toLocaleDateString('pt-BR', { 
                weekday: 'short',
                day: '2-digit',
                month: 'short'
            });
            
            const goal = day.goal || 0;
            const profit = day.profit || 0;
            
            let progress = 0;
            if (goal > 0) {
                progress = Math.min((profit / goal) * 100, 100);
            }
            
            let status = 'goal-not-achieved';
            let statusText = 'Não atingida';
            let statusIcon = 'times';
            
            if (goal > 0) {
                if (profit >= goal) {
                    status = 'goal-achieved';
                    statusText = 'Meta atingida';
                    statusIcon = 'check';
                } else if (progress >= 50) {
                    status = 'goal-partial';
                    statusText = 'Parcial';
                    statusIcon = 'exclamation';
                } else if (profit > 0) {
                    status = 'goal-not-achieved';
                    statusText = 'Em andamento';
                    statusIcon = 'spinner';
                }
            } else if (profit > 0) {
                status = 'goal-partial';
                statusText = 'Sem meta';
                statusIcon = 'info';
            }
            
            const dayCard = document.createElement('div');
            dayCard.className = 'goal-day-card';
            dayCard.innerHTML = `
                <div>
                    <div style="font-weight: 600;">${formattedDate}</div>
                    <div style="font-size: 0.85rem; color: var(--gray);">
                        <div>Lucro: <strong>R$ ${profit.toFixed(2)}</strong></div>
                        ${goal > 0 ? `<div>Meta: R$ ${goal.toFixed(2)} (${progress.toFixed(1)}%)</div>` : ''}
                    </div>
                </div>
                <div class="goal-day-status ${status}">
                    <i class="fas fa-${statusIcon}"></i> ${statusText}
                </div>
            `;
            
            historyList.appendChild(dayCard);
        });
    }
    
    function exportGoalHistory() {
        if (goalState.goalHistory.length === 0) {
            showNotification("Nenhum histórico para exportar", "warning");
            return;
        }
        
        const csvContent = [
            ['Data', 'Meta (R$)', 'Lucro (R$)', 'Progresso (%)', 'Status'],
            ...goalState.goalHistory.map(day => {
                const goal = day.goal || 0;
                const profit = day.profit || 0;
                const progress = goal > 0 ? (profit / goal * 100) : 0;
                let status = 'Não atingida';
                
                if (goal > 0) {
                    if (profit >= goal) status = 'Meta atingida';
                    else if (progress >= 50) status = 'Parcial';
                    else if (profit > 0) status = 'Em andamento';
                } else if (profit > 0) {
                    status = 'Sem meta definida';
                }
                
                return [
                    new Date(day.date).toLocaleDateString('pt-BR'),
                    goal.toFixed(2),
                    profit.toFixed(2),
                    progress.toFixed(1),
                    status
                ];
            })
        ].map(row => row.join(',')).join('\n');
        
        downloadFile(csvContent, `historico-metas-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
        showNotification("Histórico exportado com sucesso!", "success");
    }
    
    function clearGoalHistory() {
        if (confirm("Tem certeza que deseja limpar todo o histórico de metas? Esta ação não pode ser desfeita.")) {
            goalState.goalHistory = [];
            saveGoalData();
            updateGoalHistory();
            showNotification("Histórico de metas limpo com sucesso!", "success");
        }
    }
    
    // ============ FUNÇÕES DO SISTEMA DE VENDAS ============
    
    function addProductToSale() {
        const productId = parseInt(document.getElementById('productSelect').value);
        const quantity = parseInt(document.getElementById('quantityInput').value) || 1;
        const price = parseFloat(document.getElementById('priceInput').value) || 0;

        if (!productId) {
            showNotification("Selecione um produto", "danger");
            return;
        }

        if (quantity <= 0) {
            showNotification("Quantidade inválida", "danger");
            return;
        }

        if (price <= 0) {
            showNotification("Preço inválido", "danger");
            return;
        }

        const product = appState.products.find(p => p.id === productId);
        if (!product) {
            showNotification("Produto não encontrado", "danger");
            return;
        }

        if (product.stock < quantity) {
            showNotification(`Estoque insuficiente de ${product.name}. Disponível: ${product.stock}`, "danger");
            return;
        }

        // Usar custo REAL do produto
        const unitCost = product.cost || 0;
        const totalCost = unitCost * quantity;
        const subtotal = price * quantity;
        const profit = subtotal - totalCost;

        const saleProduct = {
            id: Date.now(),
            productId: productId,
            name: product.name,
            quantity: quantity,
            price: price,
            unitCost: unitCost,
            totalCost: totalCost,
            subtotal: subtotal,
            profit: profit
        };

        currentSale.products.push(saleProduct);
        updateCurrentSale();
        updateSaleProductsDisplay();
        
        // Resetar formulário APENAS dos campos de quantidade e preço
        document.getElementById('quantityInput').value = '1';
        document.getElementById('priceInput').value = '';
        // NÃO resetar o produto selecionado - deixar pronto para próxima venda
        
        showNotification(`${product.name} adicionado à venda`, "success");
    }

    function removeProductFromSale(productId) {
        currentSale.products = currentSale.products.filter(p => p.id !== productId);
        updateCurrentSale();
        updateSaleProductsDisplay();
    }

    function updateCurrentSale() {
        currentSale.total = currentSale.products.reduce((sum, p) => sum + p.subtotal, 0);
        currentSale.cost = currentSale.products.reduce((sum, p) => sum + p.totalCost, 0);
        currentSale.grossProfit = currentSale.total - currentSale.cost;
        
        document.getElementById('subtotalValue').textContent = `R$ ${currentSale.total.toFixed(2)}`;
        document.getElementById('totalCostValue').textContent = `R$ ${currentSale.cost.toFixed(2)}`;
        document.getElementById('grossProfitValue').textContent = `R$ ${currentSale.grossProfit.toFixed(2)}`;
        
        const summary = document.getElementById('saleTotalSummary');
        if (currentSale.products.length > 0) {
            summary.style.display = 'block';
        } else {
            summary.style.display = 'none';
        }
        
        document.getElementById('registerSaleBtn').disabled = currentSale.products.length === 0;
        document.getElementById('productsCount').textContent = `${currentSale.products.length} produtos`;
        
        updatePaymentSummary();
        
        // Auto-calcular pagamentos se ativado
        if (autoCalculatePayments && currentSale.total > 0 && mixedPaymentMethods.length > 0) {
            autoCalculatePaymentAmounts();
        }
    }

    function updateSaleProductsDisplay() {
        const container = document.getElementById('saleProductsList');
        
        if (currentSale.products.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-shopping-cart"></i>
                    <p>Nenhum produto adicionado à venda</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = '';
        currentSale.products.forEach(product => {
            const item = document.createElement('div');
            item.className = 'sale-product-item';
            item.innerHTML = `
                <div class="sale-product-info">
                    <div class="sale-product-name">${product.name}</div>
                    <div class="sale-product-details">
                        ${product.quantity} × R$ ${product.price.toFixed(2)} = R$ ${product.subtotal.toFixed(2)}
                        <br>
                        <small>Custo: R$ ${product.unitCost.toFixed(2)} × ${product.quantity} = R$ ${product.totalCost.toFixed(2)}</small>
                        <br>
                        <small>Lucro: R$ ${product.profit.toFixed(2)}</small>
                    </div>
                </div>
                <div>
                    <span class="sale-product-total">R$ ${product.subtotal.toFixed(2)}</span>
                    <button onclick="removeProductFromSale(${product.id})" class="remove-product-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            container.appendChild(item);
        });
    }

    function clearCurrentSale() {
        if (currentSale.products.length > 0 && !confirm("Tem certeza que deseja limpar a venda atual?")) {
            return;
        }
        
        currentSale = {
            products: [],
            total: 0,
            cost: 0,
            grossProfit: 0
        };
        
        mixedPaymentMethods = [];
        updateSaleProductsDisplay();
        updateCurrentSale();
        updateMixedPaymentDisplay();
        
        // Resetar completamente o formulário
        document.getElementById('productSelect').value = '';
        document.getElementById('quantityInput').value = '1';
        document.getElementById('priceInput').value = '';
        
        showNotification("Venda limpa", "info");
    }

    // ============ PAGAMENTO MISTO MELHORADO ============
    
    function generatePaymentMethodOptions() {
        let options = '';
        appState.paymentMethods.forEach(method => {
            options += `<option value="${method.id}">${method.name} ${method.fee > 0 ? `(${method.fee}%)` : ''}</option>`;
        });
        return options;
    }
    
    function addMixedPaymentMethod() {
        if (appState.paymentMethods.length === 0) {
            showNotification("Adicione formas de pagamento primeiro na seção 'Pagamentos'", "warning");
            return;
        }
    
        const paymentId = nextPaymentId++;
        const defaultMethod = appState.paymentMethods[0];
        
        mixedPaymentMethods.push({
            id: paymentId,
            methodId: defaultMethod.id,
            methodName: defaultMethod.name,
            methodType: defaultMethod.type,
            methodFee: defaultMethod.fee,
            amount: 0,
            isAutoCalculated: true
        });
    
        updateMixedPaymentDisplay();
        
        // Auto-calcular valores se houver total na venda
        if (currentSale.total > 0) {
            autoCalculatePaymentAmounts();
        }
    }
    
    function removeMixedPaymentMethod(id) {
        mixedPaymentMethods = mixedPaymentMethods.filter(item => item.id !== id);
        updateMixedPaymentDisplay();
        
        // Recalcular os valores restantes
        if (currentSale.total > 0) {
            autoCalculatePaymentAmounts();
        }
    }
    
    function updateMixedPaymentMethod(id, methodId) {
        const item = mixedPaymentMethods.find(item => item.id === id);
        if (item) {
            const method = appState.paymentMethods.find(m => m.id === parseInt(methodId));
            if (method) {
                item.methodId = method.id;
                item.methodName = method.name;
                item.methodType = method.type;
                item.methodFee = method.fee;
                item.isAutoCalculated = true;
                updatePaymentSummary();
                
                // Recalcular valores
                if (currentSale.total > 0) {
                    autoCalculatePaymentAmounts();
                }
            }
        }
    }
    
    function updateMixedPaymentAmount(id, amount) {
        const item = mixedPaymentMethods.find(item => item.id === id);
        if (item) {
            const newAmount = parseFloat(amount) || 0;
            item.amount = newAmount;
            item.isAutoCalculated = false; // Marcamos como manualmente ajustado
            
            // Se o usuário ajustou manualmente, desativar auto-calculo para esta transação
            autoCalculatePayments = false;
            
            // Ajustar os outros pagamentos automaticamente
            adjustOtherPayments(id, newAmount);
            
            updatePaymentSummary();
        }
    }
    
    function adjustOtherPayments(changedId, changedAmount) {
        const totalNeeded = currentSale.total;
        const changedItem = mixedPaymentMethods.find(item => item.id === changedId);
        if (!changedItem) return;
        
        let totalOtherAmount = 0;
        let autoCalculatedItems = [];
        
        // Calcular total dos outros itens e identificar quais são auto-calculados
        mixedPaymentMethods.forEach(item => {
            if (item.id !== changedId) {
                totalOtherAmount += item.amount;
                if (item.isAutoCalculated) {
                    autoCalculatedItems.push(item);
                }
            }
        });
        
        const remainingNeeded = totalNeeded - changedAmount - totalOtherAmount;
        
        // Se não há itens auto-calculados para ajustar ou o valor já está correto
        if (autoCalculatedItems.length === 0 || Math.abs(remainingNeeded) < 0.01) {
            return;
        }
        
        // Dividir o valor restante igualmente entre os itens auto-calculados
        const adjustmentPerItem = remainingNeeded / autoCalculatedItems.length;
        
        autoCalculatedItems.forEach(item => {
            item.amount = Math.max(0, item.amount + adjustmentPerItem);
        });
        
        updateMixedPaymentDisplay();
    }
    
    function autoCalculatePaymentAmounts() {
        if (currentSale.total <= 0 || mixedPaymentMethods.length === 0) return;
        
        const totalNeeded = currentSale.total;
        const numPayments = mixedPaymentMethods.length;
        const equalAmount = totalNeeded / numPayments;
        
        mixedPaymentMethods.forEach(item => {
            if (item.isAutoCalculated) {
                item.amount = equalAmount;
            }
        });
        
        updateMixedPaymentDisplay();
        autoCalculatePayments = true;
    }
    
    function updateMixedPaymentDisplay() {
        const container = dom.mixedPaymentContainer;
        container.innerHTML = '';
    
        if (mixedPaymentMethods.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-money-bill-wave"></i>
                    <p>Adicione formas de pagamento para dividir o valor total</p>
                </div>
            `;
            return;
        }
    
        mixedPaymentMethods.forEach(item => {
            const methodDiv = document.createElement('div');
            methodDiv.className = 'mixed-payment-item';
            methodDiv.innerHTML = `
                <div class="mixed-payment-header">
                    <div>
                        <select class="mixed-payment-select" 
                                onchange="updateMixedPaymentMethod(${item.id}, this.value)"
                                data-id="${item.id}">
                            ${generatePaymentMethodOptions()}
                        </select>
                        ${item.isAutoCalculated ? '<span class="badge badge-info" style="margin-left: 8px; font-size: 0.7rem;">Auto</span>' : ''}
                    </div>
                    <button onclick="removeMixedPaymentMethod(${item.id})" class="remove-payment-btn">
                        <i class="fas fa-times"></i> Remover
                    </button>
                </div>
                <div class="mixed-payment-amount">
                    <span>R$</span>
                    <input type="number" 
                           min="0" 
                           step="0.01" 
                           value="${item.amount.toFixed(2)}" 
                           placeholder="0.00"
                           onchange="updateMixedPaymentAmount(${item.id}, this.value)"
                           oninput="updateMixedPaymentAmount(${item.id}, this.value)"
                           style="${item.isAutoCalculated ? 'background-color: rgba(33, 150, 243, 0.1);' : ''}">
                </div>
                <div style="font-size: 0.8rem; color: var(--gray); margin-top: 5px;">
                    Taxa: R$ ${((item.amount * item.methodFee) / 100).toFixed(2)}
                </div>
            `;
            
            const select = methodDiv.querySelector('.mixed-payment-select');
            select.value = item.methodId;
            
            container.appendChild(methodDiv);
        });
    
        updatePaymentSummary();
    }
    
    function updatePaymentSummary() {
        const totalSaleValue = currentSale.total;
        let totalPaidValue = 0;
    
        mixedPaymentMethods.forEach(item => {
            totalPaidValue += item.amount;
        });
    
        const remaining = totalSaleValue - totalPaidValue;
        
        dom.totalPaid.textContent = totalPaidValue.toFixed(2);
        dom.remainingValue.textContent = Math.abs(remaining).toFixed(2);
        
        const remainingElement = dom.remainingAmount;
        remainingElement.className = 'remaining-amount ';
        
        if (remaining > 0.01) {
            remainingElement.classList.add('remaining-positive');
            remainingElement.innerHTML = `Restante a pagar: R$ <span id="remainingValue">${remaining.toFixed(2)}</span>`;
        } else if (remaining < -0.01) {
            remainingElement.classList.add('remaining-negative');
            remainingElement.innerHTML = `Troco necessário: R$ <span id="remainingValue">${Math.abs(remaining).toFixed(2)}</span>`;
        } else {
            remainingElement.classList.add('remaining-zero');
            remainingElement.innerHTML = `Valor quitado! <span id="remainingValue">${Math.abs(remaining).toFixed(2)}</span>`;
        }
    }
    
    function registerSale() {
        if (currentSale.products.length === 0) {
            showNotification("Adicione produtos à venda", "danger");
            return;
        }
    
        // Validar pagamentos
        const totalPaid = mixedPaymentMethods.reduce((sum, item) => sum + item.amount, 0);
        const remaining = currentSale.total - totalPaid;
        
        if (remaining > 0.01) {
            showNotification(`Falta R$ ${remaining.toFixed(2)} para completar o pagamento`, "warning");
            return;
        }
    
        // Registrar cada produto como uma venda separada
        const saleDate = new Date().toISOString();
        let totalMachineFee = 0;
        const salesToAdd = [];
    
        currentSale.products.forEach(saleProduct => {
            // Calcular taxas proporcionalmente
            const productPercentage = saleProduct.subtotal / currentSale.total;
            let productMachineFee = 0;
            
            mixedPaymentMethods.forEach(payment => {
                if (payment.amount > 0) {
                    const paymentMethod = appState.paymentMethods.find(p => p.id === payment.methodId);
                    if (paymentMethod && paymentMethod.fee > 0) {
                        const paymentFee = (payment.amount * paymentMethod.fee / 100) * productPercentage;
                        productMachineFee += paymentFee;
                    }
                }
            });
    
            totalMachineFee += productMachineFee;
    
            // Criar registro de venda COM CUSTO UNITÁRIO
            const sale = {
                id: Date.now() + Math.random(),
                productId: saleProduct.productId,
                productName: saleProduct.name,
                quantity: saleProduct.quantity,
                price: saleProduct.price,
                total: saleProduct.subtotal,
                unitCost: saleProduct.unitCost, // SALVANDO O CUSTO UNITÁRIO
                totalCost: saleProduct.totalCost,
                profit: saleProduct.profit - productMachineFee,
                paymentMethod: "Pagamento Misto",
                machineFee: productMachineFee,
                date: saleDate,
                isMixedPayment: true
            };
    
            salesToAdd.push(sale);
    
            // Atualizar estoque
            const product = appState.products.find(p => p.id === saleProduct.productId);
            if (product) {
                product.stock -= saleProduct.quantity;
                
                if (product.stock <= product.minStock && appState.settings.stockNotifications) {
                    showNotification(`Estoque baixo: ${product.name} (${product.stock} unidades)`, "warning");
                }
            }
        });
    
        // Adicionar todas as vendas ao histórico
        appState.sales.push(...salesToAdd);
        saveAppData();
    
        // Atualizar formas de pagamento
        mixedPaymentMethods.forEach(item => {
            if (item.amount > 0) {
                const method = appState.paymentMethods.find(p => p.id === item.methodId);
                if (method) {
                    method.total += item.amount;
                }
            }
        });
    
        // Efeitos visuais e sonoros
        if (appState.settings.animations) {
            playSaleAnimation();
        }
        
        if (appState.settings.saleSounds) {
            playSaleSound();
        }
    
        // Atualizar interface
        loadProducts();
        updateDashboard();
        updateGoalDisplay();
        updateRecentSales();
    
        // Mostrar resumo
        const summary = `
            Venda registrada com sucesso!<br>
            Produtos: ${currentSale.products.length}<br>
            Total: R$ ${currentSale.total.toFixed(2)}<br>
            Custo produtos: R$ ${currentSale.cost.toFixed(2)}<br>
            Lucro bruto: R$ ${currentSale.grossProfit.toFixed(2)}<br>
            Taxas: R$ ${totalMachineFee.toFixed(2)}
        `;
        
        showNotification(summary, "success");
    
        // LIMPAR A VENDA AUTOMATICAMENTE após sucesso
        clearCurrentSaleAfterSuccess();
    }
    
    function clearCurrentSaleAfterSuccess() {
        currentSale = {
            products: [],
            total: 0,
            cost: 0,
            grossProfit: 0
        };
        
        mixedPaymentMethods = [];
        nextPaymentId = 1;
        autoCalculatePayments = true;
        
        updateSaleProductsDisplay();
        updateCurrentSale();
        updateMixedPaymentDisplay();
        
        // Resetar formulário mas MANTER o produto selecionado
        document.getElementById('quantityInput').value = '1';
        document.getElementById('priceInput').value = '';
        // Não resetar o productSelect para facilitar venda repetida
        
        showNotification("Pronto para próxima venda!", "info");
    }
    
    function updateRecentSales() {
        const container = document.getElementById('recentSalesList');
        const today = new Date().toISOString().split('T')[0];
        
        const todaySales = appState.sales.filter(sale => {
            const saleDate = new Date(sale.date).toISOString().split('T')[0];
            return saleDate === today;
        }).slice(0, 10);
        
        if (todaySales.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-shopping-cart"></i>
                    <p>Nenhuma venda hoje</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = '';
        todaySales.forEach(sale => {
            const item = document.createElement('div');
            item.className = 'transaction-item';
            item.innerHTML = `
                <div>
                    <div style="font-weight: 600;">${sale.productName}</div>
                    <div style="font-size: 0.85rem; color: var(--gray);">
                        ${sale.quantity} × R$ ${sale.price.toFixed(2)}
                        | ${new Date(sale.date).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-weight: 700; color: var(--success);">R$ ${sale.total.toFixed(2)}</div>
                    <div style="font-size: 0.8rem; color: var(--gray);">
                        Custo: R$ ${(sale.unitCost * sale.quantity).toFixed(2)}<br>
                        Lucro: R$ ${sale.profit.toFixed(2)}
                    </div>
                </div>
            `;
            container.appendChild(item);
        });
    }
    
    function updatePriceFromProduct() {
        const productId = parseInt(dom.productSelect.value);
        if (!productId) {
            dom.priceInput.value = '';
            return;
        }
    
        const product = appState.products.find(p => p.id === productId);
        if (product) {
            dom.priceInput.value = product.price.toFixed(2);
        }
    }
    
    // ============ FUNÇÕES DO SISTEMA DE METAS ============
    
    function loadGoalData() {
        const savedDailyGoal = localStorage.getItem(GOAL_DATA_KEYS.DAILY_GOAL);
        if (savedDailyGoal) goalState.dailyGoal = parseFloat(savedDailyGoal);
        
        const savedWeeklyGoal = localStorage.getItem(GOAL_DATA_KEYS.WEEKLY_GOAL);
        if (savedWeeklyGoal) goalState.weeklyGoal = parseFloat(savedWeeklyGoal);
        
        const savedMonthlyGoal = localStorage.getItem(GOAL_DATA_KEYS.MONTHLY_GOAL);
        if (savedMonthlyGoal) goalState.monthlyGoal = parseFloat(savedMonthlyGoal);
        
        const savedGoalProducts = localStorage.getItem(GOAL_DATA_KEYS.GOAL_PRODUCTS);
        if (savedGoalProducts) goalState.goalProducts = JSON.parse(savedGoalProducts);
        
        const savedGoalHistory = localStorage.getItem(GOAL_DATA_KEYS.GOAL_HISTORY);
        if (savedGoalHistory) goalState.goalHistory = JSON.parse(savedGoalHistory);
        
        const savedGoalPeriod = localStorage.getItem(GOAL_DATA_KEYS.GOAL_PERIOD);
        if (savedGoalPeriod) goalState.goalPeriod = savedGoalPeriod;
        
        const savedGoalSettings = localStorage.getItem(GOAL_DATA_KEYS.GOAL_SETTINGS);
        if (savedGoalSettings) goalState.settings = JSON.parse(savedGoalSettings);
    }
    
    function saveGoalData() {
        localStorage.setItem(GOAL_DATA_KEYS.DAILY_GOAL, goalState.dailyGoal.toString());
        localStorage.setItem(GOAL_DATA_KEYS.WEEKLY_GOAL, goalState.weeklyGoal.toString());
        localStorage.setItem(GOAL_DATA_KEYS.MONTHLY_GOAL, goalState.monthlyGoal.toString());
        localStorage.setItem(GOAL_DATA_KEYS.GOAL_PRODUCTS, JSON.stringify(goalState.goalProducts));
        localStorage.setItem(GOAL_DATA_KEYS.GOAL_HISTORY, JSON.stringify(goalState.goalHistory));
        localStorage.setItem(GOAL_DATA_KEYS.GOAL_PERIOD, goalState.goalPeriod);
        localStorage.setItem(GOAL_DATA_KEYS.GOAL_SETTINGS, JSON.stringify(goalState.settings));
    }
    
    function calculateTodayProfitForGoals() {
        const today = new Date().toISOString().split('T')[0];
        let todayProfit = 0;
        
        // Filtrar vendas de hoje
        const todaySales = appState.sales.filter(sale => {
            const saleDate = new Date(sale.date).toISOString().split('T')[0];
            return saleDate === today;
        });
        
        // Calcular lucro líquido de cada venda
        todaySales.forEach(sale => {
            todayProfit += sale.profit || 0;
        });
        
        // Subtrair custos de hoje (não salário)
        const todayCosts = appState.costs.filter(cost => {
            const costDate = new Date(cost.date).toISOString().split('T')[0];
            return costDate === today && cost.category !== 'salary';
        });
        
        todayCosts.forEach(cost => {
            todayProfit -= cost.value;
        });
        
        return todayProfit;
    }
    
    function updateGoalDisplay() {
        const todayProfit = calculateTodayProfitForGoals();
        let currentGoal = 0;
        
        switch(goalState.goalPeriod) {
            case 'weekly':
                currentGoal = goalState.weeklyGoal;
                break;
            case 'monthly':
                currentGoal = goalState.monthlyGoal;
                break;
            default:
                currentGoal = goalState.dailyGoal;
        }
        
        document.getElementById('todayProfitValue').textContent = `R$ ${todayProfit.toFixed(2)}`;
        document.getElementById('dailyGoalValue').textContent = `R$ ${currentGoal.toFixed(2)}`;
        document.getElementById('currentDailyGoal').textContent = `R$ ${currentGoal.toFixed(2)}`;
        
        let progress = 0;
        let remaining = currentGoal;
        
        if (currentGoal > 0) {
            progress = Math.min((todayProfit / currentGoal) * 100, 100);
            remaining = Math.max(currentGoal - todayProfit, 0);
        }
        
        document.getElementById('remainingGoalValue').textContent = `R$ ${remaining.toFixed(2)}`;
        document.getElementById('todayProgressText').textContent = `${progress.toFixed(1)}% da meta`;
        document.getElementById('circularProgressText').textContent = `${progress.toFixed(0)}%`;
        
        document.getElementById('todayProgressFill').style.width = `${progress}%`;
        
        const circumference = 2 * Math.PI * 15.9155;
        const offset = circumference - (progress / 100) * circumference;
        document.getElementById('circularProgress').style.strokeDashoffset = offset;
        
        updateBestProductInfo();
        updateGoalRecommendation(todayProfit, currentGoal, progress);
        updateGoalMetrics();
        updateGoalHistory();
        updateGoalProductsDisplay();
    }
    
    function updateBestProductInfo() {
        if (goalState.goalProducts.length === 0) {
            document.getElementById('bestProductProfit').textContent = 'R$ 0,00';
            document.getElementById('unitsNeededText').textContent = 'Cadastre produtos';
            return;
        }
        
        const bestProduct = goalState.goalProducts.reduce((prev, current) => 
            (prev.profitPerUnit > current.profitPerUnit) ? prev : current
        );
        
        document.getElementById('bestProductProfit').textContent = `R$ ${bestProduct.profitPerUnit.toFixed(2)}`;
        
        const remaining = Math.max(goalState.dailyGoal - calculateTodayProfitForGoals(), 0);
        const unitsNeeded = Math.ceil(remaining / bestProduct.profitPerUnit);
        
        document.getElementById('unitsNeededText').textContent = `${unitsNeeded} unidades`;
    }
    
    function updateGoalRecommendation(todayProfit, currentGoal, progress) {
        const recommendationEl = document.getElementById('recommendationText');
        let recommendation = '';
        
        if (currentGoal === 0) {
            recommendation = 'Defina sua meta diária para começar a acompanhar seu progresso!';
        } else if (progress >= 100) {
            recommendation = '🎉 Parabéns! Você já bateu sua meta hoje!';
        } else if (progress >= 75) {
            recommendation = 'Ótimo trabalho! Você está quase lá!';
        } else if (progress >= 50) {
            recommendation = 'Bom progresso! Continue assim!';
        } else if (progress >= 25) {
            recommendation = 'Você está no caminho certo!';
        } else if (todayProfit > 0) {
            recommendation = 'Começou bem! Mantenha o ritmo!';
        } else {
            recommendation = 'Hora de começar! Venda seu primeiro produto hoje!';
        }
        
        if (goalState.goalProducts.length > 0 && progress < 100) {
            const bestProduct = goalState.goalProducts.reduce((prev, current) => 
                (prev.profitPerUnit > current.profitPerUnit) ? prev : current
            );
            
            const remaining = currentGoal - todayProfit;
            const unitsNeeded = Math.ceil(remaining / bestProduct.profitPerUnit);
            
            recommendation += ` Foque em vender ${unitsNeeded} unidades de ${bestProduct.name} para bater a meta!`;
        }
        
        recommendationEl.textContent = recommendation;
    }
    
    function updateGoalMetrics() {
        const last7Days = getLastNDays(7);
        const weeklyAverage = last7Days.reduce((sum, day) => sum + (day.profit || 0), 0) / 7;
        document.getElementById('weeklyAverage').textContent = `R$ ${weeklyAverage.toFixed(2)}`;
        
        const previousWeek = getLastNDays(14).slice(0, 7);
        const previousAverage = previousWeek.reduce((sum, day) => sum + (day.profit || 0), 0) / 7;
        const trend = weeklyAverage - previousAverage;
        
        const trendEl = document.getElementById('weeklyTrend');
        if (trend > 0) {
            trendEl.innerHTML = `<i class="fas fa-arrow-up" style="color: var(--success);"></i> +R$ ${Math.abs(trend).toFixed(2)}`;
        } else if (trend < 0) {
            trendEl.innerHTML = `<i class="fas fa-arrow-down" style="color: var(--danger);"></i> -R$ ${Math.abs(trend).toFixed(2)}`;
        } else {
            trendEl.innerHTML = `<i class="fas fa-minus"></i> Sem variação`;
        }
        
        const now = new Date();
        const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
        const today = now.getDate();
        document.getElementById('daysThisMonth').textContent = `${today}/${daysInMonth}`;
        
        const monthlyEstimate = goalState.dailyGoal * daysInMonth;
        document.getElementById('monthlyGoalEstimate').textContent = `R$ ${monthlyEstimate.toFixed(2)}`;
        
        const successDays = goalState.goalHistory.filter(day => (day.profit || 0) >= (day.goal || 0) && (day.goal || 0) > 0).length;
        const totalDays = goalState.goalHistory.filter(day => (day.goal || 0) > 0).length;
        const successRate = totalDays > 0 ? (successDays / totalDays) * 100 : 0;
        document.getElementById('successRate').textContent = `${successRate.toFixed(0)}%`;
    }
    
    function getLastNDays(n) {
        const days = [];
        const today = new Date();
        
        for (let i = 0; i < n; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            
            const historyDay = goalState.goalHistory.find(d => d.date === dateStr);
            
            if (historyDay) {
                days.push(historyDay);
            } else {
                const dayProfit = calculateDayProfitForGoals(dateStr);
                days.push({
                    date: dateStr,
                    profit: dayProfit,
                    goal: 0
                });
            }
        }
        
        return days;
    }
    
    function calculateDayProfitForGoals(dateStr) {
        let profit = 0;
        
        const daySales = appState.sales.filter(sale => {
            const saleDate = new Date(sale.date).toISOString().split('T')[0];
            return saleDate === dateStr;
        });
        
        daySales.forEach(sale => {
            profit += sale.profit || 0;
        });
        
        const dayCosts = appState.costs.filter(cost => {
            const costDate = new Date(cost.date).toISOString().split('T')[0];
            return costDate === dateStr && cost.category !== 'salary';
        });
        
        dayCosts.forEach(cost => {
            profit -= cost.value;
        });
        
        return profit;
    }
    
    function updateGoalProductsDisplay() {
        const productGrid = document.getElementById('productControlGrid');
        productGrid.innerHTML = '';
        
        if (goalState.goalProducts.length === 0) {
            productGrid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 2rem;">
                    <i class="fas fa-box-open fa-3x" style="color: var(--gray); margin-bottom: 1rem;"></i>
                    <h3>Nenhum produto cadastrado</h3>
                    <p>Cadastre seus produtos para calcular o lucro exato por venda</p>
                    <button onclick="showProductModal()" class="secondary" style="margin-top: 1rem;">
                        <i class="fas fa-plus"></i> Cadastrar Primeiro Produto
                    </button>
                </div>
            `;
            return;
        }
        
        goalState.goalProducts.forEach(product => {
            const productCard = document.createElement('div');
            productCard.className = 'product-control-card';
            productCard.innerHTML = `
                <div class="product-control-header">
                    <div class="product-control-name">${product.name}</div>
                    <div class="product-control-profit">+R$ ${product.profitPerUnit.toFixed(2)}</div>
                </div>
                <div class="product-control-stats">
                    <div>Custo: R$ ${product.cost.toFixed(2)}</div>
                    <div>Venda: R$ ${product.price.toFixed(2)}</div>
                    <div>Margem: ${product.margin.toFixed(1)}%</div>
                </div>
                <div style="font-size: 0.85rem; color: var(--gray);">
                    <i class="fas fa-chart-line"></i> Contribuição hoje: R$ ${(product.profitPerUnit * getTodaySalesCount(product.name)).toFixed(2)}
                </div>
                <div class="product-control-actions">
                    <button onclick="editGoalProduct(${product.id})" class="btn-small info">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button onclick="deleteGoalProduct(${product.id})" class="btn-small danger">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </div>
            `;
            
            productGrid.appendChild(productCard);
        });
    }
    
    function getTodaySalesCount(productName) {
        const today = new Date().toISOString().split('T')[0];
        const todaySales = appState.sales.filter(sale => {
            const saleDate = new Date(sale.date).toISOString().split('T')[0];
            return saleDate === today && sale.productName === productName;
        });
        
        return todaySales.reduce((sum, sale) => sum + sale.quantity, 0);
    }
    
    function setDailyGoal() {
        const input = document.getElementById('newDailyGoal');
        const value = parseFloat(input.value);
        
        if (!value || value <= 0) {
            showNotification("Digite um valor válido para a meta", "danger");
            return;
        }
        
        goalState.dailyGoal = value;
        saveGoalData();
        updateGoalDisplay();
        
        input.value = '';
        showNotification(`Meta diária definida em R$ ${value.toFixed(2)}`, "success");
        
        addGoalToHistory();
    }
    
    function addGoalToHistory() {
        const today = new Date().toISOString().split('T')[0];
        const todayProfit = calculateTodayProfitForGoals();
        
        const existingIndex = goalState.goalHistory.findIndex(d => d.date === today);
        
        if (existingIndex !== -1) {
            goalState.goalHistory[existingIndex].goal = goalState.dailyGoal;
            goalState.goalHistory[existingIndex].profit = todayProfit;
        } else {
            goalState.goalHistory.unshift({
                date: today,
                profit: todayProfit,
                goal: goalState.dailyGoal
            });
        }
        
        goalState.goalHistory = goalState.goalHistory.slice(0, 90);
        saveGoalData();
    }
    
    function showGoalModal() {
        document.getElementById('modalDailyGoal').value = goalState.dailyGoal;
        document.getElementById('goalDescription').value = goalState.goalDescription;
        document.getElementById('goalPeriod').value = goalState.goalPeriod;
        
        generateGoalSuggestions();
        
        document.getElementById('goalModal').classList.add('show');
    }
    
    function hideGoalModal() {
        document.getElementById('goalModal').classList.remove('show');
    }
    
    function saveDailyGoal() {
        const value = parseFloat(document.getElementById('modalDailyGoal').value);
        const description = document.getElementById('goalDescription').value;
        const period = document.getElementById('goalPeriod').value;
        
        if (!value || value <= 0) {
            showNotification("Digite um valor válido para a meta", "danger");
            return;
        }
        
        goalState.dailyGoal = value;
        goalState.goalDescription = description;
        goalState.goalPeriod = period;
        saveGoalData();
        updateGoalDisplay();
        
        hideGoalModal();
        showNotification(`Meta ${period} salva: R$ ${value.toFixed(2)}`, "success");
        
        addGoalToHistory();
    }
    
    function generateGoalSuggestions() {
        const suggestionsEl = document.getElementById('goalSuggestions');
        suggestionsEl.innerHTML = '';
        
        const last7Days = getLastNDays(7);
        const weeklyAverage = last7Days.reduce((sum, day) => sum + (day.profit || 0), 0) / 7;
        
        const bestDay = last7Days.reduce((prev, current) => 
            ((prev.profit || 0) > (current.profit || 0)) ? prev : current
        );
        
        const suggestions = [
            { value: weeklyAverage * 1.1, label: `10% acima da média (R$ ${(weeklyAverage * 1.1).toFixed(2)})` },
            { value: weeklyAverage * 1.25, label: `25% acima da média (R$ ${(weeklyAverage * 1.25).toFixed(2)})` },
            { value: bestDay.profit || 0, label: `Igual ao melhor dia (R$ ${(bestDay.profit || 0).toFixed(2)})` },
            { value: 150, label: 'Meta comum (R$ 150,00)' },
            { value: 250, label: 'Meta desafio (R$ 250,00)' }
        ];
        
        suggestions.forEach(suggestion => {
            const button = document.createElement('button');
            button.className = 'btn-small secondary';
            button.style.margin = '0 5px 5px 0';
            button.innerHTML = suggestion.label;
            button.onclick = () => {
                document.getElementById('modalDailyGoal').value = suggestion.value.toFixed(2);
            };
            suggestionsEl.appendChild(button);
        });
    }
    
    function showProductModal(editId = null) {
        const modal = document.getElementById('productModal');
        const title = modal.querySelector('.modal-title');
        const saveButton = modal.querySelector('.modal-actions .success');
        
        if (editId !== null) {
            const product = goalState.goalProducts.find(p => p.id === editId);
            if (product) {
                document.getElementById('modalProductName').value = product.name;
                document.getElementById('modalProductCost').value = product.cost;
                document.getElementById('modalProductPrice').value = product.price;
                title.innerHTML = `<i class="fas fa-edit"></i> Editar Produto`;
                saveButton.innerHTML = `<i class="fas fa-save"></i> Salvar Alterações`;
                saveButton.dataset.editId = editId;
            }
        } else {
            document.getElementById('modalProductName').value = '';
            document.getElementById('modalProductCost').value = '';
            document.getElementById('modalProductPrice').value = '';
            title.innerHTML = `<i class="fas fa-box"></i> Cadastrar Produto para Cálculo de Lucro`;
            saveButton.innerHTML = `<i class="fas fa-check"></i> Cadastrar Produto`;
            delete saveButton.dataset.editId;
        }
        
        updateProfitCalculation();
        
        modal.classList.add('show');
    }
    
    function hideProductModal() {
        document.getElementById('productModal').classList.remove('show');
    }
    
    function updateProfitCalculation() {
        const cost = parseFloat(document.getElementById('modalProductCost').value) || 0;
        const price = parseFloat(document.getElementById('modalProductPrice').value) || 0;
        
        const profit = price - cost;
        const margin = price > 0 ? (profit / price) * 100 : 0;
        
        document.getElementById('profitPerUnitCalc').textContent = `R$ ${profit.toFixed(2)}`;
        document.getElementById('profitMarginCalc').textContent = `${margin.toFixed(1)}%`;
    }
    
    function saveGoalProduct() {
        const name = document.getElementById('modalProductName').value.trim();
        const cost = parseFloat(document.getElementById('modalProductCost').value);
        const price = parseFloat(document.getElementById('modalProductPrice').value);
        const saveButton = document.querySelector('#productModal .modal-actions .success');
        const editId = saveButton.dataset.editId;
        
        if (!name) {
            showNotification("Digite o nome do produto", "danger");
            return;
        }
        
        if (!cost || cost <= 0) {
            showNotification("Digite um custo válido", "danger");
            return;
        }
        
        if (!price || price <= 0) {
            showNotification("Digite um preço de venda válido", "danger");
            return;
        }
        
        if (price <= cost) {
            showNotification("O preço de venda deve ser maior que o custo", "danger");
            return;
        }
        
        const profit = price - cost;
        const margin = (profit / price) * 100;
        
        if (editId) {
            const productIndex = goalState.goalProducts.findIndex(p => p.id === parseInt(editId));
            if (productIndex !== -1) {
                goalState.goalProducts[productIndex] = {
                    id: parseInt(editId),
                    name,
                    cost,
                    price,
                    profitPerUnit: profit,
                    margin,
                    updatedAt: new Date().toISOString()
                };
            }
        } else {
            const newProduct = {
                id: Date.now(),
                name,
                cost,
                price,
                profitPerUnit: profit,
                margin,
                createdAt: new Date().toISOString()
            };
            goalState.goalProducts.push(newProduct);
        }
        
        saveGoalData();
        updateGoalProductsDisplay();
        updateGoalDisplay();
        
        hideProductModal();
        showNotification(`Produto "${name}" salvo com sucesso!`, "success");
    }
    
    function editGoalProduct(productId) {
        showProductModal(productId);
    }
    
    function deleteGoalProduct(productId) {
        if (confirm("Tem certeza que deseja excluir este produto? Isso afetará o cálculo de lucro.")) {
            goalState.goalProducts = goalState.goalProducts.filter(p => p.id !== productId);
            saveGoalData();
            updateGoalProductsDisplay();
            updateGoalDisplay();
            showNotification("Produto excluído com sucesso!", "success");
        }
    }
    
    // ============ SISTEMA PRINCIPAL DO APP ============
    
    const APP_NAME = "PraiaVendas";
    const DATA_KEYS = {
        USERS: 'praiaVendas_users',
        BUSINESS_INFO: 'praiaVendas_businessInfo',
        PRODUCTS: 'praiaVendas_products',
        SALES: 'praiaVendas_sales',
        PAYMENT_METHODS: 'praiaVendas_paymentMethods',
        COSTS: 'praiaVendas_costs',
        CMV: 'praiaVendas_cmv',
        SETTINGS: 'praiaVendas_settings',
        COOKIE_CONSENT: 'praiaVendas_cookieConsent',
        SESSION: 'praiaVendas_session'
    };
    
    let appState = {
        currentUser: null,
        businessInfo: {
            name: "PraiaVendas",
            slogan: "Vendas na Praia",
            logo: "",
            themeColor: '#FF9800',
            changeFund: 0.00
        },
        products: [],
        sales: [],
        paymentMethods: [
            { id: 1, name: "Pix", type: "pix", fee: 0.00, total: 0 },
            { id: 2, name: "Dinheiro", type: "cash", fee: 0.00, total: 0 },
            { id: 3, name: "Cartão Crédito", type: "credit", fee: 3.99, total: 0 },
            { id: 4, name: "Cartão Débito", type: "debit", fee: 2.39, total: 0 }
        ],
        costs: [],
        cmv: {
            initialStock: 0,
            purchases: 0,
            finalStock: 0,
            calculatedCMV: 0
        },
        settings: {
            darkMode: false,
            saleSounds: true,
            stockNotifications: true,
            animations: true,
            currentFilter: 'today',
            machineFeePercentage: 3.99,
            goalNotifications: true
        },
        users: [],
        currentSection: 'dashboard'
    };
    
    const dom = {
        loginScreen: document.getElementById('loginScreen'),
        mainApp: document.getElementById('mainApp'),
        businessLogo: document.getElementById('businessLogo'),
        businessNameLogin: document.getElementById('businessNameLogin'),
        usernameInput: document.getElementById('usernameInput'),
        passwordInput: document.getElementById('passwordInput'),
        loginBtn: document.getElementById('loginBtn'),
        loginError: document.getElementById('loginError'),
        
        businessAvatar: document.getElementById('businessAvatar'),
        businessNameHeader: document.getElementById('businessNameHeader'),
        businessSlogan: document.getElementById('businessSlogan'),
        notificationToggle: document.getElementById('notificationToggle'),
        themeToggle: document.getElementById('themeToggle'),
        logoutBtn: document.getElementById('logoutBtn'),
        tabs: document.querySelectorAll('.tab'),
        
        sections: document.querySelectorAll('.section'),
        
        totalSalesValue: document.getElementById('totalSalesValue'),
        totalProductsSold: document.getElementById('totalProductsSold'),
        grossRevenue: document.getElementById('grossRevenue'),
        netRevenue: document.getElementById('netRevenue'),
        cmvValue: document.getElementById('cmvValue'),
        machineFee: document.getElementById('machineFee'),
        changeFund: document.getElementById('changeFund'),
        changeFundInput: document.getElementById('changeFundInput'),
        salaryValue: document.getElementById('salaryValue'),
        filterButtons: document.querySelectorAll('.filter-btn'),
        salesChart: document.getElementById('salesChart'),
        
        productSelect: document.getElementById('productSelect'),
        quantityInput: document.getElementById('quantityInput'),
        priceInput: document.getElementById('priceInput'),
        registerSaleBtn: document.getElementById('registerSaleBtn'),
        clearSaleBtn: document.getElementById('clearSaleBtn'),
        addProductToSaleBtn: document.getElementById('addProductToSaleBtn'),
        recentSalesList: document.getElementById('recentSalesList'),
        
        addMixedPaymentBtn: document.getElementById('addMixedPaymentBtn'),
        mixedPaymentContainer: document.getElementById('mixedPaymentContainer'),
        totalPaid: document.getElementById('totalPaid'),
        remainingValue: document.getElementById('remainingValue'),
        remainingAmount: document.getElementById('remainingAmount'),
        
        paymentMethodName: document.getElementById('paymentMethodName'),
        paymentMethodType: document.getElementById('paymentMethodType'),
        paymentMethodFee: document.getElementById('paymentMethodFee'),
        savePaymentMethodBtn: document.getElementById('savePaymentMethodBtn'),
        paymentMethodsList: document.getElementById('paymentMethodsList'),
        
        costDescription: document.getElementById('costDescription'),
        costCategory: document.getElementById('costCategory'),
        costValue: document.getElementById('costValue'),
        costDate: document.getElementById('costDate'),
        addCostBtn: document.getElementById('addCostBtn'),
        costsList: document.getElementById('costsList'),
        initialStock: document.getElementById('initialStock'),
        purchases: document.getElementById('purchases'),
        finalStock: document.getElementById('finalStock'),
        calculateCMVBtn: document.getElementById('calculateCMVBtn'),
        cmvResult: document.getElementById('cmvResult'),
        cmvResultValue: document.getElementById('cmvResultValue'),
        
        productName: document.getElementById('productName'),
        productCategory: document.getElementById('productCategory'),
        productPrice: document.getElementById('productPrice'),
        productCost: document.getElementById('productCost'),
        productStock: document.getElementById('productStock'),
        productMinStock: document.getElementById('productMinStock'),
        addProductBtn: document.getElementById('addProductBtn'),
        cancelEditBtn: document.getElementById('cancelEditBtn'),
        productsList: document.getElementById('productsList'),
        
        totalRevenue: document.getElementById('totalRevenue'),
        profitValue: document.getElementById('profitValue'),
        marginValue: document.getElementById('marginValue'),
        exportSalesBtn: document.getElementById('exportSalesBtn'),
        exportProductsBtn: document.getElementById('exportProductsBtn'),
        exportFinanceBtn: document.getElementById('exportFinanceBtn'),
        targetRevenue: document.getElementById('targetRevenue'),
        targetPeriod: document.getElementById('targetPeriod'),
        calculateProjectionBtn: document.getElementById('calculateProjectionBtn'),
        projectionResult: document.getElementById('projectionResult'),
        
        businessNameInput: document.getElementById('businessNameInput'),
        businessSloganInput: document.getElementById('businessSloganInput'),
        businessPhotoPreview: document.getElementById('businessPhotoPreview'),
        businessPhotoInput: document.getElementById('businessPhotoInput'),
        photoUpload: document.getElementById('photoUpload'),
        saveBusinessInfoBtn: document.getElementById('saveBusinessInfoBtn'),
        colorOptions: document.querySelectorAll('.color-option'),
        saleSoundsToggle: document.getElementById('saleSoundsToggle'),
        stockNotificationsToggle: document.getElementById('stockNotificationsToggle'),
        animationsToggle: document.getElementById('animationsToggle'),
        goalNotificationsToggle: document.getElementById('goalNotificationsToggle'),
        backupDataBtn: document.getElementById('backupDataBtn'),
        restoreDataBtn: document.getElementById('restoreDataBtn'),
        resetDataBtn: document.getElementById('resetDataBtn'),
        
        notification: document.getElementById('notification'),
        notificationText: document.getElementById('notificationText'),
        
        saleAnimation: document.getElementById('saleAnimation'),
        
        cookieModal: document.getElementById('cookieModal'),
        acceptCookies: document.getElementById('acceptCookies')
    };
    
    async function initApp() {
        await loadUsersFromJSON();
        
        loadAppData();
        loadGoalData();
        
        const needsLogin = checkDailyLogin();
        if (needsLogin) {
            showLogin();
        } else {
            checkSession();
        }
        
        checkCookieConsent();
        
        setupEventListeners();
        
        updateBusinessInfo();
        loadProducts();
        loadPaymentMethods();
        loadCosts();
        updateDashboard();
        updateGoalDisplay();
        updateRecentSales();
        setupCharts();
        setupProfitPieChart();
        setupFinancePieChart();
    }
    
    function checkCookieConsent() {
        const consent = localStorage.getItem(DATA_KEYS.COOKIE_CONSENT);
        if (!consent) {
            setTimeout(() => {
                dom.cookieModal.classList.add('show');
            }, 1000);
        }
    }
    
    function loadAppData() {
        const savedBusinessInfo = localStorage.getItem(DATA_KEYS.BUSINESS_INFO);
        if (savedBusinessInfo) appState.businessInfo = JSON.parse(savedBusinessInfo);
        
        const savedProducts = localStorage.getItem(DATA_KEYS.PRODUCTS);
        if (savedProducts) appState.products = JSON.parse(savedProducts);
        
        const savedSales = localStorage.getItem(DATA_KEYS.SALES);
        if (savedSales) appState.sales = JSON.parse(savedSales);
        
        const savedPaymentMethods = localStorage.getItem(DATA_KEYS.PAYMENT_METHODS);
        if (savedPaymentMethods) appState.paymentMethods = JSON.parse(savedPaymentMethods);
        
        const savedCosts = localStorage.getItem(DATA_KEYS.COSTS);
        if (savedCosts) appState.costs = JSON.parse(savedCosts);
        
        const savedCMV = localStorage.getItem(DATA_KEYS.CMV);
        if (savedCMV) appState.cmv = JSON.parse(savedCMV);
        
        const savedSettings = localStorage.getItem(DATA_KEYS.SETTINGS);
        if (savedSettings) appState.settings = JSON.parse(savedSettings);
    }
    
    function saveAppData() {
        localStorage.setItem(DATA_KEYS.BUSINESS_INFO, JSON.stringify(appState.businessInfo));
        localStorage.setItem(DATA_KEYS.PRODUCTS, JSON.stringify(appState.products));
        localStorage.setItem(DATA_KEYS.SALES, JSON.stringify(appState.sales));
        localStorage.setItem(DATA_KEYS.PAYMENT_METHODS, JSON.stringify(appState.paymentMethods));
        localStorage.setItem(DATA_KEYS.COSTS, JSON.stringify(appState.costs));
        localStorage.setItem(DATA_KEYS.CMV, JSON.stringify(appState.cmv));
        localStorage.setItem(DATA_KEYS.SETTINGS, JSON.stringify(appState.settings));
    }
    
    function updateLastAccess() {
        if (appState.currentUser) {
            const userIndex = appState.users.findIndex(u => u.id === appState.currentUser.id);
            if (userIndex !== -1) {
                appState.users[userIndex].ultimo_acesso = new Date().toISOString();
            }
        }
    }
    
    function updateBusinessInfo() {
        document.documentElement.style.setProperty('--primary', appState.businessInfo.themeColor);
        
        if (appState.businessInfo.logo) {
            dom.businessLogo.src = appState.businessInfo.logo;
            dom.businessAvatar.src = appState.businessInfo.logo;
            dom.businessPhotoPreview.src = appState.businessInfo.logo;
        } else {
            const defaultIcon = "logo.jpeg";

            dom.businessLogo.src = defaultIcon;
            dom.businessAvatar.src = defaultIcon;
            dom.businessPhotoPreview.src = defaultIcon;
        }
        
        dom.businessNameLogin.textContent = appState.businessInfo.name;
        dom.businessNameHeader.textContent = appState.businessInfo.name;
        dom.businessSlogan.textContent = appState.businessInfo.slogan;
        dom.businessNameInput.value = appState.businessInfo.name;
        dom.businessSloganInput.value = appState.businessInfo.slogan;
        
        dom.changeFund.textContent = `R$ ${appState.businessInfo.changeFund.toFixed(2)}`;
        dom.changeFundInput.value = appState.businessInfo.changeFund;
        
        dom.colorOptions.forEach(option => {
            option.classList.toggle('selected', option.dataset.color === appState.businessInfo.themeColor);
        });
        
        updateTheme();
    }
    
    function updateChangeFund() {
        const newValue = parseFloat(dom.changeFundInput.value) || 0;
        appState.businessInfo.changeFund = newValue;
        saveAppData();
        updateBusinessInfo();
        showNotification(`Fundo de troco atualizado para R$ ${newValue.toFixed(2)}`, "success");
    }
    
    function toggleTheme() {
        appState.settings.darkMode = !appState.settings.darkMode;
        saveAppData();
        updateTheme();
        showNotification(appState.settings.darkMode ? "Modo escuro ativado" : "Modo claro ativado", "info");
    }
    
    function updateTheme() {
        if (appState.settings.darkMode) {
            document.documentElement.setAttribute('data-theme', 'dark');
            dom.themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        } else {
            document.documentElement.removeAttribute('data-theme');
            dom.themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
        }
    }
    
    function login(username, password) {
        const user = appState.users.find(u => 
            u.username === username && u.password === password
        );
        
        if (user) {
            if (!user.ativo) {
                showNotification("Usuário inativo", "danger");
                return false;
            }
    
            if (user.bloqueado) {
                showNotification(user.mensagem_acesso || "Usuário bloqueado", "danger");
                return false;
            }
    
            appState.currentUser = user;
            
            markAsLoggedIn();
            updateLastAccess();
            
            const session = {
                username: user.username,
                expires: Date.now() + (7 * 24 * 60 * 60 * 1000)
            };
            localStorage.setItem(DATA_KEYS.SESSION, JSON.stringify(session));
            
            showMainApp();
            showNotification(user.mensagem_acesso || `Bem-vindo, ${user.nome}!`, "success");
            return true;
        }
        
        return false;
    }
    
    function logout() {
        appState.currentUser = null;
        localStorage.removeItem(DATA_KEYS.SESSION);
        
        const today = new Date().toDateString();
        localStorage.setItem(LOGIN_SYSTEM_KEYS.LAST_LOGIN_DATE, today);
        localStorage.setItem(LOGIN_SYSTEM_KEYS.LOGIN_REQUIRED, 'true');
        
        showLogin();
        showNotification("Você saiu do sistema", "info");
    }
    
    function showLogin() {
        dom.loginScreen.style.display = 'flex';
        dom.mainApp.style.display = 'none';
        dom.usernameInput.value = '';
        dom.passwordInput.value = '';
        dom.loginError.style.display = 'none';
    }
    
    function showMainApp() {
        dom.loginScreen.style.display = 'none';
        dom.mainApp.style.display = 'block';
    }
    
    function checkSession() {
        const session = localStorage.getItem(DATA_KEYS.SESSION);
        if (session) {
            const sessionData = JSON.parse(session);
            if (sessionData.expires > Date.now()) {
                appState.currentUser = appState.users.find(u => u.username === sessionData.username);
                if (appState.currentUser) {
                    const needsLogin = checkDailyLogin();
                    if (needsLogin) {
                        showLogin();
                    } else {
                        showMainApp();
                    }
                } else {
                    showLogin();
                }
            } else {
                localStorage.removeItem(DATA_KEYS.SESSION);
                showLogin();
            }
        } else {
            showLogin();
        }
    }
    
    function loadProducts() {
        const select = dom.productSelect;
        select.innerHTML = '<option value="">Selecione um produto</option>';
        
        appState.products.forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.textContent = `${product.name} - R$ ${product.price.toFixed(2)} (Estoque: ${product.stock})`;
            select.appendChild(option);
        });
        
        updateProductsGrid();
    }
    
    function addProduct() {
        const name = dom.productName.value.trim();
        const category = dom.productCategory.value;
        const price = parseFloat(dom.productPrice.value);
        const cost = parseFloat(dom.productCost.value) || 0;
        const stock = parseInt(dom.productStock.value);
        const minStock = parseInt(dom.productMinStock.value);
        
        if (!name || !price || !stock) {
            showNotification("Preencha todos os campos obrigatórios", "danger");
            return;
        }
        
        if (price <= 0) {
            showNotification("Preço deve ser maior que zero", "danger");
            return;
        }
        
        if (stock <= 0) {
            showNotification("Estoque deve ser maior que zero", "danger");
            return;
        }
        
        const editId = dom.addProductBtn.dataset.editId;
        
        if (editId) {
            const productIndex = appState.products.findIndex(p => p.id === parseInt(editId));
            if (productIndex !== -1) {
                appState.products[productIndex] = {
                    ...appState.products[productIndex],
                    name: name,
                    category: category,
                    price: price,
                    cost: cost,
                    stock: stock,
                    minStock: minStock,
                    updatedAt: new Date().toISOString()
                };
                
                saveAppData();
                loadProducts();
                cancelEdit();
                showNotification(`Produto "${name}" atualizado com sucesso!`, "success");
                
                syncWithGoalProducts(name, cost, price);
            }
        } else {
            const newProduct = {
                id: Date.now(),
                name: name,
                category: category,
                price: price,
                cost: cost,
                stock: stock,
                minStock: minStock,
                createdAt: new Date().toISOString()
            };
            
            appState.products.push(newProduct);
            saveAppData();
            loadProducts();
            resetProductForm();
            showNotification(`Produto "${name}" adicionado com sucesso!`, "success");
            
            syncWithGoalProducts(name, cost, price);
        }
    }
    
    function syncWithGoalProducts(name, cost, price) {
        const existingGoalProduct = goalState.goalProducts.find(p => p.name === name);
        
        if (!existingGoalProduct && cost > 0 && price > 0) {
            if (confirm(`Deseja adicionar "${name}" ao cálculo de lucro das metas?`)) {
                const profit = price - cost;
                const margin = (profit / price) * 100;
                
                goalState.goalProducts.push({
                    id: Date.now(),
                    name,
                    cost,
                    price,
                    profitPerUnit: profit,
                    margin,
                    createdAt: new Date().toISOString()
                });
                
                saveGoalData();
                updateGoalProductsDisplay();
                updateGoalDisplay();
                
                showNotification(`Produto "${name}" adicionado ao cálculo de lucro!`, "success");
            }
        }
    }
    
    function updateProductsGrid() {
        dom.productsList.innerHTML = '';
        
        if (appState.products.length === 0) {
            dom.productsList.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 2rem;">
                    <i class="fas fa-box-open fa-3x" style="color: var(--gray); margin-bottom: 1rem;"></i>
                    <h3>Nenhum produto cadastrado</h3>
                    <p>Adicione seus produtos para começar a vender</p>
                </div>
            `;
            return;
        }
        
        appState.products.forEach(product => {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.innerHTML = `
                <div class="product-image">
                    <i class="fas fa-${getProductIcon(product.category)}"></i>
                </div>
                <div class="product-info">
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">R$ ${product.price.toFixed(2)}</div>
                    <div class="product-stock ${product.stock <= product.minStock ? 'stock-low' : ''}">
                        Estoque: ${product.stock} ${product.stock <= product.minStock ? '⚠️ Baixo' : ''}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--gray); margin-bottom: 0.5rem;">
                        Custo: R$ ${product.cost ? product.cost.toFixed(2) : '0.00'} | Mín: ${product.minStock}
                    </div>
                    <div class="product-actions">
                        <button onclick="showEditProductModal(${product.id})" class="btn-small info">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button onclick="showDeleteProductModal(${product.id})" class="btn-small danger">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </div>
                </div>
            `;
            dom.productsList.appendChild(card);
        });
    }
    
    function getProductIcon(category) {
        const icons = {
            'bebidas': 'wine-bottle',
            'comidas': 'hamburger',
            'sobremesas': 'ice-cream',
            'acessorios': 'umbrella-beach',
            'outros': 'box'
        };
        return icons[category] || 'box';
    }
    
    function showEditProductModal(productId) {
        const product = appState.products.find(p => p.id === productId);
        if (!product) return;
        
        dom.productName.value = product.name;
        dom.productCategory.value = product.category;
        dom.productPrice.value = product.price;
        dom.productCost.value = product.cost || 0;
        dom.productStock.value = product.stock;
        dom.productMinStock.value = product.minStock;
        
        dom.addProductBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Alterações';
        dom.addProductBtn.dataset.editId = productId;
        dom.cancelEditBtn.style.display = 'inline-flex';
        
        document.getElementById('products').scrollIntoView({ behavior: 'smooth' });
        
        dom.productName.focus();
        
        showNotification(`Editando produto: ${product.name}`, "info");
    }
    
    function showDeleteProductModal(productId) {
        const product = appState.products.find(p => p.id === productId);
        if (!product) return;
        
        productToDelete = productId;
        document.getElementById('deleteProductName').textContent = product.name;
        document.getElementById('deleteProductModal').classList.add('show');
    }
    
    function hideDeleteProductModal() {
        document.getElementById('deleteProductModal').classList.remove('show');
        productToDelete = null;
    }
    
    function confirmDeleteProduct() {
        if (!productToDelete) return;
        
        const productIndex = appState.products.findIndex(p => p.id === productToDelete);
        if (productIndex === -1) return;
        
        const productName = appState.products[productIndex].name;
        
        const hasSales = appState.sales.some(sale => sale.productId === productToDelete);
        
        if (hasSales) {
            showNotification(`O produto "${productName}" tem vendas associadas e não pode ser excluído.`, "warning");
            hideDeleteProductModal();
            return;
        }
        
        appState.products.splice(productIndex, 1);
        saveAppData();
        loadProducts();
        hideDeleteProductModal();
        showNotification(`Produto "${productName}" excluído com sucesso!`, "success");
        
        const goalProductIndex = goalState.goalProducts.findIndex(p => p.name === productName);
        if (goalProductIndex !== -1) {
            goalState.goalProducts.splice(goalProductIndex, 1);
            saveGoalData();
            updateGoalProductsDisplay();
            updateGoalDisplay();
        }
    }
    
    function cancelEdit() {
        dom.addProductBtn.innerHTML = '<i class="fas fa-plus"></i> Adicionar Produto';
        delete dom.addProductBtn.dataset.editId;
        dom.cancelEditBtn.style.display = 'none';
        resetProductForm();
    }
    
    function resetProductForm() {
        dom.productName.value = '';
        dom.productCategory.value = 'bebidas';
        dom.productPrice.value = '';
        dom.productCost.value = '';
        dom.productStock.value = '10';
        dom.productMinStock.value = '5';
    }
    
    function loadPaymentMethods() {
        dom.paymentMethodsList.innerHTML = '';
        
        appState.paymentMethods.forEach(method => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${method.name}</td>
                <td>${getPaymentTypeName(method.type)}</td>
                <td>${method.fee}%</td>
                <td class="actions-cell">
                    <button onclick="deletePaymentMethod(${method.id})" class="btn-small danger">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </td>
            `;
            dom.paymentMethodsList.appendChild(row);
        });
    }
    
    function getPaymentTypeName(type) {
        const types = {
            'pix': 'Pix',
            'cash': 'Dinheiro',
            'credit': 'Cartão Crédito',
            'debit': 'Cartão Débito',
            'other': 'Outro'
        };
        return types[type] || type;
    }
    
    function addPaymentMethod() {
        const name = dom.paymentMethodName.value.trim();
        const type = dom.paymentMethodType.value;
        const fee = parseFloat(dom.paymentMethodFee.value) || 0;
        
        if (!name) {
            showNotification("Digite o nome da forma de pagamento", "danger");
            return;
        }
        
        const newMethod = {
            id: Date.now(),
            name: name,
            type: type,
            fee: fee,
            total: 0
        };
        
        appState.paymentMethods.push(newMethod);
        saveAppData();
        loadPaymentMethods();
        
        dom.paymentMethodName.value = '';
        dom.paymentMethodFee.value = '';
        
        showNotification(`Forma de pagamento "${name}" adicionada com sucesso!`, "success");
    }
    
    window.deletePaymentMethod = function(id) {
        if (appState.paymentMethods.length <= 2) {
            showNotification("Você precisa ter pelo menos 2 formas de pagamento", "warning");
            return;
        }
        
        if (confirm("Tem certeza que deseja excluir esta forma de pagamento?")) {
            appState.paymentMethods = appState.paymentMethods.filter(m => m.id !== id);
            saveAppData();
            loadPaymentMethods();
            showNotification("Forma de pagamento excluída com sucesso!", "success");
        }
    };
    
    function loadCosts() {
        dom.costsList.innerHTML = '';
        
        appState.costs.forEach(cost => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${new Date(cost.date).toLocaleDateString('pt-BR')}</td>
                <td>${cost.description}</td>
                <td>${getCostCategoryName(cost.category)}</td>
                <td>R$ ${cost.value.toFixed(2)}</td>
                <td class="actions-cell">
                    <button onclick="deleteCost(${cost.id})" class="btn-small danger">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </td>
            `;
            dom.costsList.appendChild(row);
        });
    }
    
    function getCostCategoryName(category) {
        const categories = {
            'transport': 'Transporte',
            'food': 'Alimentação',
            'machine_fee': 'Taxa Maquininha',
            'donation': 'Doação',
            'barter': 'Escambo',
            'gift': 'Brinde',
            'water': 'Água',
            'electricity': 'Luz',
            'gas': 'Gás',
            'salary': 'Salário (Pró-labore)',
            'employee': 'Funcionário',
            'other': 'Outros'
        };
        return categories[category] || category;
    }
    
    function addCost() {
        const description = dom.costDescription.value.trim();
        const category = dom.costCategory.value;
        const value = parseFloat(dom.costValue.value);
        const date = dom.costDate.value || new Date().toISOString().split('T')[0];
        
        if (!description) {
            showNotification("Digite a descrição do custo", "danger");
            return;
        }
        
        if (!value || value <= 0) {
            showNotification("Digite um valor válido", "danger");
            return;
        }
        
        const newCost = {
            id: Date.now(),
            description: description,
            category: category,
            value: value,
            date: date
        };
        
        appState.costs.push(newCost);
        saveAppData();
        loadCosts();
        updateDashboard();
        updateGoalDisplay();
        
        dom.costDescription.value = '';
        dom.costValue.value = '';
        dom.costDate.value = '';
        
        showNotification(`Custo "${description}" adicionado com sucesso!`, "success");
    }
    
    window.deleteCost = function(id) {
        if (confirm("Tem certeza que deseja excluir este custo?")) {
            appState.costs = appState.costs.filter(c => c.id !== id);
            saveAppData();
            loadCosts();
            updateDashboard();
            updateGoalDisplay();
            showNotification("Custo excluído com sucesso!", "success");
        }
    };
    
    function calculateCMV() {
        const initialStock = parseFloat(dom.initialStock.value) || 0;
        const purchases = parseFloat(dom.purchases.value) || 0;
        const finalStock = parseFloat(dom.finalStock.value) || 0;
        
        const cmv = initialStock + purchases - finalStock;
        
        appState.cmv = {
            initialStock: initialStock,
            purchases: purchases,
            finalStock: finalStock,
            calculatedCMV: cmv
        };
        saveAppData();
        
        dom.cmvResultValue.textContent = cmv.toFixed(2);
        dom.cmvResult.style.display = 'block';
        
        updateDashboard();
        updateGoalDisplay();
        
        showNotification(`CMV calculado: R$ ${cmv.toFixed(2)}`, "success");
    }
    
    function setupCharts() {
        window.salesChart = new Chart(dom.salesChart, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Vendas (R$)',
                    data: [],
                    borderColor: appState.businessInfo.themeColor,
                    backgroundColor: `${appState.businessInfo.themeColor}20`,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value;
                            }
                        }
                    }
                }
            }
        });
    }
    
    function updateSalesChart(filteredSales) {
        const salesByDay = {};
        filteredSales.forEach(sale => {
            const date = new Date(sale.date).toLocaleDateString('pt-BR', { weekday: 'short' });
            if (!salesByDay[date]) salesByDay[date] = 0;
            salesByDay[date] += sale.total;
        });
        
        window.salesChart.data.labels = Object.keys(salesByDay);
        window.salesChart.data.datasets[0].data = Object.values(salesByDay);
        window.salesChart.update();
    }
    
    function playSaleAnimation() {
        dom.saleAnimation.classList.add('show');
        setTimeout(() => {
            dom.saleAnimation.classList.remove('show');
        }, 1000);
    }
    
    function playSaleSound() {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        } catch (e) {
            // Som não disponível
        }
    }
    
    function showNotification(message, type = "success") {
        dom.notificationText.innerHTML = message;
        dom.notification.className = `notification ${type}`;
        dom.notification.classList.add('show');
        
        setTimeout(() => {
            dom.notification.classList.remove('show');
        }, 3000);
    }
    
    function exportData(type) {
        let data, filename;
        
        switch(type) {
            case 'sales':
                data = appState.sales.map(sale => ({
                    Data: new Date(sale.date).toLocaleDateString('pt-BR'),
                    Produto: sale.productName,
                    Quantidade: sale.quantity,
                    'Preço Unitário': sale.price.toFixed(2),
                    Total: sale.total.toFixed(2),
                    'Forma de Pagamento': sale.paymentMethod,
                    'Taxa da Maquininha': sale.machineFee.toFixed(2)
                }));
                filename = 'vendas.csv';
                exportToCSV(data, filename);
                break;
                
            case 'products':
                data = appState.products.map(product => ({
                    Nome: product.name,
                    Categoria: product.category,
                    'Preço de Venda': product.price.toFixed(2),
                    'Custo Unitário': product.cost ? product.cost.toFixed(2) : '0.00',
                    Estoque: product.stock,
                    'Estoque Mínimo': product.minStock
                }));
                filename = 'produtos.csv';
                exportToCSV(data, filename);
                break;
                
            case 'finance':
                const profitData = calculateNetProfit();
                const totalProducts = appState.sales.reduce((sum, sale) => sum + sale.quantity, 0);
                const average = profitData.totalRevenue / (appState.sales.length || 1);
                
                const report = `
                    RELATÓRIO FINANCEIRO - ${appState.businessInfo.name}
                    ============================================
                    Período: ${new Date().toLocaleDateString('pt-BR')}
                    
                    RESUMO:
                    - Receita Total: R$ ${profitData.totalRevenue.toFixed(2)}
                    - Produtos Vendidos: ${totalProducts}
                    - Ticket Médio: R$ ${average.toFixed(2)}
                    - Total de Vendas: ${appState.sales.length}
                    
                    CUSTOS:
                    - Custo Produtos: R$ ${profitData.totalProductCost.toFixed(2)}
                    - Taxas da Maquininha: R$ ${profitData.machineFees.toFixed(2)}
                    - Outros Custos: R$ ${profitData.otherCosts.toFixed(2)}
                    - Salário (Pró-labore): R$ ${profitData.salary.toFixed(2)}
                    
                    RESULTADO:
                    - Lucro Líquido: R$ ${profitData.netProfit.toFixed(2)}
                    - Margem Líquida: ${profitData.totalRevenue > 0 ? ((profitData.netProfit / profitData.totalRevenue) * 100).toFixed(1) : 0}%
                    
                    FORMAS DE PAGAMENTO:
                    ${appState.paymentMethods.map(p => `- ${p.name}: R$ ${p.total.toFixed(2)} (${p.fee}%)`).join('\n')}
                    
                    ESTOQUE ATUAL:
                    ${appState.products.map(p => `- ${p.name}: ${p.stock} unidades (Custo: R$ ${p.cost ? p.cost.toFixed(2) : '0.00'})`).join('\n')}
                    
                    META DIÁRIA:
                    - Meta Atual: R$ ${goalState.dailyGoal.toFixed(2)}
                    - Lucro Hoje: R$ ${calculateTodayProfitForGoals().toFixed(2)}
                    - Progresso: ${goalState.dailyGoal > 0 ? ((calculateTodayProfitForGoals() / goalState.dailyGoal) * 100).toFixed(1) : 0}%
                `;
                
                downloadFile(report, 'relatorio-financeiro.txt', 'text/plain');
                break;
        }
        
        showNotification(`Dados exportados com sucesso!`, "success");
    }
    
    function exportToCSV(data, filename, contentType) {
        if (data.length === 0) {
            showNotification("Nenhum dado para exportar", "warning");
            return;
        }
        
        const headers = Object.keys(data[0]);
        const csvContent = [
            headers.join(','),
            ...data.map(row => headers.map(header => row[header]).join(','))
        ].join('\n');
        
        downloadFile(csvContent, filename, 'text/csv');
    }
    
    function downloadFile(content, filename, contentType) {
        const blob = new Blob([content], { type: contentType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    function calculateProjection() {
        const targetRevenue = parseFloat(dom.targetRevenue.value) || 0;
        const targetPeriod = parseInt(dom.targetPeriod.value) || 30;
        
        if (targetRevenue <= 0) {
            showNotification("Digite uma meta de faturamento válida", "danger");
            return;
        }
        
        const dailySales = appState.sales.reduce((acc, sale) => {
            const date = new Date(sale.date).toLocaleDateString('pt-BR');
            if (!acc[date]) acc[date] = 0;
            acc[date] += sale.total;
            return acc;
        }, {});
        
        const daysCount = Object.keys(dailySales).length || 1;
        const totalSales = Object.values(dailySales).reduce((a, b) => a + b, 0);
        const averageDaily = totalSales / daysCount;
        const projection = averageDaily * targetPeriod;
        const neededDaily = targetRevenue / targetPeriod;
        const growthNeeded = ((neededDaily - averageDaily) / averageDaily) * 100;
        
        let html = `
            <div style="background: #f5f5f5; padding: 1rem; border-radius: 10px; margin-top: 1rem;">
                <h4>Projeção para ${targetPeriod} dias</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 1rem;">
                    <div>
                        <strong>Média Diária Atual:</strong><br>
                        R$ ${averageDaily.toFixed(2)}
                    </div>
                    <div>
                        <strong>Meta Diária Necessária:</strong><br>
                        R$ ${neededDaily.toFixed(2)}
                    </div>
                    <div>
                        <strong>Crescimento Necessário:</strong><br>
                        ${growthNeeded.toFixed(1)}%
                    </div>
                    <div>
                        <strong>Projeção Atual:</strong><br>
                        R$ ${projection.toFixed(2)}
                    </div>
                </div>
        `;
        
        if (projection >= targetRevenue) {
            html += `<p style="color: var(--success); margin-top: 1rem;">🎯 Meta atingível com o ritmo atual!</p>`;
        } else {
            html += `<p style="color: var(--warning); margin-top: 1rem;">⚠️ Ajustes necessários para atingir a meta.</p>`;
        }
        
        html += `</div>`;
        
        dom.projectionResult.innerHTML = html;
        dom.projectionResult.style.display = 'block';
    }
    
    function setupEventListeners() {
        dom.loginBtn.addEventListener('click', () => {
            const username = dom.usernameInput.value.trim();
            const password = dom.passwordInput.value;
            
            if (!username || !password) {
                showNotification("Preencha todos os campos", "danger");
                return;
            }
            
            if (login(username, password)) {
                // Sucesso
            } else {
                dom.loginError.style.display = 'block';
            }
        });
        
        dom.passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                dom.loginBtn.click();
            }
        });
        
        dom.logoutBtn.addEventListener('click', logout);
        
        dom.tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const sectionId = tab.dataset.tab;
                setActiveSection(sectionId);
            });
        });
        
        dom.themeToggle.addEventListener('click', toggleTheme);
        
        dom.filterButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                dom.filterButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                appState.settings.currentFilter = btn.dataset.filter;
                saveAppData();
                updateDashboard();
            });
        });
        
        dom.productSelect.addEventListener('change', updatePriceFromProduct);
        dom.addProductToSaleBtn.addEventListener('click', addProductToSale);
        dom.registerSaleBtn.addEventListener('click', registerSale);
        dom.clearSaleBtn.addEventListener('click', clearCurrentSale);
        
        dom.addMixedPaymentBtn.addEventListener('click', addMixedPaymentMethod);
        
        dom.savePaymentMethodBtn.addEventListener('click', addPaymentMethod);
        
        dom.addCostBtn.addEventListener('click', addCost);
        
        dom.calculateCMVBtn.addEventListener('click', calculateCMV);
        
        dom.addProductBtn.addEventListener('click', addProduct);
        dom.cancelEditBtn.addEventListener('click', cancelEdit);
        
        dom.saveBusinessInfoBtn.addEventListener('click', () => {
            const name = dom.businessNameInput.value.trim();
            const slogan = dom.businessSloganInput.value.trim();
            
            if (!name) {
                showNotification("Digite o nome do negócio", "danger");
                return;
            }
            
            appState.businessInfo.name = name;
            appState.businessInfo.slogan = slogan;
            saveAppData();
            updateBusinessInfo();
            showNotification("Informações salvas com sucesso!", "success");
        });
        
        dom.photoUpload.addEventListener('click', () => {
            dom.businessPhotoInput.click();
        });
        
        dom.businessPhotoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showNotification("Selecione uma imagem", "danger");
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (event) => {
                appState.businessInfo.logo = event.target.result;
                saveAppData();
                updateBusinessInfo();
                showNotification("Foto atualizada com sucesso!", "success");
            };
            reader.readAsDataURL(file);
        });
        
        dom.colorOptions.forEach(option => {
            option.addEventListener('click', () => {
                appState.businessInfo.themeColor = option.dataset.color;
                saveAppData();
                updateBusinessInfo();
                showNotification("Cor do tema alterada!", "success");
            });
        });
        
        dom.saleSoundsToggle.addEventListener('change', (e) => {
            appState.settings.saleSounds = e.target.checked;
            saveAppData();
        });
        
        dom.stockNotificationsToggle.addEventListener('change', (e) => {
            appState.settings.stockNotifications = e.target.checked;
            saveAppData();
        });
        
        dom.animationsToggle.addEventListener('change', (e) => {
            appState.settings.animations = e.target.checked;
            saveAppData();
        });
        
        dom.goalNotificationsToggle.addEventListener('change', (e) => {
            goalState.settings.notifications = e.target.checked;
            saveGoalData();
        });
        
        dom.backupDataBtn.addEventListener('click', () => {
            const backup = {
                businessInfo: appState.businessInfo,
                products: appState.products,
                sales: appState.sales,
                paymentMethods: appState.paymentMethods,
                costs: appState.costs,
                cmv: appState.cmv,
                settings: appState.settings,
                users: appState.users,
                goalData: goalState,
                backupDate: new Date().toISOString()
            };
            
            const backupStr = JSON.stringify(backup, null, 2);
            downloadFile(backupStr, `praiaVendas-backup-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
            showNotification("Backup criado com sucesso!", "success");
        });
        
        dom.restoreDataBtn.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const backup = JSON.parse(event.target.result);
                        
                        if (confirm("Tem certeza que deseja restaurar este backup? Todos os dados atuais serão substituídos.")) {
                            appState.businessInfo = backup.businessInfo || appState.businessInfo;
                            appState.products = backup.products || [];
                            appState.sales = backup.sales || [];
                            appState.paymentMethods = backup.paymentMethods || appState.paymentMethods;
                            appState.costs = backup.costs || [];
                            appState.cmv = backup.cmv || appState.cmv;
                            appState.settings = backup.settings || appState.settings;
                            appState.users = backup.users || appState.users;
                            
                            if (backup.goalData) {
                                goalState = backup.goalData;
                            }
                            
                            saveAppData();
                            saveGoalData();
                            updateBusinessInfo();
                            loadProducts();
                            loadPaymentMethods();
                            loadCosts();
                            updateDashboard();
                            updateGoalDisplay();
                            updateRecentSales();
                            updateProfitPieChart();
                            updateFinancePieChart();
                            
                            showNotification("Backup restaurado com sucesso!", "success");
                        }
                    } catch (err) {
                        showNotification("Erro ao ler arquivo de backup", "danger");
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        });
        
        dom.resetDataBtn.addEventListener('click', () => {
            if (confirm("Tem certeza que deseja limpar TODOS os dados? Esta ação não pode ser desfeita.")) {
                localStorage.clear();
                location.reload();
            }
        });
        
        dom.exportSalesBtn.addEventListener('click', () => exportData('sales'));
        dom.exportProductsBtn.addEventListener('click', () => exportData('products'));
        dom.exportFinanceBtn.addEventListener('click', () => exportData('finance'));
        
        dom.calculateProjectionBtn.addEventListener('click', calculateProjection);
        
        dom.acceptCookies.addEventListener('click', () => {
            localStorage.setItem(DATA_KEYS.COOKIE_CONSENT, 'true');
            dom.cookieModal.classList.remove('show');
        });
    }
    
    function setActiveSection(sectionId) {
        dom.tabs.forEach(tab => {
            tab.classList.toggle('active', tab.dataset.tab === sectionId);
        });
        
        dom.sections.forEach(section => {
            section.classList.toggle('active', section.id === sectionId);
        });
        
        appState.currentSection = sectionId;
        
        if (sectionId === 'dashboard') {
            updateDashboard();
            updateGoalDisplay();
        } else if (sectionId === 'goals') {
            updateGoalDisplay();
        } else if (sectionId === 'sales') {
            loadProducts();
            updateRecentSales();
        } else if (sectionId === 'payment-methods') {
            loadPaymentMethods();
        } else if (sectionId === 'costs') {
            loadCosts();
            dom.initialStock.value = appState.cmv.initialStock;
            dom.purchases.value = appState.cmv.purchases;
            dom.finalStock.value = appState.cmv.finalStock;
            if (appState.cmv.calculatedCMV > 0) {
                dom.cmvResultValue.textContent = appState.cmv.calculatedCMV.toFixed(2);
                dom.cmvResult.style.display = 'block';
            }
        } else if (sectionId === 'products') {
            loadProducts();
        } else if (sectionId === 'finance') {
            updateFinanceChart();
        }
    }
    
    window.addMixedPaymentMethod = addMixedPaymentMethod;
    window.removeMixedPaymentMethod = removeMixedPaymentMethod;
    window.updateMixedPaymentAmount = updateMixedPaymentAmount;
    window.updateMixedPaymentMethod = updateMixedPaymentMethod;
    window.showGoalModal = showGoalModal;
    window.hideGoalModal = hideGoalModal;
    window.saveDailyGoal = saveDailyGoal;
    window.setDailyGoal = setDailyGoal;
    window.showProductModal = showProductModal;
    window.hideProductModal = hideProductModal;
    window.saveGoalProduct = saveGoalProduct;
    window.editGoalProduct = editGoalProduct;
    window.deleteGoalProduct = deleteGoalProduct;
    window.updateGoalDisplay = updateGoalDisplay;
    window.showEditProductModal = showEditProductModal;
    window.showDeleteProductModal = showDeleteProductModal;
    window.hideDeleteProductModal = hideDeleteProductModal;
    window.confirmDeleteProduct = confirmDeleteProduct;
    window.cancelEdit = cancelEdit;
    window.updatePriceFromProduct = updatePriceFromProduct;
    window.addProductToSale = addProductToSale;
    window.removeProductFromSale = removeProductFromSale;
    window.clearCurrentSale = clearCurrentSale;
    window.registerSale = registerSale;
    window.exportGoalHistory = exportGoalHistory;
    window.clearGoalHistory = clearGoalHistory;
    
    document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>

index1:<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PraiaVendas Pro | Gestão Inteligente para Vendedores</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #FF6B35;
            --primary-gradient: linear-gradient(135deg, #FF6B35 0%, #FF8E53 100%);
            --primary-light: #FF8E53;
            --primary-dark: #E55A2B;
            --secondary: #4ECDC4;
            --secondary-light: #6FE7DF;
            --success: #00C851;
            --success-light: #5DFC7B;
            --success-dark: #00A843;
            --danger: #FF4444;
            --danger-light: #FF6B6B;
            --warning: #FFBB33;
            --warning-light: #FFD166;
            --info: #33B5E5;
            --dark: #2D3047;
            --light: #FFFFFF;
            --gray-50: #FAFAFA;
            --gray-100: #F5F5F5;
            --gray-200: #EEEEEE;
            --gray-300: #E0E0E0;
            --gray-400: #BDBDBD;
            --gray-500: #9E9E9E;
            --gray-600: #757575;
            --gray-700: #616161;
            --gray-800: #424242;
            --gray-900: #212121;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --card-shadow-hover: 0 12px 32px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --border-radius-lg: 24px;
            --border-radius-md: 16px;
            --border-radius-sm: 12px;
            --border-radius-xs: 8px;
            --text-gradient: linear-gradient(135deg, #FF6B35 0%, #4ECDC4 100%);
        }

        [data-theme="dark"] {
            --primary: #FF8E53;
            --primary-gradient: linear-gradient(135deg, #FF8E53 0%, #FF6B35 100%);
            --primary-light: #FFA97C;
            --primary-dark: #E55A2B;
            --secondary: #6FE7DF;
            --secondary-light: #8BF3EC;
            --success: #5DFC7B;
            --success-light: #7EFF95;
            --danger: #FF6B6B;
            --danger-light: #FF8A8A;
            --warning: #FFD166;
            --warning-light: #FFDF8E;
            --info: #66D9FF;
            --dark: #FFFFFF;
            --light: #121212;
            --gray-50: #1E1E1E;
            --gray-100: #252525;
            --gray-200: #2D2D2D;
            --gray-300: #3D3D3D;
            --gray-400: #5D5D5D;
            --gray-500: #7D7D7D;
            --gray-600: #9D9D9D;
            --gray-700: #BDBDBD;
            --gray-800: #D0D0D0;
            --gray-900: #E8E8E8;
            --glass-bg: rgba(30, 30, 30, 0.2);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            --card-shadow-hover: 0 12px 32px rgba(0, 0, 0, 0.35);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background: var(--light);
            color: var(--dark);
            min-height: 100vh;
            line-height: 1.6;
            transition: var(--transition);
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        [data-theme="dark"] body {
            background: #0A0A0A;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.9), rgba(78, 205, 196, 0.9)),
                        url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 10000;
            backdrop-filter: blur(10px);
        }

        .login-box {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 3rem 2.5rem;
            width: 100%;
            max-width: 440px;
            box-shadow: var(--glass-shadow);
            animation: slideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .business-logo {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 2rem;
            display: block;
            border: 4px solid white;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .business-name {
            text-align: center;
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, #FFFFFF 0%, #FFE8D6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-input-container {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .login-input {
            width: 100%;
            padding: 16px 20px 16px 52px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            color: white;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .login-input:focus {
            outline: none;
            border-color: white;
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
        }

        .login-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .login-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.2rem;
        }

        .login-btn {
            width: 100%;
            padding: 18px;
            background: white;
            color: var(--primary);
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            letter-spacing: 0.5px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        /* Valor de compra fixo no topo */
        .purchase-value-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--primary-gradient);
            color: white;
            padding: 12px 20px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 700;
            z-index: 9998;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .purchase-value-overlay.show {
            transform: translateY(0);
        }

        /* Header Moderno */
        header {
            background: var(--primary-gradient);
            color: white;
            padding: 1rem 1rem 0.5rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .business-header {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .business-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .business-info h1 {
            font-size: 1.4rem;
            font-weight: 800;
            line-height: 1.2;
            margin-bottom: 4px;
        }

        .business-info span {
            font-size: 0.9rem;
            opacity: 0.95;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .header-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 1.2rem;
            backdrop-filter: blur(10px);
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px) scale(1.05);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .header-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .tabs-container {
            width: 100%;
            overflow-x: auto;
            padding-bottom: 8px;
            scrollbar-width: none;
        }

        .tabs-container::-webkit-scrollbar {
            display: none;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 100px;
            padding: 6px;
            min-width: max-content;
            backdrop-filter: blur(10px);
        }

        .tab {
            flex: 1;
            min-width: 90px;
            text-align: center;
            padding: 10px 12px;
            border-radius: 100px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: rgba(255, 255, 255, 0.9);
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        .tab.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Main Container */
        .container {
            padding: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .section {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .section.active {
            display: block;
        }

        /* Dashboard - Moderno */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: var(--light);
            border-radius: var(--border-radius-md);
            padding: 1.8rem;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            border: 1px solid var(--gray-200);
            position: relative;
            overflow: hidden;
        }

        [data-theme="dark"] .dashboard-card {
            background: var(--gray-100);
            border-color: var(--gray-200);
        }

        .dashboard-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--card-shadow-hover);
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
            border-radius: var(--border-radius-md) var(--border-radius-md) 0 0;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.2rem;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-value {
            font-size: 2.2rem;
            font-weight: 800;
            margin: 0.5rem 0;
            background: var(--text-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }

        .card-subtitle {
            font-size: 0.9rem;
            color: var(--gray-600);
            margin-top: 0.5rem;
        }

        .card-trend {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 100px;
            background: var(--success-light);
            color: var(--success-dark);
        }

        .card-trend.down {
            background: rgba(255, 68, 68, 0.1);
            color: var(--danger);
        }

        /* Charts Container */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .chart-card {
            background: var(--light);
            border-radius: var(--border-radius-md);
            padding: 1.8rem;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            border: 1px solid var(--gray-200);
            height: 380px;
            display: flex;
            flex-direction: column;
        }

        [data-theme="dark"] .chart-card {
            background: var(--gray-100);
            border-color: var(--gray-200);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            flex: 1;
            position: relative;
            min-height: 300px;
        }

        /* Sales Section */
        .sale-form-card {
            background: var(--light);
            border-radius: var(--border-radius-md);
            padding: 2rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
            border: 1px solid var(--gray-200);
        }

        [data-theme="dark"] .sale-form-card {
            background: var(--gray-100);
            border-color: var(--gray-200);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.95rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            background: var(--light);
            border: 2px solid var(--gray-300);
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            color: var(--dark);
            transition: var(--transition);
        }

        [data-theme="dark"] .form-input,
        [data-theme="dark"] .form-select {
            background: var(--gray-50);
            border-color: var(--gray-300);
            color: var(--dark);
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .sale-products-container {
            margin: 30px 0;
        }

        .products-list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid var(--gray-200);
            border-radius: var(--border-radius-sm);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background: var(--light);
        }

        [data-theme="dark"] .products-list {
            background: var(--gray-50);
            border-color: var(--gray-300);
        }

        .product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
            transition: var(--transition);
            border-radius: var(--border-radius-xs);
        }

        .product-item:hover {
            background: var(--gray-50);
        }

        .product-info h4 {
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--gray-800);
        }

        .product-details {
            font-size: 0.9rem;
            color: var(--gray-600);
        }

        .product-total {
            font-weight: 700;
            color: var(--success);
            font-size: 1.1rem;
            margin-right: 15px;
        }

        .remove-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--danger);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .remove-btn:hover {
            background: var(--danger-light);
            transform: scale(1.1);
        }

        /* Payment Methods */
        .mixed-payment-container {
            margin: 30px 0;
        }

        .payment-item {
            background: var(--gray-50);
            border-radius: var(--border-radius-sm);
            padding: 1.2rem;
            margin-bottom: 15px;
            border: 2px solid var(--gray-200);
            transition: var(--transition);
        }

        .payment-item:hover {
            border-color: var(--primary);
            transform: translateX(4px);
        }

        .payment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .payment-select {
            flex: 1;
            max-width: 200px;
            padding: 10px 14px;
            border: 2px solid var(--gray-300);
            border-radius: var(--border-radius-xs);
            background: var(--light);
            color: var(--dark);
            font-weight: 600;
        }

        .payment-amount {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .payment-amount input {
            width: 150px;
            padding: 10px 14px;
            border: 2px solid var(--gray-300);
            border-radius: var(--border-radius-xs);
            font-size: 1rem;
            font-weight: 600;
        }

        .payment-summary {
            background: var(--success-light);
            border-radius: var(--border-radius-sm);
            padding: 1.5rem;
            margin-top: 25px;
            border: 2px solid var(--success);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 1.1rem;
        }

        .summary-total {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--success-dark);
            margin-top: 10px;
            padding-top: 15px;
            border-top: 3px double var(--success);
        }

        /* Buttons */
        .btn {
            padding: 14px 28px;
            border-radius: var(--border-radius-sm);
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            letter-spacing: 0.3px;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4);
        }

        .btn-success {
            background: var(--success);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 200, 81, 0.3);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 68, 68, 0.3);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        }

        .btn-lg {
            padding: 16px 32px;
            font-size: 1.1rem;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        /* History Section */
        .history-table-container {
            background: var(--light);
            border-radius: var(--border-radius-md);
            padding: 2rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
            border: 1px solid var(--gray-200);
            overflow-x: auto;
        }

        [data-theme="dark"] .history-table-container {
            background: var(--gray-100);
            border-color: var(--gray-200);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .data-table th {
            background: var(--gray-50);
            padding: 16px 20px;
            text-align: left;
            font-weight: 700;
            color: var(--gray-700);
            border-bottom: 3px solid var(--gray-200);
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        [data-theme="dark"] .data-table th {
            background: var(--gray-200);
            color: var(--gray-800);
        }

        .data-table td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-200);
            color: var(--gray-700);
        }

        .data-table tr:hover {
            background: var(--gray-50);
        }

        .table-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            color: white;
        }

        .action-btn.delete {
            background: var(--danger);
        }

        .action-btn.edit {
            background: var(--info);
        }

        .action-btn.download {
            background: var(--success);
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--light);
            border-radius: var(--border-radius-lg);
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: var(--transition);
            border: 1px solid var(--gray-200);
        }

        [data-theme="dark"] .modal-content {
            background: var(--gray-100);
            border-color: var(--gray-200);
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-close {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--gray-100);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            color: var(--gray-600);
        }

        .modal-close:hover {
            background: var(--gray-200);
            transform: rotate(90deg);
        }

        /* Notifications */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }

        .notification {
            background: var(--light);
            border-radius: var(--border-radius-md);
            padding: 1.2rem 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateX(400px);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border-left: 5px solid var(--success);
        }

        [data-theme="dark"] .notification {
            background: var(--gray-100);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-success {
            border-left-color: var(--success);
        }

        .notification-error {
            border-left-color: var(--danger);
        }

        .notification-warning {
            border-left-color: var(--warning);
        }

        .notification-info {
            border-left-color: var(--info);
        }

        .notification-icon {
            font-size: 1.8rem;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--gray-800);
        }

        .notification-message {
            font-size: 0.95rem;
            color: var(--gray-600);
            line-height: 1.4;
        }

        /* Sale Animation */
        .sale-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 8rem;
            z-index: 9999;
            pointer-events: none;
            opacity: 0;
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.5s;
            filter: drop-shadow(0 0 20px rgba(255, 107, 53, 0.5));
        }

        .sale-animation.show {
            transform: translate(-50%, -50%) scale(1.5);
            opacity: 1;
        }

        /* Hide Values Toggle */
        .hide-values-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }

        .hide-values-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-gradient);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hide-values-btn:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 12px 35px rgba(255, 107, 53, 0.6);
        }

        /* Settings Links */
        .settings-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .link-card {
            background: var(--light);
            border-radius: var(--border-radius-md);
            padding: 2rem;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            border: 1px solid var(--gray-200);
            text-align: center;
            text-decoration: none;
            color: inherit;
        }

        [data-theme="dark"] .link-card {
            background: var(--gray-100);
            border-color: var(--gray-200);
        }

        .link-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--card-shadow-hover);
            border-color: var(--primary);
        }

        .link-icon {
            font-size: 3rem;
            margin-bottom: 1.5rem;
            color: var(--primary);
        }

        .link-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.8rem;
            color: var(--gray-800);
        }

        .link-description {
            color: var(--gray-600);
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .container {
                padding: 1rem;
            }
            
            .dashboard-grid {
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .login-box {
                padding: 2rem 1.5rem;
            }
            
            .business-logo {
                width: 100px;
                height: 100px;
            }
            
            .business-name {
                font-size: 1.8rem;
            }
            
            .header-top {
                flex-direction: column;
                gap: 15px;
            }
            
            .business-header {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .tabs {
                padding: 4px;
            }
            
            .tab {
                min-width: 70px;
                font-size: 0.8rem;
                padding: 8px 10px;
            }
            
            .dashboard-card {
                padding: 1.5rem;
            }
            
            .card-value {
                font-size: 1.8rem;
            }
            
            .modal-content {
                padding: 2rem 1.5rem;
            }
            
            .hide-values-container {
                bottom: 20px;
                right: 20px;
            }
            
            .hide-values-btn {
                width: 50px;
                height: 50px;
                font-size: 1.3rem;
            }
        }

        @media (max-width: 480px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .payment-amount {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .payment-amount input {
                width: 100%;
            }
            
            .table-actions {
                flex-direction: column;
            }
            
            .notification-container {
                left: 20px;
                right: 20px;
                max-width: none;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* Utility Classes */
        .text-gradient {
            background: var(--text-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .glass-effect {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray-500);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            opacity: 0.5;
        }

        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid var(--gray-300);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Discount Badge */
        .discount-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: white;
            padding: 4px 10px;
            border-radius: 100px;
            font-size: 0.8rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(255, 68, 68, 0.3);
            z-index: 1;
        }

        /* Print Styles */
        @media print {
            header, .hide-values-container, .tabs-container {
                display: none !important;
            }
            
            .container {
                padding: 0;
            }
            
            .section {
                display: block !important;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <img id="businessLogo" class="business-logo" src="" alt="Logo do Negócio">
            <h1 id="businessNameLogin" class="business-name">PraiaVendas Pro</h1>
            
            <div class="login-input-container">
                <i class="fas fa-user login-icon"></i>
                <input type="text" id="usernameInput" class="login-input" placeholder="Usuário" autocomplete="username">
            </div>
            
            <div class="login-input-container">
                <i class="fas fa-lock login-icon"></i>
                <input type="password" id="passwordInput" class="login-input" placeholder="Senha" autocomplete="current-password">
            </div>
            
            <button id="loginBtn" class="login-btn">
                <i class="fas fa-sign-in-alt"></i> Entrar no Sistema
            </button>
        </div>
    </div>

    <!-- Valor de Compra Fixo -->
    <div id="purchaseValueOverlay" class="purchase-value-overlay">
        <i class="fas fa-shopping-cart"></i>
        <span id="currentPurchaseValue">Valor da compra: R$ 0,00</span>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <header>
            <div class="header-content">
                <div class="header-top">
                    <div class="business-header">
                        <img id="businessAvatar" class="business-avatar" src="" alt="Avatar">
                        <div class="business-info">
                            <h1 id="businessNameHeader">PraiaVendas Pro</h1>
                            <span id="businessSlogan">Sistema Inteligente de Vendas</span>
                        </div>
                    </div>
                    
                    <div class="header-actions">
                        <button class="header-btn" id="notificationToggle" title="Notificações">
                            <i class="fas fa-bell"></i>
                        </button>
                        <button class="header-btn" id="themeToggle" title="Alternar Tema">
                            <i class="fas fa-moon"></i>
                        </button>
                        <button class="header-btn" id="hideValuesToggle" title="Ocultar Valores">
                            <i class="fas fa-eye-slash"></i>
                        </button>
                        <button class="header-btn" id="logoutBtn" title="Sair">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
                
                <div class="tabs-container">
                    <div class="tabs">
                        <div class="tab active" data-tab="dashboard">
                            <i class="fas fa-home"></i> Dashboard
                        </div>
                        <div class="tab" data-tab="sales">
                            <i class="fas fa-cash-register"></i> Vendas
                        </div>
                        <div class="tab" data-tab="history">
                            <i class="fas fa-history"></i> Histórico
                        </div>
                        <div class="tab" data-tab="products">
                            <i class="fas fa-box"></i> Produtos
                        </div>
                        <div class="tab" data-tab="finance">
                            <i class="fas fa-chart-line"></i> Financeiro
                        </div>
                        <div class="tab" data-tab="settings">
                            <i class="fas fa-cog"></i> Configurações
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="container">
            <!-- Dashboard -->
            <section id="dashboard" class="section active">
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-money-bill-wave"></i>
                                Vendas Hoje
                            </h3>
                            <span class="card-trend up">+12%</span>
                        </div>
                        <div class="card-value" data-hide-value="true">R$ 2.850,00</div>
                        <p class="card-subtitle">15 vendas realizadas</p>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-chart-line"></i>
                                Lucro Líquido
                            </h3>
                            <span class="card-trend up">+8%</span>
                        </div>
                        <div class="card-value" data-hide-value="true">R$ 1.420,50</div>
                        <p class="card-subtitle">Margem de 49.8%</p>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-bullseye"></i>
                                Meta Diária
                            </h3>
                            <span class="card-trend up">85%</span>
                        </div>
                        <div class="card-value" data-hide-value="true">R$ 1.700,00</div>
                        <p class="card-subtitle">Falta R$ 300,00</p>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-box-open"></i>
                                Estoque Baixo
                            </h3>
                            <span class="card-trend down">3 itens</span>
                        </div>
                        <div class="card-value">3</div>
                        <p class="card-subtitle">Necessita reposição</p>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">
                                <i class="fas fa-chart-bar"></i>
                                Vendas por Período
                            </h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">
                                <i class="fas fa-chart-pie"></i>
                                Distribuição de Vendas
                            </h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="distributionChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">
                                <i class="fas fa-wallet"></i>
                                Métodos de Pagamento
                            </h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="paymentChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">
                                <i class="fas fa-trending-up"></i>
                                Evolução Mensal
                            </h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Vendas -->
            <section id="sales" class="section">
                <div class="sale-form-card">
                    <h2 style="margin-bottom: 1.5rem; color: var(--gray-800);">
                        <i class="fas fa-cash-register"></i> Nova Venda
                    </h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Produto</label>
                            <select id="productSelect" class="form-select">
                                <option value="">Selecione um produto</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Quantidade</label>
                            <input type="number" id="quantityInput" class="form-input" min="1" value="1">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Preço Unitário (R$)</label>
                            <input type="number" id="priceInput" class="form-input" min="0.01" step="0.01" placeholder="0,00">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Desconto (R$)</label>
                            <input type="number" id="discountInput" class="form-input" min="0" step="0.01" placeholder="0,00" value="0">
                        </div>
                    </div>
                    
                    <button id="addProductBtn" class="btn btn-success" style="margin-top: 10px;">
                        <i class="fas fa-plus"></i> Adicionar Produto
                    </button>
                </div>

                <div class="sale-form-card">
                    <div class="sale-products-container">
                        <h3 style="margin-bottom: 1.5rem; color: var(--gray-800);">
                            <i class="fas fa-shopping-cart"></i> Produtos na Venda
                        </h3>
                        
                        <div id="productsList" class="products-list">
                            <div class="empty-state">
                                <i class="fas fa-shopping-cart"></i>
                                <p>Nenhum produto adicionado à venda</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mixed-payment-container">
                        <h3 style="margin-bottom: 1.5rem; color: var(--gray-800);">
                            <i class="fas fa-credit-card"></i> Pagamento
                        </h3>
                        
                        <div id="paymentMethodsContainer">
                            <div class="payment-item">
                                <div class="payment-header">
                                    <select class="payment-select" onchange="updatePaymentMethod(0, this.value)">
                                        <option value="cash">Dinheiro</option>
                                        <option value="pix">Pix</option>
                                        <option value="credit">Cartão Crédito</option>
                                        <option value="debit">Cartão Débito</option>
                                    </select>
                                    <button onclick="removePaymentMethod(0)" class="btn btn-danger btn-sm">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="payment-amount">
                                    <span>R$</span>
                                    <input type="number" min="0" step="0.01" placeholder="0,00" 
                                           onchange="updatePaymentAmount(0, this.value)"
                                           oninput="updatePaymentAmount(0, this.value)">
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="addPaymentMethod()" class="btn btn-secondary" style="margin-top: 15px;">
                            <i class="fas fa-plus"></i> Adicionar Forma de Pagamento
                        </button>
                    </div>
                    
                    <div class="payment-summary">
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span id="subtotalValue" data-hide-value="true">R$ 0,00</span>
                        </div>
                        <div class="summary-row">
                            <span>Descontos:</span>
                            <span id="discountValue" data-hide-value="true">R$ 0,00</span>
                        </div>
                        <div class="summary-row">
                            <span>Total:</span>
                            <span id="totalValue" data-hide-value="true">R$ 0,00</span>
                        </div>
                        <div class="summary-row">
                            <span>Total Pago:</span>
                            <span id="paidValue" data-hide-value="true">R$ 0,00</span>
                        </div>
                        <div class="summary-row summary-total">
                            <span>Restante/Troco:</span>
                            <span id="remainingValue" data-hide-value="true">R$ 0,00</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button id="registerSaleBtn" class="btn btn-primary btn-lg" disabled>
                            <i class="fas fa-check"></i> Finalizar Venda
                        </button>
                        <button id="clearSaleBtn" class="btn btn-danger btn-lg">
                            <i class="fas fa-times"></i> Cancelar Venda
                        </button>
                    </div>
                </div>
            </section>

            <!-- Histórico -->
            <section id="history" class="section">
                <div class="sale-form-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="color: var(--gray-800);">
                            <i class="fas fa-history"></i> Histórico de Vendas
                        </h2>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="exportHistoryPDF()" class="btn btn-success">
                                <i class="fas fa-file-pdf"></i> Exportar PDF
                            </button>
                            <button onclick="clearHistory()" class="btn btn-danger">
                                <i class="fas fa-trash"></i> Limpar Histórico
                            </button>
                        </div>
                    </div>
                    
                    <div class="history-table-container">
                        <table class="data-table" id="historyTable">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Produtos</th>
                                    <th>Quantidade</th>
                                    <th>Total</th>
                                    <th>Pagamento</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- Histórico será carregado aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Produtos -->
            <section id="products" class="section">
                <div class="sale-form-card">
                    <h2 style="margin-bottom: 1.5rem; color: var(--gray-800);">
                        <i class="fas fa-box"></i> Gerenciar Produtos
                    </h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Nome do Produto</label>
                            <input type="text" id="productNameInput" class="form-input" placeholder="Ex: Água de Coco">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Categoria</label>
                            <select id="productCategoryInput" class="form-select">
                                <option value="bebidas">Bebidas</option>
                                <option value="comidas">Comidas</option>
                                <option value="sobremesas">Sobremesas</option>
                                <option value="acessorios">Acessórios</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Preço de Venda (R$)</label>
                            <input type="number" id="productPriceInput" class="form-input" min="0.01" step="0.01" placeholder="0,00">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Custo (R$)</label>
                            <input type="number" id="productCostInput" class="form-input" min="0" step="0.01" placeholder="0,00">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Estoque</label>
                            <input type="number" id="productStockInput" class="form-input" min="0" value="0">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Estoque Mínimo</label>
                            <input type="number" id="productMinStockInput" class="form-input" min="0" value="5">
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-top: 25px;">
                        <button id="saveProductBtn" class="btn btn-primary btn-lg">
                            <i class="fas fa-save"></i> Salvar Produto
                        </button>
                        <button id="clearProductBtn" class="btn btn-secondary btn-lg">
                            <i class="fas fa-times"></i> Limpar
                        </button>
                    </div>
                </div>
                
                <div class="sale-form-card" style="margin-top: 30px;">
                    <h3 style="margin-bottom: 1.5rem; color: var(--gray-800);">
                        <i class="fas fa-boxes"></i> Lista de Produtos
                    </h3>
                    
                    <div class="history-table-container">
                        <table class="data-table" id="productsTable">
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Categoria</th>
                                    <th>Preço</th>
                                    <th>Custo</th>
                                    <th>Estoque</th>
                                    <th>Lucro</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <!-- Produtos serão carregados aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Financeiro -->
            <section id="finance" class="section">
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-money-bill"></i>
                                Faturamento Mensal
                            </h3>
                        </div>
                        <div class="card-value" data-hide-value="true">R$ 45.820,00</div>
                        <p class="card-subtitle">+15% vs mês anterior</p>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-coins"></i>
                                Lucro Mensal
                            </h3>
                        </div>
                        <div class="card-value" data-hide-value="true">R$ 22.910,00</div>
                        <p class="card-subtitle">Margem de 50%</p>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-chart-pie"></i>
                                CMV Mensal
                            </h3>
                        </div>
                        <div class="card-value" data-hide-value="true">R$ 18.328,00</div>
                        <p class="card-subtitle">40% do faturamento</p>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-percentage"></i>
                                Taxas/Custos
                            </h3>
                        </div>
                        <div class="card-value" data-hide-value="true">R$ 4.582,00</div>
                        <p class="card-subtitle">10% do faturamento</p>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">
                                <i class="fas fa-chart-line"></i>
                                Evolução Financeira
                            </h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="financeChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">
                                <i class="fas fa-chart-bar"></i>
                                Distribuição de Custos
                            </h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="costsChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Configurações -->
            <section id="settings" class="section">
                <div class="sale-form-card">
                    <h2 style="margin-bottom: 2rem; color: var(--gray-800);">
                        <i class="fas fa-cog"></i> Configurações do Sistema
                    </h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Nome do Negócio</label>
                            <input type="text" id="businessNameInput" class="form-input" placeholder="Nome do seu negócio">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Slogan/Descrição</label>
                            <input type="text" id="businessSloganInput" class="form-input" placeholder="Ex: As melhores águas de coco!">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Cor Primária</label>
                            <input type="color" id="primaryColorInput" class="form-input" style="height: 50px; padding: 5px;">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Cor Secundária</label>
                            <input type="color" id="secondaryColorInput" class="form-input" style="height: 50px; padding: 5px;">
                        </div>
                    </div>
                    
                    <div style="margin: 30px 0; padding: 20px; background: var(--gray-50); border-radius: var(--border-radius-sm);">
                        <h3 style="margin-bottom: 1rem; color: var(--gray-800);">
                            <i class="fas fa-bell"></i> Notificações
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="notificationsToggle" checked style="width: 20px; height: 20px;">
                                <span>Notificações de venda</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="soundsToggle" checked style="width: 20px; height: 20px;">
                                <span>Sons de venda</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="stockAlertsToggle" checked style="width: 20px; height: 20px;">
                                <span>Alertas de estoque baixo</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-links">
                        <a href="https://seusite.com/criador" target="_blank" class="link-card">
                            <div class="link-icon">
                                <i class="fas fa-code"></i>
                            </div>
                            <h3 class="link-title">Criador do Software</h3>
                            <p class="link-description">Conheça o desenvolvedor e veja outros projetos</p>
                        </a>
                        
                        <a href="https://seusite.com/pagamento" target="_blank" class="link-card">
                            <div class="link-icon">
                                <i class="fas fa-donate"></i>
                            </div>
                            <h3 class="link-title">Apoie o Projeto</h3>
                            <p class="link-description">Faça uma doação para ajudar no desenvolvimento</p>
                        </a>
                        
                        <a href="javascript:void(0)" onclick="exportBackup()" class="link-card">
                            <div class="link-icon">
                                <i class="fas fa-download"></i>
                            </div>
                            <h3 class="link-title">Backup de Dados</h3>
                            <p class="link-description">Exporte todos os dados do sistema</p>
                        </a>
                        
                        <a href="javascript:void(0)" onclick="importBackup()" class="link-card">
                            <div class="link-icon">
                                <i class="fas fa-upload"></i>
                            </div>
                            <h3 class="link-title">Restaurar Dados</h3>
                            <p class="link-description">Importe dados de backup anterior</p>
                        </a>
                    </div>
                    
                    <button onclick="saveSettings()" class="btn btn-primary btn-lg" style="margin-top: 30px;">
                        <i class="fas fa-save"></i> Salvar Configurações
                    </button>
                </div>
            </section>
        </div>
        
        <!-- Botão para ocultar/mostrar valores -->
        <div class="hide-values-container">
            <button id="hideValuesBtn" class="hide-values-btn">
                <i class="fas fa-eye"></i>
            </button>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    Confirmação
                </h3>
                <button class="modal-close" onclick="hideModal('confirmModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="margin: 2rem 0;">
                <p id="confirmMessage" style="font-size: 1.1rem; color: var(--gray-700);"></p>
            </div>
            <div style="display: flex; gap: 15px; justify-content: flex-end;">
                <button onclick="hideModal('confirmModal')" class="btn btn-secondary">
                    Cancelar
                </button>
                <button onclick="confirmAction()" class="btn btn-danger" id="confirmActionBtn">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes da Venda -->
    <div id="saleDetailsModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-receipt"></i>
                    Detalhes da Venda
                </h3>
                <button class="modal-close" onclick="hideModal('saleDetailsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="margin: 2rem 0;">
                <div id="saleDetailsContent"></div>
            </div>
            <div style="display: flex; gap: 15px; justify-content: flex-end;">
                <button onclick="printSaleDetails()" class="btn btn-secondary">
                    <i class="fas fa-print"></i> Imprimir
                </button>
                <button onclick="hideModal('saleDetailsModal')" class="btn btn-primary">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Container de Notificações -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Animação de Venda -->
    <div class="sale-animation" id="saleAnimation">
        <i class="fas fa-check-circle"></i>
    </div>

<script>
// ============================================
// SISTEMA COMPLETO PRAIAVENDAS PRO
// ============================================

// Constantes do sistema
const APP_NAME = "PraiaVendas Pro";
const DATA_KEYS = {
    USERS: 'praiaVendasPro_users',
    BUSINESS_INFO: 'praiaVendasPro_businessInfo',
    PRODUCTS: 'praiaVendasPro_products',
    SALES: 'praiaVendasPro_sales',
    SETTINGS: 'praiaVendasPro_settings',
    SESSION: 'praiaVendasPro_session',
    LAST_BACKUP: 'praiaVendasPro_lastBackup'
};

// Estado principal do aplicativo
const appState = {
    currentUser: null,
    businessInfo: {
        name: "PraiaVendas Pro",
        slogan: "Sistema Inteligente de Vendas",
        logo: "",
        primaryColor: "#FF6B35",
        secondaryColor: "#4ECDC4"
    },
    products: [
        {
            id: 1,
            name: "Água de Coco",
            category: "bebidas",
            price: 8.00,
            cost: 2.50,
            stock: 50,
            minStock: 10,
            createdAt: new Date().toISOString()
        },
        {
            id: 2,
            name: "Sorvete",
            category: "sobremesas",
            price: 6.00,
            cost: 2.00,
            stock: 30,
            minStock: 5,
            createdAt: new Date().toISOString()
        },
        {
            id: 3,
            name: "Cerveja",
            category: "bebidas",
            price: 10.00,
            cost: 4.00,
            stock: 100,
            minStock: 20,
            createdAt: new Date().toISOString()
        },
        {
            id: 4,
            name: "Petisco",
            category: "comidas",
            price: 15.00,
            cost: 6.00,
            stock: 25,
            minStock: 5,
            createdAt: new Date().toISOString()
        }
    ],
    sales: [],
    settings: {
        darkMode: false,
        notifications: true,
        sounds: true,
        stockAlerts: true,
        hideValues: false,
        currentSection: 'dashboard'
    },
    currentSale: {
        products: [],
        subtotal: 0,
        discount: 0,
        total: 0,
        payments: [
            { method: 'cash', amount: 0 }
        ]
    },
    pendingAction: null
};

// Elementos DOM
const dom = {
    // Login
    loginScreen: document.getElementById('loginScreen'),
    mainApp: document.getElementById('mainApp'),
    businessLogo: document.getElementById('businessLogo'),
    businessNameLogin: document.getElementById('businessNameLogin'),
    usernameInput: document.getElementById('usernameInput'),
    passwordInput: document.getElementById('passwordInput'),
    loginBtn: document.getElementById('loginBtn'),
    
    // Header
    businessAvatar: document.getElementById('businessAvatar'),
    businessNameHeader: document.getElementById('businessNameHeader'),
    businessSlogan: document.getElementById('businessSlogan'),
    notificationToggle: document.getElementById('notificationToggle'),
    themeToggle: document.getElementById('themeToggle'),
    hideValuesToggle: document.getElementById('hideValuesToggle'),
    logoutBtn: document.getElementById('logoutBtn'),
    tabs: document.querySelectorAll('.tab'),
    
    // Dashboard
    purchaseValueOverlay: document.getElementById('purchaseValueOverlay'),
    currentPurchaseValue: document.getElementById('currentPurchaseValue'),
    
    // Sales
    productSelect: document.getElementById('productSelect'),
    quantityInput: document.getElementById('quantityInput'),
    priceInput: document.getElementById('priceInput'),
    discountInput: document.getElementById('discountInput'),
    addProductBtn: document.getElementById('addProductBtn'),
    productsList: document.getElementById('productsList'),
    paymentMethodsContainer: document.getElementById('paymentMethodsContainer'),
    subtotalValue: document.getElementById('subtotalValue'),
    discountValue: document.getElementById('discountValue'),
    totalValue: document.getElementById('totalValue'),
    paidValue: document.getElementById('paidValue'),
    remainingValue: document.getElementById('remainingValue'),
    registerSaleBtn: document.getElementById('registerSaleBtn'),
    clearSaleBtn: document.getElementById('clearSaleBtn'),
    
    // History
    historyTableBody: document.getElementById('historyTableBody'),
    
    // Products
    productNameInput: document.getElementById('productNameInput'),
    productCategoryInput: document.getElementById('productCategoryInput'),
    productPriceInput: document.getElementById('productPriceInput'),
    productCostInput: document.getElementById('productCostInput'),
    productStockInput: document.getElementById('productStockInput'),
    productMinStockInput: document.getElementById('productMinStockInput'),
    saveProductBtn: document.getElementById('saveProductBtn'),
    clearProductBtn: document.getElementById('clearProductBtn'),
    productsTableBody: document.getElementById('productsTableBody'),
    
    // Settings
    businessNameInput: document.getElementById('businessNameInput'),
    businessSloganInput: document.getElementById('businessSloganInput'),
    primaryColorInput: document.getElementById('primaryColorInput'),
    secondaryColorInput: document.getElementById('secondaryColorInput'),
    notificationsToggle: document.getElementById('notificationsToggle'),
    soundsToggle: document.getElementById('soundsToggle'),
    stockAlertsToggle: document.getElementById('stockAlertsToggle'),
    
    // Modals
    confirmModal: document.getElementById('confirmModal'),
    confirmMessage: document.getElementById('confirmMessage'),
    confirmActionBtn: document.getElementById('confirmActionBtn'),
    saleDetailsModal: document.getElementById('saleDetailsModal'),
    saleDetailsContent: document.getElementById('saleDetailsContent'),
    
    // Notifications
    notificationContainer: document.getElementById('notificationContainer'),
    
    // Animation
    saleAnimation: document.getElementById('saleAnimation'),
    
    // Hide Values
    hideValuesBtn: document.getElementById('hideValuesBtn')
};

// Gráficos
let charts = {
    salesChart: null,
    distributionChart: null,
    paymentChart: null,
    monthlyChart: null,
    financeChart: null,
    costsChart: null
};

// Inicialização do aplicativo
async function initApp() {
    loadAppData();
    setupEventListeners();
    setupCharts();
    
    // Verificar se já está logado
    const session = localStorage.getItem(DATA_KEYS.SESSION);
    if (session) {
        const sessionData = JSON.parse(session);
        if (sessionData.expires > Date.now()) {
            appState.currentUser = { username: 'admin', name: 'Administrador' };
            showMainApp();
            updateBusinessInfo();
            loadProducts();
            loadSalesHistory();
            updateCharts();
        } else {
            showLogin();
        }
    } else {
        showLogin();
    }
}

// Carregar dados do LocalStorage
function loadAppData() {
    const savedBusinessInfo = localStorage.getItem(DATA_KEYS.BUSINESS_INFO);
    if (savedBusinessInfo) {
        Object.assign(appState.businessInfo, JSON.parse(savedBusinessInfo));
    }
    
    const savedProducts = localStorage.getItem(DATA_KEYS.PRODUCTS);
    if (savedProducts) {
        appState.products = JSON.parse(savedProducts);
    }
    
    const savedSales = localStorage.getItem(DATA_KEYS.SALES);
    if (savedSales) {
        appState.sales = JSON.parse(savedSales);
    }
    
    const savedSettings = localStorage.getItem(DATA_KEYS.SETTINGS);
    if (savedSettings) {
        Object.assign(appState.settings, JSON.parse(savedSettings));
    }
}

// Salvar dados no LocalStorage
function saveAppData() {
    localStorage.setItem(DATA_KEYS.BUSINESS_INFO, JSON.stringify(appState.businessInfo));
    localStorage.setItem(DATA_KEYS.PRODUCTS, JSON.stringify(appState.products));
    localStorage.setItem(DATA_KEYS.SALES, JSON.stringify(appState.sales));
    localStorage.setItem(DATA_KEYS.SETTINGS, JSON.stringify(appState.settings));
}

// Configurar event listeners
function setupEventListeners() {
    // Login
    dom.loginBtn.addEventListener('click', handleLogin);
    dom.passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleLogin();
    });
    
    // Logout
    dom.logoutBtn.addEventListener('click', handleLogout);
    
    // Tabs
    dom.tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const sectionId = tab.dataset.tab;
            setActiveSection(sectionId);
        });
    });
    
    // Tema
    dom.themeToggle.addEventListener('click', toggleTheme);
    
    // Ocultar valores
    dom.hideValuesToggle.addEventListener('click', toggleHideValues);
    dom.hideValuesBtn.addEventListener('click', toggleHideValues);
    
    // Vendas
    dom.productSelect.addEventListener('change', updatePriceFromProduct);
    dom.addProductBtn.addEventListener('click', addProductToSale);
    dom.registerSaleBtn.addEventListener('click', registerSale);
    dom.clearSaleBtn.addEventListener('click', clearCurrentSale);
    
    // Produtos
    dom.saveProductBtn.addEventListener('click', saveProduct);
    dom.clearProductBtn.addEventListener('click', clearProductForm);
    
    // Configurações
    dom.primaryColorInput.addEventListener('change', updateThemeColors);
    dom.secondaryColorInput.addEventListener('change', updateThemeColors);
}

// Login
function handleLogin() {
    const username = dom.usernameInput.value.trim();
    const password = dom.passwordInput.value;
    
    // Sistema de login simples para demonstração
    if (username && password) {
        appState.currentUser = {
            username: username,
            name: username === 'admin' ? 'Administrador' : 'Vendedor',
            role: username === 'admin' ? 'admin' : 'seller'
        };
        
        // Salvar sessão
        const session = {
            username: username,
            expires: Date.now() + (7 * 24 * 60 * 60 * 1000) // 7 dias
        };
        localStorage.setItem(DATA_KEYS.SESSION, JSON.stringify(session));
        
        showMainApp();
        updateBusinessInfo();
        loadProducts();
        loadSalesHistory();
        updateCharts();
        
        showNotification('Login realizado com sucesso!', 'success');
    } else {
        showNotification('Preencha todos os campos', 'error');
    }
}

// Logout
function handleLogout() {
    showConfirm('Deseja realmente sair do sistema?', () => {
        appState.currentUser = null;
        localStorage.removeItem(DATA_KEYS.SESSION);
        showLogin();
        showNotification('Logout realizado com sucesso', 'info');
    });
}

// Mostrar tela de login
function showLogin() {
    dom.loginScreen.style.display = 'flex';
    dom.mainApp.style.display = 'none';
    
    // Resetar campos
    dom.usernameInput.value = '';
    dom.passwordInput.value = '';
    
    // Atualizar informações da empresa
    updateBusinessInfo();
}

// Mostrar aplicativo principal
function showMainApp() {
    dom.loginScreen.style.display = 'none';
    dom.mainApp.style.display = 'block';
    
    // Aplicar tema
    updateTheme();
    updateHideValues();
    
    // Atualizar botão de ocultar valores
    updateHideValuesButton();
}

// Atualizar informações da empresa
function updateBusinessInfo() {
    // Logo
    if (appState.businessInfo.logo) {
        dom.businessLogo.src = appState.businessInfo.logo;
        dom.businessAvatar.src = appState.businessInfo.logo;
    } else {
        const defaultIcon = "https://cdn-icons-png.flaticon.com/512/2917/2917633.png";
        dom.businessLogo.src = defaultIcon;
        dom.businessAvatar.src = defaultIcon;
    }
    
    // Nome e slogan
    dom.businessNameLogin.textContent = appState.businessInfo.name;
    dom.businessNameHeader.textContent = appState.businessInfo.name;
    dom.businessSlogan.textContent = appState.businessInfo.slogan;
    
    // Configurações
    dom.businessNameInput.value = appState.businessInfo.name;
    dom.businessSloganInput.value = appState.businessInfo.slogan;
    dom.primaryColorInput.value = appState.businessInfo.primaryColor;
    dom.secondaryColorInput.value = appState.businessInfo.secondaryColor;
    
    // Toggles
    dom.notificationsToggle.checked = appState.settings.notifications;
    dom.soundsToggle.checked = appState.settings.sounds;
    dom.stockAlertsToggle.checked = appState.settings.stockAlerts;
    
    // Aplicar cores
    applyThemeColors();
}

// Aplicar cores do tema
function applyThemeColors() {
    const root = document.documentElement;
    root.style.setProperty('--primary', appState.businessInfo.primaryColor);
    root.style.setProperty('--secondary', appState.businessInfo.secondaryColor);
    
    // Atualizar gradiente
    const primaryLight = lightenColor(appState.businessInfo.primaryColor, 20);
    const primaryDark = darkenColor(appState.businessInfo.primaryColor, 10);
    const secondaryLight = lightenColor(appState.businessInfo.secondaryColor, 20);
    
    root.style.setProperty('--primary-gradient', `linear-gradient(135deg, ${appState.businessInfo.primaryColor} 0%, ${primaryLight} 100%)`);
    root.style.setProperty('--primary-light', primaryLight);
    root.style.setProperty('--primary-dark', primaryDark);
    root.style.setProperty('--secondary-light', secondaryLight);
    root.style.setProperty('--text-gradient', `linear-gradient(135deg, ${appState.businessInfo.primaryColor} 0%, ${appState.businessInfo.secondaryColor} 100%)`);
}

// Atualizar cores do tema
function updateThemeColors() {
    appState.businessInfo.primaryColor = dom.primaryColorInput.value;
    appState.businessInfo.secondaryColor = dom.secondaryColorInput.value;
    applyThemeColors();
    saveAppData();
    showNotification('Cores do tema atualizadas', 'success');
}

// Alternar tema claro/escuro
function toggleTheme() {
    appState.settings.darkMode = !appState.settings.darkMode;
    saveAppData();
    updateTheme();
    showNotification(appState.settings.darkMode ? 'Modo escuro ativado' : 'Modo claro ativado', 'info');
}

// Aplicar tema
function updateTheme() {
    if (appState.settings.darkMode) {
        document.documentElement.setAttribute('data-theme', 'dark');
        dom.themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
    } else {
        document.documentElement.removeAttribute('data-theme');
        dom.themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
    }
}

// Alternar ocultar valores
function toggleHideValues() {
    appState.settings.hideValues = !appState.settings.hideValues;
    saveAppData();
    updateHideValues();
    updateHideValuesButton();
    showNotification(appState.settings.hideValues ? 'Valores ocultos' : 'Valores visíveis', 'info');
}

// Atualizar estado dos valores ocultos
function updateHideValues() {
    const elements = document.querySelectorAll('[data-hide-value="true"]');
    elements.forEach(element => {
        if (appState.settings.hideValues) {
            element.dataset.originalValue = element.textContent;
            element.textContent = '•••••';
            element.style.filter = 'blur(5px)';
        } else {
            element.textContent = element.dataset.originalValue || element.textContent;
            element.style.filter = 'none';
        }
    });
    
    // Atualizar overlay de compra
    if (appState.currentSale.total > 0) {
        updatePurchaseOverlay();
    }
}

// Atualizar botão de ocultar valores
function updateHideValuesButton() {
    const icon = appState.settings.hideValues ? 'fa-eye' : 'fa-eye-slash';
    dom.hideValuesToggle.innerHTML = `<i class="fas ${icon}"></i>`;
    dom.hideValuesBtn.innerHTML = `<i class="fas ${icon}"></i>`;
}

// Atualizar overlay de valor da compra
function updatePurchaseOverlay() {
    if (appState.currentSale.total > 0) {
        dom.currentPurchaseValue.textContent = `Valor da compra: ${formatCurrency(appState.currentSale.total)}`;
        dom.purchaseValueOverlay.classList.add('show');
    } else {
        dom.purchaseValueOverlay.classList.remove('show');
    }
}

// Definir seção ativa
function setActiveSection(sectionId) {
    // Atualizar tabs
    dom.tabs.forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === sectionId);
    });
    
    // Atualizar seções
    document.querySelectorAll('.section').forEach(section => {
        section.classList.toggle('active', section.id === sectionId);
    });
    
    appState.settings.currentSection = sectionId;
    saveAppData();
    
    // Executar ações específicas da seção
    switch(sectionId) {
        case 'dashboard':
            updateDashboard();
            break;
        case 'sales':
            loadProducts();
            break;
        case 'history':
            loadSalesHistory();
            break;
        case 'products':
            loadProductsTable();
            break;
        case 'finance':
            updateFinanceCharts();
            break;
    }
}

// ============================================
// SISTEMA DE VENDAS
// ============================================

// Carregar produtos no select
function loadProducts() {
    dom.productSelect.innerHTML = '<option value="">Selecione um produto</option>';
    
    appState.products.forEach(product => {
        const option = document.createElement('option');
        option.value = product.id;
        option.textContent = `${product.name} - ${formatCurrency(product.price)} (Estoque: ${product.stock})`;
        dom.productSelect.appendChild(option);
    });
}

// Atualizar preço ao selecionar produto
function updatePriceFromProduct() {
    const productId = parseInt(dom.productSelect.value);
    if (!productId) return;
    
    const product = appState.products.find(p => p.id === productId);
    if (product) {
        dom.priceInput.value = product.price.toFixed(2);
    }
}

// Adicionar produto à venda
function addProductToSale() {
    const productId = parseInt(dom.productSelect.value);
    const quantity = parseInt(dom.quantityInput.value) || 1;
    const price = parseFloat(dom.priceInput.value) || 0;
    const discount = parseFloat(dom.discountInput.value) || 0;
    
    if (!productId) {
        showNotification('Selecione um produto', 'error');
        return;
    }
    
    if (quantity <= 0) {
        showNotification('Quantidade inválida', 'error');
        return;
    }
    
    if (price <= 0) {
        showNotification('Preço inválido', 'error');
        return;
    }
    
    const product = appState.products.find(p => p.id === productId);
    if (!product) {
        showNotification('Produto não encontrado', 'error');
        return;
    }
    
    // Verificar estoque
    if (product.stock < quantity) {
        showNotification(`Estoque insuficiente! Disponível: ${product.stock}`, 'error');
        return;
    }
    
    // Calcular valores
    const subtotal = price * quantity;
    const finalPrice = subtotal - discount;
    const cost = (product.cost || 0) * quantity;
    const profit = finalPrice - cost;
    
    // Adicionar à venda atual
    const saleProduct = {
        id: Date.now(),
        productId: productId,
        name: product.name,
        quantity: quantity,
        price: price,
        discount: discount,
        subtotal: subtotal,
        finalPrice: finalPrice,
        cost: cost,
        profit: profit
    };
    
    appState.currentSale.products.push(saleProduct);
    updateCurrentSale();
    updateSaleProductsDisplay();
    
    // Resetar campos
    dom.quantityInput.value = '1';
    dom.priceInput.value = '';
    dom.discountInput.value = '0';
    
    showNotification(`${product.name} adicionado à venda`, 'success');
}

// Atualizar venda atual
function updateCurrentSale() {
    // Calcular totais
    appState.currentSale.subtotal = appState.currentSale.products.reduce((sum, p) => sum + p.subtotal, 0);
    appState.currentSale.discount = appState.currentSale.products.reduce((sum, p) => sum + p.discount, 0);
    appState.currentSale.total = appState.currentSale.products.reduce((sum, p) => sum + p.finalPrice, 0);
    
    // Atualizar display
    dom.subtotalValue.textContent = formatCurrency(appState.currentSale.subtotal);
    dom.discountValue.textContent = formatCurrency(appState.currentSale.discount);
    dom.totalValue.textContent = formatCurrency(appState.currentSale.total);
    
    // Atualizar pagamentos
    updatePayments();
    
    // Atualizar overlay
    updatePurchaseOverlay();
    
    // Habilitar/desabilitar botão de finalizar
    dom.registerSaleBtn.disabled = appState.currentSale.products.length === 0;
}

// Atualizar display de produtos na venda
function updateSaleProductsDisplay() {
    const container = dom.productsList;
    
    if (appState.currentSale.products.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-shopping-cart"></i>
                <p>Nenhum produto adicionado à venda</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = '';
    appState.currentSale.products.forEach(product => {
        const item = document.createElement('div');
        item.className = 'product-item';
        item.innerHTML = `
            <div class="product-info">
                <h4>${product.name}</h4>
                <div class="product-details">
                    ${product.quantity} × ${formatCurrency(product.price)} = ${formatCurrency(product.subtotal)}
                    ${product.discount > 0 ? `<br><small>Desconto: -${formatCurrency(product.discount)}</small>` : ''}
                    <br><small>Total: ${formatCurrency(product.finalPrice)}</small>
                </div>
            </div>
            <div style="display: flex; align-items: center;">
                <span class="product-total">${formatCurrency(product.finalPrice)}</span>
                <button onclick="removeProductFromSale(${product.id})" class="remove-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        container.appendChild(item);
    });
}

// Remover produto da venda
function removeProductFromSale(productId) {
    appState.currentSale.products = appState.currentSale.products.filter(p => p.id !== productId);
    updateCurrentSale();
    updateSaleProductsDisplay();
    showNotification('Produto removido da venda', 'info');
}

// Sistema de pagamento múltiplo
let paymentMethodsCount = 1;

function addPaymentMethod() {
    paymentMethodsCount++;
    
    const paymentItem = document.createElement('div');
    paymentItem.className = 'payment-item';
    paymentItem.innerHTML = `
        <div class="payment-header">
            <select class="payment-select" onchange="updatePaymentMethod(${paymentMethodsCount - 1}, this.value)">
                <option value="cash">Dinheiro</option>
                <option value="pix">Pix</option>
                <option value="credit">Cartão Crédito</option>
                <option value="debit">Cartão Débito</option>
            </select>
            <button onclick="removePaymentMethod(${paymentMethodsCount - 1})" class="btn btn-danger btn-sm">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="payment-amount">
            <span>R$</span>
            <input type="number" min="0" step="0.01" placeholder="0,00" 
                   onchange="updatePaymentAmount(${paymentMethodsCount - 1}, this.value)"
                   oninput="updatePaymentAmount(${paymentMethodsCount - 1}, this.value)">
        </div>
    `;
    
    dom.paymentMethodsContainer.appendChild(paymentItem);
    
    // Adicionar ao estado
    appState.currentSale.payments.push({ method: 'cash', amount: 0 });
}

function removePaymentMethod(index) {
    if (appState.currentSale.payments.length <= 1) {
        showNotification('É necessário pelo menos uma forma de pagamento', 'warning');
        return;
    }
    
    // Remover do DOM
    const items = dom.paymentMethodsContainer.querySelectorAll('.payment-item');
    if (items[index]) {
        items[index].remove();
    }
    
    // Remover do estado
    appState.currentSale.payments.splice(index, 1);
    paymentMethodsCount--;
    
    // Reindexar
    updatePayments();
}

function updatePaymentMethod(index, method) {
    if (appState.currentSale.payments[index]) {
        appState.currentSale.payments[index].method = method;
        updatePayments();
    }
}

function updatePaymentAmount(index, amount) {
    if (appState.currentSale.payments[index]) {
        appState.currentSale.payments[index].amount = parseFloat(amount) || 0;
        updatePayments();
    }
}

function updatePayments() {
    const totalPaid = appState.currentSale.payments.reduce((sum, p) => sum + p.amount, 0);
    const remaining = appState.currentSale.total - totalPaid;
    
    dom.paidValue.textContent = formatCurrency(totalPaid);
    
    if (remaining > 0) {
        dom.remainingValue.textContent = `${formatCurrency(remaining)} (Falta)`;
        dom.remainingValue.style.color = 'var(--danger)';
    } else if (remaining < 0) {
        dom.remainingValue.textContent = `${formatCurrency(Math.abs(remaining))} (Troco)`;
        dom.remainingValue.style.color = 'var(--success)';
    } else {
        dom.remainingValue.textContent = formatCurrency(0);
        dom.remainingValue.style.color = 'var(--success)';
    }
    
    // Auto-distribuir valor se apenas um pagamento
    if (appState.currentSale.payments.length === 1 && appState.currentSale.total > 0) {
        const input = dom.paymentMethodsContainer.querySelector('.payment-amount input');
        if (input && parseFloat(input.value) === 0) {
            input.value = appState.currentSale.total.toFixed(2);
            appState.currentSale.payments[0].amount = appState.currentSale.total;
            updatePayments();
        }
    }
}

// Limpar venda atual
function clearCurrentSale() {
    if (appState.currentSale.products.length === 0) return;
    
    showConfirm('Deseja realmente cancelar esta venda?', () => {
        appState.currentSale = {
            products: [],
            subtotal: 0,
            discount: 0,
            total: 0,
            payments: [
                { method: 'cash', amount: 0 }
            ]
        };
        
        // Resetar DOM
        dom.productsList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-shopping-cart"></i>
                <p>Nenhum produto adicionado à venda</p>
            </div>
        `;
        
        dom.paymentMethodsContainer.innerHTML = `
            <div class="payment-item">
                <div class="payment-header">
                    <select class="payment-select" onchange="updatePaymentMethod(0, this.value)">
                        <option value="cash">Dinheiro</option>
                        <option value="pix">Pix</option>
                        <option value="credit">Cartão Crédito</option>
                        <option value="debit">Cartão Débito</option>
                    </select>
                    <button onclick="removePaymentMethod(0)" class="btn btn-danger btn-sm">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="payment-amount">
                    <span>R$</span>
                    <input type="number" min="0" step="0.01" placeholder="0,00" 
                           onchange="updatePaymentAmount(0, this.value)"
                           oninput="updatePaymentAmount(0, this.value)">
                </div>
            </div>
        `;
        
        paymentMethodsCount = 1;
        updateCurrentSale();
        showNotification('Venda cancelada', 'info');
    });
}

// Registrar venda
function registerSale() {
    if (appState.currentSale.products.length === 0) {
        showNotification('Adicione produtos à venda', 'error');
        return;
    }
    
    // Verificar pagamento
    const totalPaid = appState.currentSale.payments.reduce((sum, p) => sum + p.amount, 0);
    if (totalPaid < appState.currentSale.total) {
        showNotification(`Pagamento insuficiente! Falta ${formatCurrency(appState.currentSale.total - totalPaid)}`, 'error');
        return;
    }
    
    // Criar registro da venda
    const sale = {
        id: Date.now(),
        date: new Date().toISOString(),
        products: [...appState.currentSale.products],
        subtotal: appState.currentSale.subtotal,
        discount: appState.currentSale.discount,
        total: appState.currentSale.total,
        payments: [...appState.currentSale.payments],
        cost: appState.currentSale.products.reduce((sum, p) => sum + p.cost, 0),
        profit: appState.currentSale.products.reduce((sum, p) => sum + p.profit, 0)
    };
    
    // Atualizar estoque
    appState.currentSale.products.forEach(saleProduct => {
        const product = appState.products.find(p => p.id === saleProduct.productId);
        if (product) {
            product.stock -= saleProduct.quantity;
            
            // Verificar estoque baixo
            if (appState.settings.stockAlerts && product.stock <= product.minStock) {
                showNotification(`Estoque baixo: ${product.name} (${product.stock} unidades)`, 'warning');
            }
        }
    });
    
    // Adicionar ao histórico
    appState.sales.unshift(sale);
    
    // Limpar venda atual
    appState.currentSale = {
        products: [],
        subtotal: 0,
        discount: 0,
        total: 0,
        payments: [
            { method: 'cash', amount: 0 }
        ]
    };
    
    // Resetar DOM
    dom.productsList.innerHTML = `
        <div class="empty-state">
            <i class="fas fa-shopping-cart"></i>
            <p>Nenhum produto adicionado à venda</p>
        </div>
    `;
    
    paymentMethodsCount = 1;
    updateCurrentSale();
    
    // Salvar dados
    saveAppData();
    
    // Efeitos
    if (appState.settings.sounds) {
        playSaleSound();
    }
    
    if (appState.settings.notifications) {
        showSaleAnimation();
    }
    
    showNotification(`Venda registrada! Total: ${formatCurrency(sale.total)}`, 'success');
    
    // Atualizar dashboards
    updateDashboard();
    updateCharts();
    
    // Limpar automaticamente após sucesso
    setTimeout(() => {
        clearCurrentSale();
    }, 500);
}

// ============================================
// HISTÓRICO DE VENDAS
// ============================================

// Carregar histórico de vendas
function loadSalesHistory() {
    const tbody = dom.historyTableBody;
    tbody.innerHTML = '';
    
    if (appState.sales.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; padding: 3rem;">
                    <div class="empty-state">
                        <i class="fas fa-history"></i>
                        <p>Nenhuma venda registrada</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    // Mostrar apenas as últimas 50 vendas para performance
    const recentSales = appState.sales.slice(0, 50);
    
    recentSales.forEach(sale => {
        const date = new Date(sale.date);
        const formattedDate = date.toLocaleDateString('pt-BR');
        const formattedTime = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        
        const productNames = sale.products.map(p => p.name).join(', ');
        const totalQuantity = sale.products.reduce((sum, p) => sum + p.quantity, 0);
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${formattedDate} ${formattedTime}</td>
            <td>${productNames}</td>
            <td>${totalQuantity}</td>
            <td data-hide-value="true">${formatCurrency(sale.total)}</td>
            <td>${sale.payments.map(p => p.method).join(' + ')}</td>
            <td class="table-actions">
                <button onclick="viewSaleDetails(${sale.id})" class="action-btn edit" title="Ver Detalhes">
                    <i class="fas fa-eye"></i>
                </button>
                <button onclick="deleteSale(${sale.id})" class="action-btn delete" title="Excluir Venda">
                    <i class="fas fa-trash"></i>
                </button>
                <button onclick="downloadSaleReceipt(${sale.id})" class="action-btn download" title="Baixar Recibo">
                    <i class="fas fa-download"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Atualizar valores ocultos
    updateHideValues();
}

// Ver detalhes da venda
function viewSaleDetails(saleId) {
    const sale = appState.sales.find(s => s.id === saleId);
    if (!sale) {
        showNotification('Venda não encontrada', 'error');
        return;
    }
    
    const date = new Date(sale.date);
    const formattedDate = date.toLocaleDateString('pt-BR');
    const formattedTime = date.toLocaleTimeString('pt-BR');
    
    let productsHtml = '';
    sale.products.forEach(product => {
        productsHtml += `
            <div style="padding: 10px; border-bottom: 1px solid var(--gray-200);">
                <div style="display: flex; justify-content: space-between;">
                    <strong>${product.name}</strong>
                    <span>${formatCurrency(product.finalPrice)}</span>
                </div>
                <div style="font-size: 0.9rem; color: var(--gray-600);">
                    ${product.quantity} × ${formatCurrency(product.price)} = ${formatCurrency(product.subtotal)}
                    ${product.discount > 0 ? ` - ${formatCurrency(product.discount)}` : ''}
                </div>
            </div>
        `;
    });
    
    let paymentsHtml = '';
    sale.payments.forEach(payment => {
        paymentsHtml += `
            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                <span>${getPaymentMethodName(payment.method)}</span>
                <span>${formatCurrency(payment.amount)}</span>
            </div>
        `;
    });
    
    dom.saleDetailsContent.innerHTML = `
        <div style="margin-bottom: 2rem;">
            <h4 style="color: var(--gray-700); margin-bottom: 1rem;">Venda #${sale.id}</h4>
            <p><strong>Data:</strong> ${formattedDate} às ${formattedTime}</p>
            <p><strong>Vendedor:</strong> ${appState.currentUser?.name || 'Não informado'}</p>
        </div>
        
        <div style="margin-bottom: 2rem;">
            <h4 style="color: var(--gray-700); margin-bottom: 1rem;">Produtos</h4>
            ${productsHtml}
        </div>
        
        <div style="margin-bottom: 2rem;">
            <h4 style="color: var(--gray-700); margin-bottom: 1rem;">Pagamento</h4>
            ${paymentsHtml}
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-top: 2px solid var(--gray-300); margin-top: 10px;">
                <strong>Total</strong>
                <strong>${formatCurrency(sale.total)}</strong>
            </div>
        </div>
        
        <div style="background: var(--gray-50); padding: 1rem; border-radius: var(--border-radius-xs);">
            <p><strong>Subtotal:</strong> ${formatCurrency(sale.subtotal)}</p>
            <p><strong>Descontos:</strong> ${formatCurrency(sale.discount)}</p>
            <p><strong>Custo Total:</strong> ${formatCurrency(sale.cost)}</p>
            <p><strong>Lucro:</strong> ${formatCurrency(sale.profit)}</p>
        </div>
    `;
    
    showModal('saleDetailsModal');
}

// Excluir venda
function deleteSale(saleId) {
    showConfirm('Deseja realmente excluir esta venda? Esta ação não pode ser desfeita.', () => {
        const saleIndex = appState.sales.findIndex(s => s.id === saleId);
        if (saleIndex !== -1) {
            // Restaurar estoque dos produtos
            const sale = appState.sales[saleIndex];
            sale.products.forEach(saleProduct => {
                const product = appState.products.find(p => p.id === saleProduct.productId);
                if (product) {
                    product.stock += saleProduct.quantity;
                }
            });
            
            // Remover venda
            appState.sales.splice(saleIndex, 1);
            saveAppData();
            loadSalesHistory();
            updateDashboard();
            updateCharts();
            
            showNotification('Venda excluída com sucesso', 'success');
        }
    });
}

// Baixar recibo da venda
function downloadSaleReceipt(saleId) {
    const sale = appState.sales.find(s => s.id === saleId);
    if (!sale) {
        showNotification('Venda não encontrada', 'error');
        return;
    }
    
    const date = new Date(sale.date);
    const formattedDate = date.toLocaleDateString('pt-BR');
    const formattedTime = date.toLocaleTimeString('pt-BR');
    
    let receipt = `
        RECIBO DE VENDA
        ====================
        
        Empresa: ${appState.businessInfo.name}
        Data: ${formattedDate} ${formattedTime}
        Vendedor: ${appState.currentUser?.name || 'Não informado'}
        
        PRODUTOS:
        ${sale.products.map(p => `${p.quantity}x ${p.name} - ${formatCurrency(p.finalPrice)}`).join('\n')}
        
        RESUMO:
        Subtotal: ${formatCurrency(sale.subtotal)}
        Descontos: ${formatCurrency(sale.discount)}
        Total: ${formatCurrency(sale.total)}
        
        PAGAMENTO:
        ${sale.payments.map(p => `${getPaymentMethodName(p.method)}: ${formatCurrency(p.amount)}`).join('\n')}
        
        Obrigado pela preferência!
        ====================
    `;
    
    downloadTextFile(receipt, `recibo-venda-${saleId}.txt`);
    showNotification('Recibo baixado com sucesso', 'success');
}

// Exportar histórico em PDF
function exportHistoryPDF() {
    if (appState.sales.length === 0) {
        showNotification('Nenhuma venda para exportar', 'warning');
        return;
    }
    
    // Usar html2canvas e jsPDF para gerar PDF
    const table = document.getElementById('historyTable');
    html2canvas(table).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        const imgWidth = 190;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        
        pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
        pdf.save(`historico-vendas-${new Date().toISOString().split('T')[0]}.pdf`);
        showNotification('PDF gerado com sucesso', 'success');
    }).catch(error => {
        console.error('Erro ao gerar PDF:', error);
        showNotification('Erro ao gerar PDF', 'error');
    });
}

// Limpar histórico
function clearHistory() {
    showConfirm('Deseja realmente limpar todo o histórico de vendas? Esta ação não pode ser desfeita.', () => {
        appState.sales = [];
        saveAppData();
        loadSalesHistory();
        updateDashboard();
        updateCharts();
        showNotification('Histórico limpo com sucesso', 'success');
    });
}

// ============================================
// GERENCIAMENTO DE PRODUTOS
// ============================================

// Carregar tabela de produtos
function loadProductsTable() {
    const tbody = dom.productsTableBody;
    tbody.innerHTML = '';
    
    if (appState.products.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 3rem;">
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <p>Nenhum produto cadastrado</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    appState.products.forEach(product => {
        const profit = product.price - (product.cost || 0);
        const profitMargin = product.price > 0 ? (profit / product.price) * 100 : 0;
        const stockStatus = product.stock <= product.minStock ? 'stock-low' : '';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${product.name}</strong></td>
            <td>${getCategoryName(product.category)}</td>
            <td data-hide-value="true">${formatCurrency(product.price)}</td>
            <td data-hide-value="true">${formatCurrency(product.cost || 0)}</td>
            <td class="${stockStatus}">${product.stock}</td>
            <td data-hide-value="true">${formatCurrency(profit)} (${profitMargin.toFixed(1)}%)</td>
            <td class="table-actions">
                <button onclick="editProduct(${product.id})" class="action-btn edit" title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteProduct(${product.id})" class="action-btn delete" title="Excluir">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    updateHideValues();
}

// Salvar produto
function saveProduct() {
    const name = dom.productNameInput.value.trim();
    const category = dom.productCategoryInput.value;
    const price = parseFloat(dom.productPriceInput.value) || 0;
    const cost = parseFloat(dom.productCostInput.value) || 0;
    const stock = parseInt(dom.productStockInput.value) || 0;
    const minStock = parseInt(dom.productMinStockInput.value) || 5;
    
    if (!name) {
        showNotification('Digite o nome do produto', 'error');
        return;
    }
    
    if (price <= 0) {
        showNotification('Preço inválido', 'error');
        return;
    }
    
    if (cost < 0) {
        showNotification('Custo inválido', 'error');
        return;
    }
    
    if (stock < 0) {
        showNotification('Estoque inválido', 'error');
        return;
    }
    
    // Verificar se está editando
    const editId = dom.saveProductBtn.dataset.editId;
    
    if (editId) {
        // Editar produto existente
        const productIndex = appState.products.findIndex(p => p.id === parseInt(editId));
        if (productIndex !== -1) {
            appState.products[productIndex] = {
                ...appState.products[productIndex],
                name,
                category,
                price,
                cost,
                stock,
                minStock,
                updatedAt: new Date().toISOString()
            };
        }
        
        delete dom.saveProductBtn.dataset.editId;
        dom.saveProductBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Produto';
    } else {
        // Novo produto
        const newProduct = {
            id: Date.now(),
            name,
            category,
            price,
            cost,
            stock,
            minStock,
            createdAt: new Date().toISOString()
        };
        
        appState.products.push(newProduct);
    }
    
    saveAppData();
    loadProducts();
    loadProductsTable();
    clearProductForm();
    
    showNotification(editId ? 'Produto atualizado' : 'Produto cadastrado', 'success');
}

// Editar produto
function editProduct(productId) {
    const product = appState.products.find(p => p.id === productId);
    if (!product) return;
    
    dom.productNameInput.value = product.name;
    dom.productCategoryInput.value = product.category;
    dom.productPriceInput.value = product.price;
    dom.productCostInput.value = product.cost || 0;
    dom.productStockInput.value = product.stock;
    dom.productMinStockInput.value = product.minStock;
    
    dom.saveProductBtn.dataset.editId = productId;
    dom.saveProductBtn.innerHTML = '<i class="fas fa-save"></i> Atualizar Produto';
    
    // Scroll para o formulário
    document.getElementById('sales').scrollIntoView({ behavior: 'smooth' });
}

// Excluir produto
function deleteProduct(productId) {
    showConfirm('Deseja realmente excluir este produto?', () => {
        const productIndex = appState.products.findIndex(p => p.id === productId);
        if (productIndex !== -1) {
            // Verificar se o produto tem vendas
            const hasSales = appState.sales.some(sale => 
                sale.products.some(p => p.productId === productId)
            );
            
            if (hasSales) {
                showNotification('Este produto tem vendas registradas e não pode ser excluído', 'error');
                return;
            }
            
            appState.products.splice(productIndex, 1);
            saveAppData();
            loadProducts();
            loadProductsTable();
            showNotification('Produto excluído', 'success');
        }
    });
}

// Limpar formulário de produto
function clearProductForm() {
    dom.productNameInput.value = '';
    dom.productCategoryInput.value = 'bebidas';
    dom.productPriceInput.value = '';
    dom.productCostInput.value = '';
    dom.productStockInput.value = '0';
    dom.productMinStockInput.value = '5';
    
    delete dom.saveProductBtn.dataset.editId;
    dom.saveProductBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Produto';
}

// ============================================
// SISTEMA FINANCEIRO E GRÁFICOS
// ============================================

// Configurar gráficos
function setupCharts() {
    // Gráfico de vendas
    const salesCtx = document.getElementById('salesChart').getContext('2d');
    charts.salesChart = new Chart(salesCtx, {
        type: 'line',
        data: {
            labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'],
            datasets: [{
                label: 'Vendas (R$)',
                data: [850, 920, 1050, 980, 1200, 1450, 1300],
                borderColor: appState.businessInfo.primaryColor,
                backgroundColor: `${appState.businessInfo.primaryColor}20`,
                borderWidth: 3,
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value;
                        }
                    }
                }
            }
        }
    });
    
    // Gráfico de distribuição
    const distributionCtx = document.getElementById('distributionChart').getContext('2d');
    charts.distributionChart = new Chart(distributionCtx, {
        type: 'doughnut',
        data: {
            labels: ['Bebidas', 'Comidas', 'Sobremesas', 'Acessórios'],
            datasets: [{
                data: [45, 30, 15, 10],
                backgroundColor: [
                    appState.businessInfo.primaryColor,
                    appState.businessInfo.secondaryColor,
                    lightenColor(appState.businessInfo.primaryColor, 30),
                    lightenColor(appState.businessInfo.secondaryColor, 30)
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
    
    // Gráfico de pagamentos
    const paymentCtx = document.getElementById('paymentChart').getContext('2d');
    charts.paymentChart = new Chart(paymentCtx, {
        type: 'bar',
        data: {
            labels: ['Dinheiro', 'Pix', 'Cartão'],
            datasets: [{
                label: 'Utilização',
                data: [40, 35, 25],
                backgroundColor: [
                    appState.businessInfo.primaryColor,
                    appState.businessInfo.secondaryColor,
                    lightenColor(appState.businessInfo.primaryColor, 20)
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
}

// Atualizar gráficos
function updateCharts() {
    if (!charts.salesChart) return;
    
    // Atualizar dados reais
    const last7Days = getLast7DaysSales();
    charts.salesChart.data.datasets[0].data = last7Days;
    charts.salesChart.update();
    
    // Atualizar distribuição
    const distribution = getSalesDistribution();
    charts.distributionChart.data.datasets[0].data = distribution;
    charts.distributionChart.update();
    
    // Atualizar pagamentos
    const payments = getPaymentDistribution();
    charts.paymentChart.data.datasets[0].data = payments;
    charts.paymentChart.update();
}

// Atualizar dashboard
function updateDashboard() {
    // Calcular métricas
    const today = new Date().toISOString().split('T')[0];
    const todaySales = appState.sales.filter(sale => 
        sale.date.startsWith(today)
    );
    
    const todayTotal = todaySales.reduce((sum, sale) => sum + sale.total, 0);
    const todayProfit = todaySales.reduce((sum, sale) => sum + sale.profit, 0);
    
    // Atualizar cards (simplificado para exemplo)
    document.querySelectorAll('.card-value')[0].textContent = formatCurrency(todayTotal);
    document.querySelectorAll('.card-value')[1].textContent = formatCurrency(todayProfit);
    
    // Atualizar valores ocultos
    updateHideValues();
}

// Atualizar gráficos financeiros
function updateFinanceCharts() {
    // Criar gráfico financeiro se não existir
    if (!charts.financeChart) {
        const financeCtx = document.getElementById('financeChart').getContext('2d');
        charts.financeChart = new Chart(financeCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                datasets: [
                    {
                        label: 'Faturamento',
                        data: [25820, 28910, 31250, 29500, 32410, 35820],
                        borderColor: appState.businessInfo.primaryColor,
                        backgroundColor: `${appState.businessInfo.primaryColor}20`,
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Lucro',
                        data: [12910, 14455, 15625, 14750, 16205, 17910],
                        borderColor: appState.businessInfo.secondaryColor,
                        backgroundColor: `${appState.businessInfo.secondaryColor}20`,
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value;
                            }
                        }
                    }
                }
            }
        });
    }
    
    if (!charts.costsChart) {
        const costsCtx = document.getElementById('costsChart').getContext('2d');
        charts.costsChart = new Chart(costsCtx, {
            type: 'bar',
            data: {
                labels: ['Produtos', 'Taxas', 'Transporte', 'Outros'],
                datasets: [{
                    label: 'Custos (R$)',
                    data: [18328, 4582, 2291, 4582],
                    backgroundColor: [
                        appState.businessInfo.primaryColor,
                        appState.businessInfo.secondaryColor,
                        lightenColor(appState.businessInfo.primaryColor, 30),
                        lightenColor(appState.businessInfo.secondaryColor, 30)
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value;
                            }
                        }
                    }
                }
            }
        });
    }
}

// ============================================
// FUNÇÕES UTILITÁRIAS
// ============================================

// Formatar moeda
function formatCurrency(value) {
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(value);
}

// Mostrar notificação
function showNotification(message, type = 'info') {
    if (!appState.settings.notifications) return;
    
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    
    const icons = {
        success: 'fa-check-circle',
        error: 'fa-times-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
    };
    
    notification.innerHTML = `
        <div class="notification-icon">
            <i class="fas ${icons[type] || 'fa-info-circle'}"></i>
        </div>
        <div class="notification-content">
            <div class="notification-title">${type.toUpperCase()}</div>
            <div class="notification-message">${message}</div>
        </div>
    `;
    
    dom.notificationContainer.appendChild(notification);
    
    // Mostrar
    setTimeout(() => notification.classList.add('show'), 10);
    
    // Remover após 5 segundos
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 400);
    }, 5000);
}

// Mostrar modal de confirmação
function showConfirm(message, callback) {
    dom.confirmMessage.textContent = message;
    appState.pendingAction = callback;
    showModal('confirmModal');
}

// Confirmar ação
function confirmAction() {
    if (appState.pendingAction) {
        appState.pendingAction();
        appState.pendingAction = null;
    }
    hideModal('confirmModal');
}

// Mostrar modal
function showModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

// Ocultar modal
function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('active');
    document.body.style.overflow = '';
}

// Tocar som de venda
function playSaleSound() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
    } catch (e) {
        // Audio não suportado
    }
}

// Mostrar animação de venda
function showSaleAnimation() {
    dom.saleAnimation.classList.add('show');
    setTimeout(() => {
        dom.saleAnimation.classList.remove('show');
    }, 1000);
}

// Obter nome do método de pagamento
function getPaymentMethodName(method) {
    const methods = {
        cash: 'Dinheiro',
        pix: 'Pix',
        credit: 'Cartão Crédito',
        debit: 'Cartão Débito'
    };
    return methods[method] || method;
}

// Obter nome da categoria
function getCategoryName(category) {
    const categories = {
        bebidas: 'Bebidas',
        comidas: 'Comidas',
        sobremesas: 'Sobremesas',
        acessorios: 'Acessórios',
        outros: 'Outros'
    };
    return categories[category] || category;
}

// Clariar cor
function lightenColor(color, percent) {
    const num = parseInt(color.replace('#', ''), 16);
    const amt = Math.round(2.55 * percent);
    const R = (num >> 16) + amt;
    const G = (num >> 8 & 0x00FF) + amt;
    const B = (num & 0x0000FF) + amt;
    
    return '#' + (
        0x1000000 +
        (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
        (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
        (B < 255 ? B < 1 ? 0 : B : 255)
    ).toString(16).slice(1);
}

// Escurecer cor
function darkenColor(color, percent) {
    const num = parseInt(color.replace('#', ''), 16);
    const amt = Math.round(2.55 * percent);
    const R = (num >> 16) - amt;
    const G = (num >> 8 & 0x00FF) - amt;
    const B = (num & 0x0000FF) - amt;
    
    return '#' + (
        0x1000000 +
        (R > 0 ? R : 0) * 0x10000 +
        (G > 0 ? G : 0) * 0x100 +
        (B > 0 ? B : 0)
    ).toString(16).slice(1);
}

// Baixar arquivo de texto
function downloadTextFile(content, filename) {
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Exportar backup
function exportBackup() {
    const backup = {
        appState: appState,
        exportDate: new Date().toISOString(),
        version: '1.0.0'
    };
    
    const backupStr = JSON.stringify(backup, null, 2);
    downloadTextFile(backupStr, `praiavendas-backup-${new Date().toISOString().split('T')[0]}.json`);
    showNotification('Backup exportado com sucesso', 'success');
}

// Importar backup
function importBackup() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const backup = JSON.parse(event.target.result);
                
                showConfirm('Deseja restaurar este backup? Todos os dados atuais serão substituídos.', () => {
                    Object.assign(appState, backup.appState);
                    saveAppData();
                    location.reload();
                });
            } catch (err) {
                showNotification('Erro ao ler arquivo de backup', 'error');
            }
        };
        reader.readAsText(file);
    };
    
    input.click();
}

// Salvar configurações
function saveSettings() {
    appState.businessInfo.name = dom.businessNameInput.value.trim() || appState.businessInfo.name;
    appState.businessInfo.slogan = dom.businessSloganInput.value.trim() || appState.businessInfo.slogan;
    
    appState.settings.notifications = dom.notificationsToggle.checked;
    appState.settings.sounds = dom.soundsToggle.checked;
    appState.settings.stockAlerts = dom.stockAlertsToggle.checked;
    
    saveAppData();
    updateBusinessInfo();
    showNotification('Configurações salvas com sucesso', 'success');
}

// Obter vendas dos últimos 7 dias
function getLast7DaysSales() {
    const salesByDay = [0, 0, 0, 0, 0, 0, 0];
    const today = new Date();
    
    for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        
        const daySales = appState.sales.filter(sale => 
            sale.date.startsWith(dateStr)
        );
        
        salesByDay[6 - i] = daySales.reduce((sum, sale) => sum + sale.total, 0);
    }
    
    return salesByDay;
}

// Obter distribuição de vendas
function getSalesDistribution() {
    const categories = {
        bebidas: 0,
        comidas: 0,
        sobremesas: 0,
        acessorios: 0,
        outros: 0
    };
    
    appState.sales.forEach(sale => {
        sale.products.forEach(productSale => {
            const product = appState.products.find(p => p.id === productSale.productId);
            if (product) {
                categories[product.category] = (categories[product.category] || 0) + productSale.finalPrice;
            }
        });
    });
    
    return [
        categories.bebidas || 0,
        categories.comidas || 0,
        categories.sobremesas || 0,
        categories.acessorios || 0
    ];
}

// Obter distribuição de pagamentos
function getPaymentDistribution() {
    const methods = {
        cash: 0,
        pix: 0,
        credit: 0,
        debit: 0
    };
    
    appState.sales.forEach(sale => {
        sale.payments.forEach(payment => {
            methods[payment.method] = (methods[payment.method] || 0) + payment.amount;
        });
    });
    
    const total = Object.values(methods).reduce((a, b) => a + b, 0);
    if (total === 0) return [0, 0, 0];
    
    return [
        (methods.cash / total) * 100,
        ((methods.pix || 0) / total) * 100,
        (((methods.credit || 0) + (methods.debit || 0)) / total) * 100
    ];
}

// Imprimir detalhes da venda
function printSaleDetails() {
    const printContent = dom.saleDetailsContent.innerHTML;
    const originalContent = document.body.innerHTML;
    
    document.body.innerHTML = `
        <div style="padding: 20px; font-family: Arial, sans-serif;">
            <h1 style="text-align: center; color: #333;">${appState.businessInfo.name}</h1>
            <div style="margin-top: 30px;">
                ${printContent}
            </div>
            <div style="margin-top: 40px; text-align: center; color: #666; font-size: 12px;">
                Emitido em: ${new Date().toLocaleString('pt-BR')}
            </div>
        </div>
    `;
    
    window.print();
    document.body.innerHTML = originalContent;
    location.reload();
}

// Inicializar aplicativo quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>

